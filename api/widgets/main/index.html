
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Cryo-ET image analysis tool for cylindric periodic structures such as microtubules.">
      
      
      
      
        <link rel="prev" href="../../plugin/">
      
      
        <link rel="next" href="../sta/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>cylindra.widgets.main.CylindraMainWidget - Cylindra</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="lime" data-md-color-accent="light-green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cylindrawidgetsmaincylindramainwidget" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Cylindra" class="md-header__button md-logo" aria-label="Cylindra" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cylindra
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cylindra.widgets.main.CylindraMainWidget
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="lime" data-md-color-accent="light-green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="lime" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hanjinliu/cylindra" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cylindra
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Cylindra" class="md-nav__button md-logo" aria-label="Cylindra" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Cylindra
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hanjinliu/cylindra" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cylindra
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../open_image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Start Cylindra
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fit_splines/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fit Splines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lattice_params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Measure Lattice Parameters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../inspect_results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inspect CFT Results
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../project_io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Load &amp; Save Projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../workflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom Workflows
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../plugins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Plugin System
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../spline/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Spline
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            Spline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../spline/clip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Clip and Invert Splines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../spline/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spline Configurations
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../molecules/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Molecules
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            Molecules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/spline_to_molecules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spline to Molecules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Molecule Features
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/expressions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The "Expressions"
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/split_and_combine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Split &amp; Combine Molecules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/filter_molecules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Filter Molecules by Features
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transform Molecules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../molecules/headers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Feature Names
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../alignment/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Alignment
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            Alignment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../alignment/conventional/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conventional Methods in Cryo-ET Studies
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../alignment/landscape/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build Correlation Landscapes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../alignment/viterbi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Viterbi Alignment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../alignment/rma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Restricted Mesh Annealing (RMA)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_11" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../batch/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Working with Many Projects
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_11" id="__nav_4_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_11">
            <span class="md-nav__icon md-icon"></span>
            Working with Many Projects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../batch/collect_projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Collect projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../batch/construct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Construct Batch Loaders
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../batch/average/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Average Across Projects
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_12" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../extern/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Working with External Softwares
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_12" id="__nav_4_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_12">
            <span class="md-nav__icon md-icon"></span>
            Working with External Softwares
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extern/imod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IMOD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extern/relion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RELION
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../process_images/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Process Images
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../simulate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulate Tomograms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_16" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../case_studies/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Case Studies
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_16" id="__nav_4_16_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_16">
            <span class="md-nav__icon md-icon"></span>
            Case Studies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../case_studies/seam_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microtubule Seam-search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../case_studies/ssta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Segmented Subtomogram Averaging (SSTA)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../case_studies/make_figure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microtubule for Figures
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    API References
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.project
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cylmeasure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.cylmeasure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cylfilters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.cylfilters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plugin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.plugin
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" checked>
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Widgets
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Widgets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    cylindra.widgets.main.CylindraMainWidget
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.main.CylindraMainWidget
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget" class="md-nav__link">
    <span class="md-ellipsis">
      CylindraMainWidget
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.batch" class="md-nav__link">
    <span class="md-ellipsis">
      batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.default_config" class="md-nav__link">
    <span class="md-ellipsis">
      default_config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.splines" class="md-nav__link">
    <span class="md-ellipsis">
      splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.sub_viewer" class="md-nav__link">
    <span class="md-ellipsis">
      sub_viewer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.tomogram" class="md-nav__link">
    <span class="md-ellipsis">
      tomogram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.add_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      add_anchors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.add_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      add_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.add_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      add_multiscale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.align_to_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      align_to_polarity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.binarize_feature" class="md-nav__link">
    <span class="md-ellipsis">
      binarize_feature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.calculate_lattice_structure" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_lattice_structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.calculate_molecule_features" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_molecule_features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.clear_all" class="md-nav__link">
    <span class="md-ellipsis">
      clear_all
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.clear_current" class="md-nav__link">
    <span class="md-ellipsis">
      clear_current
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.clip_spline" class="md-nav__link">
    <span class="md-ellipsis">
      clip_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.concatenate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      concatenate_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.convolve_feature" class="md-nav__link">
    <span class="md-ellipsis">
      convolve_feature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.copy_molecules_features" class="md-nav__link">
    <span class="md-ellipsis">
      copy_molecules_features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.copy_spline" class="md-nav__link">
    <span class="md-ellipsis">
      copy_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.copy_spline_new_config" class="md-nav__link">
    <span class="md-ellipsis">
      copy_spline_new_config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.count_neighbors" class="md-nav__link">
    <span class="md-ellipsis">
      count_neighbors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.delete_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      delete_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.delete_spline" class="md-nav__link">
    <span class="md-ellipsis">
      delete_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.distance_from_spline" class="md-nav__link">
    <span class="md-ellipsis">
      distance_from_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.drop_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      drop_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.filter_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      filter_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.filter_reference_image" class="md-nav__link">
    <span class="md-ellipsis">
      filter_reference_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.fit_splines" class="md-nav__link">
    <span class="md-ellipsis">
      fit_splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.fit_splines_by_centroid" class="md-nav__link">
    <span class="md-ellipsis">
      fit_splines_by_centroid
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.get_loader" class="md-nav__link">
    <span class="md-ellipsis">
      get_loader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.global_cft_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      global_cft_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.infer_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      infer_polarity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.interpolate_spline_properties" class="md-nav__link">
    <span class="md-ellipsis">
      interpolate_spline_properties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.invert_image" class="md-nav__link">
    <span class="md-ellipsis">
      invert_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.invert_spline" class="md-nav__link">
    <span class="md-ellipsis">
      invert_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.label_feature_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      label_feature_clusters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      load_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_project" class="md-nav__link">
    <span class="md-ellipsis">
      load_project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_project_for_reanalysis" class="md-nav__link">
    <span class="md-ellipsis">
      load_project_for_reanalysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_splines" class="md-nav__link">
    <span class="md-ellipsis">
      load_splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.local_cft_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      local_cft_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_along_pf" class="md-nav__link">
    <span class="md-ellipsis">
      map_along_pf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_along_spline" class="md-nav__link">
    <span class="md-ellipsis">
      map_along_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_monomers" class="md-nav__link">
    <span class="md-ellipsis">
      map_monomers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_monomers_with_extensions" class="md-nav__link">
    <span class="md-ellipsis">
      map_monomers_with_extensions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.measure_local_radius" class="md-nav__link">
    <span class="md-ellipsis">
      measure_local_radius
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.measure_radius" class="md-nav__link">
    <span class="md-ellipsis">
      measure_radius
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.measure_radius_by_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      measure_radius_by_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.merge_molecule_info" class="md-nav__link">
    <span class="md-ellipsis">
      merge_molecule_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.molecules_to_spline" class="md-nav__link">
    <span class="md-ellipsis">
      molecules_to_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.open_image" class="md-nav__link">
    <span class="md-ellipsis">
      open_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.open_label_image" class="md-nav__link">
    <span class="md-ellipsis">
      open_label_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.open_reference_image" class="md-nav__link">
    <span class="md-ellipsis">
      open_reference_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.overwrite_project" class="md-nav__link">
    <span class="md-ellipsis">
      overwrite_project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.paint_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      paint_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.protofilaments_to_spline" class="md-nav__link">
    <span class="md-ellipsis">
      protofilaments_to_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.reanalyze_image" class="md-nav__link">
    <span class="md-ellipsis">
      reanalyze_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.reanalyze_image_config_updated" class="md-nav__link">
    <span class="md-ellipsis">
      reanalyze_image_config_updated
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.refine_splines" class="md-nav__link">
    <span class="md-ellipsis">
      refine_splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.regionprops_features" class="md-nav__link">
    <span class="md-ellipsis">
      regionprops_features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.register_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      register_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.register_path" class="md-nav__link">
    <span class="md-ellipsis">
      register_path
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.rename_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      rename_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.rotate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      rotate_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.run_workflow" class="md-nav__link">
    <span class="md-ellipsis">
      run_workflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.sample_subtomograms" class="md-nav__link">
    <span class="md-ellipsis">
      sample_subtomograms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.save_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      save_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.save_project" class="md-nav__link">
    <span class="md-ellipsis">
      save_project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.save_spline" class="md-nav__link">
    <span class="md-ellipsis">
      save_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      set_multiscale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_radius" class="md-nav__link">
    <span class="md-ellipsis">
      set_radius
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_source_spline" class="md-nav__link">
    <span class="md-ellipsis">
      set_source_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_spline_props" class="md-nav__link">
    <span class="md-ellipsis">
      set_spline_props
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.split_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      split_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.translate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      translate_molecules
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.sta.SubtomogramAveraging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../subwidgets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.subwidgets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../batch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.batch
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Builtin Plugins
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Builtin Plugins
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../builtins/imod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra_builtins.imod
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../builtins/relion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra_builtins.relion
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget" class="md-nav__link">
    <span class="md-ellipsis">
      CylindraMainWidget
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.batch" class="md-nav__link">
    <span class="md-ellipsis">
      batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.default_config" class="md-nav__link">
    <span class="md-ellipsis">
      default_config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.splines" class="md-nav__link">
    <span class="md-ellipsis">
      splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.sub_viewer" class="md-nav__link">
    <span class="md-ellipsis">
      sub_viewer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.tomogram" class="md-nav__link">
    <span class="md-ellipsis">
      tomogram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.add_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      add_anchors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.add_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      add_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.add_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      add_multiscale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.align_to_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      align_to_polarity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.binarize_feature" class="md-nav__link">
    <span class="md-ellipsis">
      binarize_feature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.calculate_lattice_structure" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_lattice_structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.calculate_molecule_features" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_molecule_features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.clear_all" class="md-nav__link">
    <span class="md-ellipsis">
      clear_all
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.clear_current" class="md-nav__link">
    <span class="md-ellipsis">
      clear_current
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.clip_spline" class="md-nav__link">
    <span class="md-ellipsis">
      clip_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.concatenate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      concatenate_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.convolve_feature" class="md-nav__link">
    <span class="md-ellipsis">
      convolve_feature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.copy_molecules_features" class="md-nav__link">
    <span class="md-ellipsis">
      copy_molecules_features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.copy_spline" class="md-nav__link">
    <span class="md-ellipsis">
      copy_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.copy_spline_new_config" class="md-nav__link">
    <span class="md-ellipsis">
      copy_spline_new_config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.count_neighbors" class="md-nav__link">
    <span class="md-ellipsis">
      count_neighbors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.delete_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      delete_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.delete_spline" class="md-nav__link">
    <span class="md-ellipsis">
      delete_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.distance_from_spline" class="md-nav__link">
    <span class="md-ellipsis">
      distance_from_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.drop_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      drop_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.filter_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      filter_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.filter_reference_image" class="md-nav__link">
    <span class="md-ellipsis">
      filter_reference_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.fit_splines" class="md-nav__link">
    <span class="md-ellipsis">
      fit_splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.fit_splines_by_centroid" class="md-nav__link">
    <span class="md-ellipsis">
      fit_splines_by_centroid
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.get_loader" class="md-nav__link">
    <span class="md-ellipsis">
      get_loader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.global_cft_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      global_cft_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.infer_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      infer_polarity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.interpolate_spline_properties" class="md-nav__link">
    <span class="md-ellipsis">
      interpolate_spline_properties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.invert_image" class="md-nav__link">
    <span class="md-ellipsis">
      invert_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.invert_spline" class="md-nav__link">
    <span class="md-ellipsis">
      invert_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.label_feature_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      label_feature_clusters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      load_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_project" class="md-nav__link">
    <span class="md-ellipsis">
      load_project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_project_for_reanalysis" class="md-nav__link">
    <span class="md-ellipsis">
      load_project_for_reanalysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.load_splines" class="md-nav__link">
    <span class="md-ellipsis">
      load_splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.local_cft_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      local_cft_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_along_pf" class="md-nav__link">
    <span class="md-ellipsis">
      map_along_pf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_along_spline" class="md-nav__link">
    <span class="md-ellipsis">
      map_along_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_monomers" class="md-nav__link">
    <span class="md-ellipsis">
      map_monomers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.map_monomers_with_extensions" class="md-nav__link">
    <span class="md-ellipsis">
      map_monomers_with_extensions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.measure_local_radius" class="md-nav__link">
    <span class="md-ellipsis">
      measure_local_radius
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.measure_radius" class="md-nav__link">
    <span class="md-ellipsis">
      measure_radius
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.measure_radius_by_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      measure_radius_by_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.merge_molecule_info" class="md-nav__link">
    <span class="md-ellipsis">
      merge_molecule_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.molecules_to_spline" class="md-nav__link">
    <span class="md-ellipsis">
      molecules_to_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.open_image" class="md-nav__link">
    <span class="md-ellipsis">
      open_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.open_label_image" class="md-nav__link">
    <span class="md-ellipsis">
      open_label_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.open_reference_image" class="md-nav__link">
    <span class="md-ellipsis">
      open_reference_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.overwrite_project" class="md-nav__link">
    <span class="md-ellipsis">
      overwrite_project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.paint_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      paint_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.protofilaments_to_spline" class="md-nav__link">
    <span class="md-ellipsis">
      protofilaments_to_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.reanalyze_image" class="md-nav__link">
    <span class="md-ellipsis">
      reanalyze_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.reanalyze_image_config_updated" class="md-nav__link">
    <span class="md-ellipsis">
      reanalyze_image_config_updated
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.refine_splines" class="md-nav__link">
    <span class="md-ellipsis">
      refine_splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.regionprops_features" class="md-nav__link">
    <span class="md-ellipsis">
      regionprops_features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.register_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      register_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.register_path" class="md-nav__link">
    <span class="md-ellipsis">
      register_path
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.rename_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      rename_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.rotate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      rotate_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.run_workflow" class="md-nav__link">
    <span class="md-ellipsis">
      run_workflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.sample_subtomograms" class="md-nav__link">
    <span class="md-ellipsis">
      sample_subtomograms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.save_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      save_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.save_project" class="md-nav__link">
    <span class="md-ellipsis">
      save_project
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.save_spline" class="md-nav__link">
    <span class="md-ellipsis">
      save_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      set_multiscale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_radius" class="md-nav__link">
    <span class="md-ellipsis">
      set_radius
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_source_spline" class="md-nav__link">
    <span class="md-ellipsis">
      set_source_spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.set_spline_props" class="md-nav__link">
    <span class="md-ellipsis">
      set_spline_props
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.split_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      split_molecules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.widgets.main.CylindraMainWidget.translate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      translate_molecules
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="cylindrawidgetsmaincylindramainwidget">cylindra.widgets.main.CylindraMainWidget</h1>


<div class="doc doc-object doc-class">



<a id="cylindra.widgets.main.CylindraMainWidget"></a>
    <div class="doc doc-contents first">


              <details class="quote">
                <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@magicclass</span><span class="p">(</span>
    <span class="n">widget_type</span><span class="o">=</span><span class="s2">&quot;scrollable&quot;</span><span class="p">,</span>
    <span class="n">stylesheet</span><span class="o">=</span><span class="n">_STYLE</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cylindra&quot;</span><span class="p">,</span>
    <span class="n">use_native_menubar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@_shared_doc</span><span class="o">.</span><span class="n">update_cls</span>
<span class="k">class</span> <span class="nc">CylindraMainWidget</span><span class="p">(</span><span class="n">MagicTemplate</span><span class="p">):</span>
    <span class="c1"># Main GUI class.</span>

    <span class="c1"># Widget for manual spline fitting</span>
    <span class="n">spline_fitter</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplineFitter</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Spline fitter&quot;</span><span class="p">)</span>
    <span class="c1"># Widget for manual spline clipping</span>
    <span class="n">spline_clipper</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplineClipper</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Spline clipper&quot;</span><span class="p">)</span>
    <span class="c1"># Widget for sweeping along splines</span>
    <span class="n">spline_slicer</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplineSlicer</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Spline slicer&quot;</span><span class="p">)</span>
    <span class="c1"># Widget for pre-filtering/pre-processing</span>
    <span class="n">image_processor</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageProcessor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Image Processor&quot;</span><span class="p">)</span>
    <span class="c1"># Widget for tomogram simulator</span>
    <span class="n">simulator</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">Simulator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Simulator&quot;</span><span class="p">)</span>
    <span class="c1"># Widget for measuring FFT parameters from a 2D power spectra</span>
    <span class="n">spectra_inspector</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">SpectraInspector</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_SpectraInspector&quot;</span><span class="p">)</span>
    <span class="c1"># Widget for subtomogram analysis</span>
    <span class="n">sta</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">SubtomogramAveraging</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_STA widget&quot;</span><span class="p">)</span>

    <span class="n">mole_layers</span> <span class="o">=</span> <span class="n">MoleculesLayerAccessor</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CylindraBatchWidget&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the batch analyzer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">open_project_batch_analyzer</span><span class="p">()</span>

    <span class="c1"># Menu bar</span>
    <span class="n">FileMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;File&quot;</span><span class="p">)</span>
    <span class="n">ImageMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>
    <span class="n">SplinesMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Splines&quot;</span><span class="p">)</span>
    <span class="n">MoleculesMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Molecules&quot;</span><span class="p">)</span>
    <span class="n">AnalysisMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Analysis&quot;</span><span class="p">)</span>
    <span class="n">PluginsMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">PluginsMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plugins&quot;</span><span class="p">)</span>
    <span class="n">OthersMenu</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">OthersMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Others&quot;</span><span class="p">)</span>

    <span class="c1"># Toolbar</span>
    <span class="n">Toolbar</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">CylindraToolbar</span><span class="p">)</span>

    <span class="c1"># Child widgets</span>
    <span class="n">GeneralInfo</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">GeneralInfo</span><span class="p">)</span>
    <span class="c1"># Widget for controling splines</span>
    <span class="n">SplineControl</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplineControl</span><span class="p">)</span>
    <span class="c1"># Widget for summary of local properties</span>
    <span class="n">LocalProperties</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">collapsible</span><span class="p">(</span><span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">LocalPropertiesWidget</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Local Properties&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="c1"># Widget for summary of glocal properties</span>
    <span class="n">GlobalProperties</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">GlobalPropertiesWidget</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Global Properties&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="c1"># Widget for 2D overview of splines</span>
    <span class="n">Overview</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">QtImageCanvas</span><span class="p">)</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;Overview of splines&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>

    <span class="c1">### methods ###</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tomogram</span> <span class="o">=</span> <span class="n">CylTomogram</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="n">binsize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span> <span class="o">=</span> <span class="n">ReservedLayers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugins_called</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CylindraPluginFunction</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span><span class="p">:</span> <span class="s2">&quot;CylindraBatchWidget | None&quot;</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span><span class="p">:</span> <span class="s2">&quot;Path | None&quot;</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span>  <span class="c1"># load napari types</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_width</span> <span class="o">=</span> <span class="mi">400</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GlobalProperties</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">min_height</span> <span class="o">=</span> <span class="mi">300</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_props_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">(</span><span class="n">replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># load all the workflows</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">list_workflow_paths</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">OthersMenu</span><span class="o">.</span><span class="n">Workflows</span><span class="o">.</span><span class="n">append_workflow</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_Logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load workflow </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># setup auto saver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_saver</span> <span class="o">=</span> <span class="n">AutoSaver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">autosave_interval</span><span class="p">)</span>

        <span class="c1"># dask worker number</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">default_dask_n_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">default_dask_n_workers</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid dask worker number. Set to default.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">OthersMenu</span><span class="o">.</span><span class="n">configure_dask</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_dask_n_workers</span><span class="p">)</span>

        <span class="nd">@self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">on_appended</span><span class="o">.</span><span class="n">append</span>
        <span class="k">def</span> <span class="nf">_on_appended</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ui.open_image(&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_saver</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="nd">@self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">on_popped</span><span class="o">.</span><span class="n">append</span>
        <span class="k">def</span> <span class="nf">_on_popped</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_offset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ui.open_image(&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_saver</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_spline_config_path</span><span class="p">)</span>

        <span class="c1"># load plugins</span>
        <span class="n">load_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tomogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylTomogram</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The current tomogram instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tomogram</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">splines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The spline list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The logger instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_Logger</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default spline configuration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_cfg</span>

    <span class="nd">@default_config</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">SplineConfig</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">SplineConfig</span><span class="p">):</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refer_spline_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sub_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;napari.Viewer&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The sub-viewer for subtomogram averages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">sub_viewer</span>

    <span class="k">def</span> <span class="nf">_init_macro_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugins_called</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_splines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of spline objects for categorical widgets.&quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="k">return</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">spl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_spline_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get coordinates of the manually picked spline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">data</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;iuf&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input coordinates must be a (N, 3) numeric array.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_get_available_binsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">multiscaled</span><span class="p">]</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_get_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">updated</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">SplineConfig</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid config type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">_norm_splines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">splines</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">splines</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">splines</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s2">&quot;mdi:pen-add&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">Toolbar</span><span class="p">)</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;F1&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">register_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_spline_coordinates</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_default_config</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register points as a spline path.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">coords</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points are given.&quot;</span><span class="p">)</span>

        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">tomo</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_spline_instance</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_spline_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="s2">&quot;CylSpline&quot;</span><span class="p">):</span>
        <span class="c1"># draw path</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_spline_to_images</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_runner</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">Runner</span><span class="p">)</span>
    <span class="n">_image_loader</span> <span class="o">=</span> <span class="n">_sw</span><span class="o">.</span><span class="n">ImageLoader</span>
    <span class="n">_file_iterator</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileIterator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_confirm_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If user is writing the first spline, there&#39;s no spline registered.</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">has_props</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s2">&quot;solar:eraser-bold&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">Toolbar</span><span class="p">)</span>
    <span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Spline has properties. Are you sure to delete it?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">_confirm_delete</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clear_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear current selection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s2">&quot;material-symbols:bomb&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">Toolbar</span><span class="p">)</span>
    <span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Are you sure to clear all?</span><span class="se">\n</span><span class="s2">You cannot undo this.&quot;</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all the splines and results.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_layers</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_format_macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">:</span> <span class="s2">&quot;mk.Macro | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">macro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="s2">&quot;getattr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">&quot;parent_viewer&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">macro</span><span class="o">.</span><span class="n">format</span><span class="p">([(</span><span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">),</span> <span class="n">v</span><span class="p">)])</span>

    <span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nd">@nogui</span>
    <span class="k">def</span> <span class="nf">run_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a user-defined workflow.</span>

<span class="sd">        This method will run a .py file that was defined by the user from</span>
<span class="sd">        `Workflow &gt; Define workflow`. *args and **kwargs follow the signature of the</span>
<span class="sd">        main function of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">main</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">get_main_function</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_image_loader</span><span class="p">)</span>
    <span class="nd">@dask_thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Reading image&quot;</span><span class="p">)</span>
    <span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;You may have unsaved data. Open a new tomogram?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;self._need_save&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="k">def</span> <span class="nf">open_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">path</span><span class="p">}],</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">scale_value</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tilt_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">tilt_model</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">bin_size</span><span class="p">}]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">ImageFilter</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">filter</span><span class="p">}]</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span>
        <span class="n">invert</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">invert</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">eager</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">eager</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an image file and process it before sending it to the viewer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : Path</span>
<span class="sd">            Path to the tomogram. Must be 3-D image.</span>
<span class="sd">        scale : float, default 1.0</span>
<span class="sd">            Pixel size in nm/pixel unit.</span>
<span class="sd">        tilt_range : tuple of float, default None</span>
<span class="sd">            Range of tilt angles in degrees.</span>
<span class="sd">        bin_size : int or list of int, default [1]</span>
<span class="sd">            Initial bin size of image. Binned image will be used for visualization in the viewer.</span>
<span class="sd">            You can use both binned and non-binned image for analysis.</span>
<span class="sd">        {filter}</span>
<span class="sd">        invert : bool, default False</span>
<span class="sd">            If true, invert the intensity of the image.</span>
<span class="sd">        eager : bool, default False</span>
<span class="sd">            If true, the image will be loaded immediately. Otherwise, it will be loaded</span>
<span class="sd">            lazily.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">lazy</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">_config</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">dask_chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">bin_size</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify at least one bin size.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bin_size</span><span class="p">))</span>  <span class="c1"># delete duplication</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="n">CylTomogram</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt_range</span><span class="p">,</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_macro_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_tomogram_to_viewer</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">tomo</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">)</span>

    <span class="nd">@open_image</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span>
    <span class="k">def</span> <span class="nf">_open_image_on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_loader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Reading project&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;You may have unsaved data. Open a new project?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;self._need_save&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="nd">@do_not_record</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+P&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load_project</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">],</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">ImageFilter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span>
        <span class="n">read_image</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;read image data&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">update_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a project file (project.json, tar file or zip file).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : path-like or CylindraProject</span>
<span class="sd">            Path to the project file, or the project directory that contains a project</span>
<span class="sd">            file, or a CylindraProject object.</span>
<span class="sd">        {filter}</span>
<span class="sd">        read_image : bool, default True</span>
<span class="sd">            Whether to read image data from the project directory. If false, image data</span>
<span class="sd">            will be memory-mapped and will not be shown in the viewer. Unchecking this</span>
<span class="sd">            is useful to decrease loading time.</span>
<span class="sd">        update_config : bool, default False</span>
<span class="sd">            Whether to update the default spline configuration with the one described</span>
<span class="sd">            in the project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">CylindraProject</span><span class="p">):</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">project_path</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">project_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">CylindraProject</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">project_path</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">project_path</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;ui.load_project(&#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;filter=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">read_image</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">update_config</span><span class="si">=}</span><span class="s2">)&lt;/code&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">project_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project loaded: </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="o">=</span> <span class="n">project_path</span>
        <span class="k">yield from</span> <span class="n">project</span><span class="o">.</span><span class="n">_to_gui</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">read_image</span><span class="o">=</span><span class="n">read_image</span><span class="p">,</span>
            <span class="n">update_config</span><span class="o">=</span><span class="n">update_config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+S&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_project</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Save</span><span class="p">,</span>
        <span class="n">molecules_ext</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span>
        <span class="n">save_landscape</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Save landscape layers&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save current project state and the results in a directory.</span>

<span class="sd">        The json file contains paths of images and results, parameters of splines,</span>
<span class="sd">        scales and version. Local and global properties will be exported as csv files.</span>
<span class="sd">        Molecule coordinates and features will be exported as the `molecules_ext`</span>
<span class="sd">        format. If results are saved at the default directory, they will be</span>
<span class="sd">        written as relative paths in the project json file so that moving root</span>
<span class="sd">        directory does not affect the loading behavior.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : Path</span>
<span class="sd">            Path of json file.</span>
<span class="sd">        molecules_ext : str, default &quot;.csv&quot;</span>
<span class="sd">            Extension of the molecule file. Can be &quot;.csv&quot; or &quot;.parquet&quot;.</span>
<span class="sd">        save_landscape : bool, default False</span>
<span class="sd">            Save landscape layers if any. False by default because landscape layers are</span>
<span class="sd">            usually large.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">CylindraProject</span><span class="o">.</span><span class="n">save_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">molecules_ext</span><span class="p">,</span> <span class="n">save_landscape</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project saved: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">autosave_path</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">autosave_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">autosave_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">autosave_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+Shift+S&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">overwrite_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Overwrite currently opened project.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No project is loaded. You can use `Save project` &quot;</span>
                <span class="s2">&quot;(ui.save_project(...)) to save the current state.&quot;</span>
            <span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">CylindraProject</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">molecules_info</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">molecules_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load_splines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Multiple</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">JSON</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load splines from a list of json paths.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list of path-like objects</span>
<span class="sd">            Paths to json files that describe spline parameters in the correct format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="p">[</span><span class="n">CylSpline</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Multiple</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">MOLE</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load molecules from a csv file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
        <span class="n">moles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Molecules</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mole</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">moles</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
            <span class="n">add_molecules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">save_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Save</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">JSON</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save splines as a json file.&quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@do_not_record</span>
    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Save</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">MOLE</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save monomer coordinates, orientation and features as a csv file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        save_path : Path</span>
<span class="sd">            Where to save the molecules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">open_reference_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open an image as a reference image of the current tomogram.</span>

<span class="sd">        The input image is usually a denoised image created by other softwares, or</span>
<span class="sd">        simply a filtered image. Please note that this method does not check that the</span>
<span class="sd">        input image is appropriate as a reference of the current tomogram, as</span>
<span class="sd">        potentially any 3D image can be used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : path-like</span>
<span class="sd">            Path to the image file. The image must be 3-D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_reference_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">open_label_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open an image file as a label image of the current tomogram.&quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Label image must be 3-D.&quot;</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
            <span class="n">label</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">translate</span><span class="o">=</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">],</span>
            <span class="n">scale</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">to_be_removed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
    <span class="nd">@dask_thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="n">_pdesc</span><span class="o">.</span><span class="n">filter_image_fmt</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">filter_reference_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">ImageFilter</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply filter to enhance contrast of the reference image.&quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">is_dummy</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">set_gpu</span><span class="p">():</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image_data</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
            <span class="n">_tiled</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">tiled</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.6</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">scale</span>
            <span class="k">match</span> <span class="n">method</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">:</span>
                    <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">lowpass_filter</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">:</span>
                    <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">fourier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">DoG</span><span class="p">:</span>
                    <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">dog_filter</span><span class="p">(</span><span class="n">low_sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">fourier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">LoG</span><span class="p">:</span>
                    <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">log_filter</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No method matches </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">fast_percentile</span><span class="p">(</span><span class="n">img_filt</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">])</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_filter_reference_image_on_return</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">img_filt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">contrast_limits</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">proj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">contrast_limits</span>

        <span class="n">t0</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_filter_reference_image_on_return</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Inverting image&quot;</span><span class="p">)</span>
    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">invert_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the intensity of the images.&quot;&quot;&quot;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">is_lazy</span><span class="p">:</span>

            <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">_invert_image_on_return</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invert_image</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_inv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span>
            <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">fast_percentile</span><span class="p">(</span><span class="n">img_inv</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cmin</span> <span class="o">&gt;=</span> <span class="n">cmax</span><span class="p">:</span>
                <span class="n">cmax</span> <span class="o">=</span> <span class="n">cmin</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">_invert_image_on_return</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">img_inv</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="p">)</span>
                <span class="n">clow</span><span class="p">,</span> <span class="n">chigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">contrast_limits</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="o">-</span><span class="n">chigh</span><span class="p">,</span> <span class="o">-</span><span class="n">clow</span>
                <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invert_image</span><span class="p">)</span>

        <span class="n">t0</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_invert_image_on_return</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add multi-scale&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
    <span class="nd">@dask_thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">bin_size</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Adding multiscale (bin = </span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="k">def</span> <span class="nf">add_multiscale</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">))}]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new multi-scale image of current tomogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_size : int, default 4</span>
<span class="sd">            Bin size of the new image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">tomo</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_multiscale</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Set multi-scale&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set multiscale used for image display.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_size: int</span>
<span class="sd">            Bin size of multiscaled image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">_old_bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_binsize</span>
        <span class="n">imgb</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">imgb</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">update_image</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">tomo</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">bin_size</span><span class="p">))</span>
        <span class="n">current_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">current_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">set_current_step</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">current_z</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>

        <span class="c1"># update overview</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">imgb</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">factor</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">xlim</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">*</span> <span class="n">factor</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">ylim</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_binsize</span> <span class="o">=</span> <span class="n">bin_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_multiscale</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">_old_bin_size</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sample_subtomograms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample subtomograms at the anchor points on splines&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spline_fitter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># initialize GUI</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No spline found.&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">has_anchors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_num_changed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;pan_zoom&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_properties_in_widget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_spline</span><span class="p">()</span>

        <span class="c1"># reset contrast limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_reset_contrast_limits</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_spline_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Orientation</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">invert_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert current displayed spline **in place**.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spline : int, optional</span>
<span class="sd">            ID of splines to be inverted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

        <span class="n">need_resample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">need_resample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">need_resample</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invert_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Orientation</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">align_to_polarity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;MinusToPlus&quot;</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MinusToPlus&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align all the splines in the direction parallel to the cylinder polarity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orientation : Ori, default Ori.MinusToPlus</span>
<span class="sd">            To which direction splines will be aligned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">need_resample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">need_resample</span>
        <span class="n">_old_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">align_to_polarity</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">need_resample</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">_new_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">_old_orientations</span><span class="p">,</span> <span class="n">need_resample</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">(</span><span class="n">_new_orientations</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Orientation</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Auto-detecting polarities...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">infer_polarity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically detect the cylinder polarities.</span>

<span class="sd">        This function uses Fourier vorticity to detect the polarities of the splines.</span>
<span class="sd">        The subtomogram at the center of the spline will be sampled in the cylindric</span>
<span class="sd">        coordinate and the power spectra in (radius, angle) space will be calculated.</span>
<span class="sd">        The peak position of the `angle = nPF` line scan will be used to detect the</span>
<span class="sd">        polarity of the spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{depth}{bin_size}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">_old_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">):</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">infer_polarity</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="n">_new_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_on_return</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_update_canvas</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">)</span>
                <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">_old_orientations</span><span class="p">)</span>
                <span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">(</span><span class="n">_new_orientations</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">_on_return</span>

    <span class="k">def</span> <span class="nf">_set_orientations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Ori</span><span class="p">],</span> <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spl</span><span class="p">,</span> <span class="n">ori</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">ori</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+X&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clip_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
        <span class="n">lengths</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;clip length (nm)&quot;</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clip selected spline at its edges by given lengths.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spline : int</span>
<span class="sd">            The ID of spline to be clipped.</span>
<span class="sd">        lengths : tuple of float, default (0., 0.)</span>
<span class="sd">            The length in nm to be clipped at the start and end of the spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="n">_old_spl</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="c1"># current layer will be removed. Select another layer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="p">}</span>

        <span class="nd">@undo_callback</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">_old_spl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
    <span class="nd">@confirm</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Spline has properties. Are you sure to delete it?&quot;</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="n">_confirm_delete</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete currently selected spline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

        <span class="c1"># update layer</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">features</span>
        <span class="n">old_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">select_spline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">need_resample</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>

        <span class="nd">@undo_callback</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">old_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_spline_to_images</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of the current spline&quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Copy spline (new config)&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy_spline_new_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}],</span>
        <span class="n">npf_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
        <span class="n">spacing_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">),</span>
        <span class="n">twist_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">rise_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">),</span>
        <span class="n">rise_sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">clockwise</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">,</span>
        <span class="n">thickness_inner</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">2.8</span><span class="p">,</span>
        <span class="n">thickness_outer</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">2.8</span><span class="p">,</span>
        <span class="n">fit_depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">49.0</span><span class="p">,</span>
        <span class="n">fit_width</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">44.0</span><span class="p">,</span>
        <span class="n">copy_props</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of the current spline with a new configuration.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;copy_props&quot;</span><span class="p">]</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">spl_new</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">copy_props</span><span class="o">=</span><span class="n">copy_props</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_new</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Fitting</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Spline Fitting&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fit_splines</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max interval (nm)&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">degree_precision</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">edge_sigma</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not mask image&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;edge σ&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit splines to the cylinder by auto-correlation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{max_interval}{bin_size}{err_max}</span>
<span class="sd">        degree_precision : float, default 0.5</span>
<span class="sd">            Precision of xy-tilt degree in angular correlation.</span>
<span class="sd">        edge_sigma : bool, default 2.0</span>
<span class="sd">            Check if cylindric structures are densely packed. Initial spline position</span>
<span class="sd">            must be &quot;almost&quot; fitted in dense mode.</span>
<span class="sd">        max_shift : nm, default 5.0</span>
<span class="sd">            Maximum shift to be applied to each point of splines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span>
                    <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">,</span>
                    <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                    <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                    <span class="n">degree_precision</span><span class="o">=</span><span class="n">degree_precision</span><span class="p">,</span>
                    <span class="n">edge_sigma</span><span class="o">=</span><span class="n">edge_sigma</span><span class="p">,</span>
                    <span class="n">max_shift</span><span class="o">=</span><span class="n">max_shift</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">)</span>

            <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Fitting</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Spline Fitting&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fit_splines_by_centroid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max interval (nm)&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit splines to the cylinder by centroid of sub-volumes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{max_interval}{bin_size}{err_max}</span>
<span class="sd">        max_shift : nm, default 5.0</span>
<span class="sd">            Maximum shift to be applied to each point of splines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">fit_centroid</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span>
                    <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">,</span>
                    <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                    <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                    <span class="n">max_shift</span><span class="o">=</span><span class="n">max_shift</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">)</span>

            <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_anchors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Interval between anchors (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">25.0</span><span class="p">,</span>
        <span class="n">how</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pack&quot;</span><span class="p">,</span> <span class="s2">&quot;equal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pack&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add anchors to splines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{interval}</span>
<span class="sd">        how : str, default &quot;pack&quot;</span>
<span class="sd">            How to add anchors.</span>

<span class="sd">            - &quot;pack&quot;: (x———x———x—) Pack anchors from the starting point of splines.</span>
<span class="sd">            - &quot;equal&quot;: (x——x——x——x) Equally distribute anchors between the starting</span>
<span class="sd">              point and the end point of splines. Actual intervals will be smaller.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">match</span> <span class="n">how</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;pack&quot;</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">splines</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
                <span class="k">case</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">splines</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Fitting</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Refining splines&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">refine_splines</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum interval (nm)&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">corr_allowed</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;correlation allowed&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refine splines using the global cylindric structural parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{max_interval}{err_max}</span>
<span class="sd">        corr_allowed : float, default 0.9</span>
<span class="sd">            How many images will be used to make template for alignment. If 0.9, then</span>
<span class="sd">            top 90% will be used.</span>
<span class="sd">        {bin_size}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span>
                    <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">,</span>
                    <span class="n">corr_allowed</span><span class="o">=</span><span class="n">corr_allowed</span><span class="p">,</span>
                    <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                    <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">)</span>

            <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Set spline properties&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_spline_props</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}],</span>
        <span class="n">npf</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;number of PF&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not update&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;start number&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not update&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;MinusToPlus&quot;</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">]],</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not update&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set spline global properties.</span>

<span class="sd">        This method will overwrite spline properties with the user input. You should</span>
<span class="sd">        not call this method unless there&#39;s a good reason to do so, e.g. the number</span>
<span class="sd">        of protofilaments is obviously wrong.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        npf : int, optional</span>
<span class="sd">            If given, update the number of protofilaments.</span>
<span class="sd">        start : int, optional</span>
<span class="sd">            If given, update the start number of the spline.</span>
<span class="sd">        orientation : str, optional</span>
<span class="sd">            If given, update the spline orientation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="n">old_spl</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">update_props</span><span class="p">(</span><span class="n">npf</span><span class="o">=</span><span class="n">npf</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>

        <span class="nd">@undo_callback</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_spl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">molecules_to_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">delete_old</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Delete old splines&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">inherits</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Properties to inherit&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;All properties&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">missing_ok</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing OK&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">update_sources</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Update all the spline sources&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create splines from molecules.</span>

<span class="sd">        This function is useful to refine splines using results of subtomogram</span>
<span class="sd">        alignment. If the molecules layer alreadly has a source spline, replace</span>
<span class="sd">        it with the new one.</span>
<span class="sd">        Note that this function only works with molecules that is correctly</span>
<span class="sd">        assembled by such as :func:`map_monomers`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layers}{err_max}</span>
<span class="sd">        delete_old : bool, default True</span>
<span class="sd">            If True, delete the old spline if the molecules has one. For instance, if</span>
<span class="sd">            &quot;Mole-0&quot; has the spline &quot;Spline-0&quot; as the source, and a spline &quot;Spline-1&quot; is</span>
<span class="sd">            created from &quot;Mole-0&quot;, then &quot;Spline-0&quot; will be deleted from the list.</span>
<span class="sd">        inherits : bool, optional</span>
<span class="sd">            Which global properties to be copied to the new one. If None, all the properties</span>
<span class="sd">            will be copied.</span>
<span class="sd">        missing_ok : bool, default False</span>
<span class="sd">            If False, raise an error if the source spline is not found in the tomogram.</span>
<span class="sd">        update_sources : bool, default True</span>
<span class="sd">            If True, all the molecules with the out-of-date source spline will be updated</span>
<span class="sd">            to the newly created splines. For instance, if &quot;Mole-0&quot; and &quot;Mole-1&quot; have the</span>
<span class="sd">            spline &quot;Spline-0&quot; as the source, and a spline &quot;Spline-1&quot; is created from</span>
<span class="sd">            &quot;Mole-1&quot;, then the source of &quot;Mole-1&quot; will be updated to &quot;Spline-1&quot; as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>

        <span class="c1"># first check missing_ok=False case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                <span class="c1"># NOTE: The source spline may not exist in the list</span>
                <span class="k">if</span> <span class="n">_s</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>  <span class="c1"># raise error here if not found</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_s</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">:</span>
                <span class="n">_config</span> <span class="o">=</span> <span class="n">_s</span><span class="o">.</span><span class="n">config</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span>
            <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">layer</span><span class="o">.</span><span class="n">regular_shape</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_shape</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">spl</span> <span class="o">=</span> <span class="n">CylSpline</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">_config</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="n">old_spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">glob</span> <span class="o">=</span> <span class="n">old_spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span>
                    <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">glob</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inherits</span><span class="p">}</span>

                <span class="c1"># Must be updated here, otherwise each.source_component may return</span>
                <span class="c1"># None since GC may delete the old spline.</span>
                <span class="k">if</span> <span class="n">update_sources</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">each</span><span class="o">.</span><span class="n">source_component</span> <span class="ow">is</span> <span class="n">old_spl</span><span class="p">:</span>
                            <span class="n">each</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="n">spl</span>
                <span class="k">if</span> <span class="n">delete_old</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="n">spl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">protofilaments_to_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_default_config</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert protofilaments to splines.</span>

<span class="sd">        If no IDs are given, all the molecules will be fitted to a spline, therefore</span>
<span class="sd">        essentially the same as manual filament picking. If IDs are given, selected</span>
<span class="sd">        protofilaments will be fitted to a spline separately.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{err_max}</span>
<span class="sd">        ids : list of int, default ()</span>
<span class="sd">            Protofilament IDs to be converted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">)</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Measuring Radius&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">measure_radius</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">min_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">max_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure cylinder radius for each spline curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{bin_size}{min_radius}{max_radius}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">measure_radius</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">min_radius</span><span class="o">=</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span>
                <span class="p">)</span>
                <span class="k">yield</span>

            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_radius</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">radius</span><span class="p">:</span> <span class="n">PolarsExprStrOrScalar</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set radius of the splines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}</span>
<span class="sd">        radius : float or str expression</span>
<span class="sd">            Radius of the spline. If a string expression is given, it will be evaluated to get</span>
<span class="sd">            the polars.Expr object. The returned expression will be evaluated with the global</span>
<span class="sd">            properties of the spline as the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius_expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_scalar_expr</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">radius_expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_radius</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Radius must be converted into a number, got </span><span class="si">{</span><span class="n">_radius</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">_radius</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Radius must be positive, got </span><span class="si">{</span><span class="n">_radius</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">rdict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_radius</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">rdict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Measuring local radii&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">measure_local_radius</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">_Interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">min_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">max_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">update_glob</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Also update the global radius&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure radius for each local region along splines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{interval}{depth}{bin_size}{min_radius}{max_radius}{update_glob}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_on_yield</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">(</span><span class="n">replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">local_radii</span><span class="p">(</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                    <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                    <span class="n">min_radius</span><span class="o">=</span><span class="n">min_radius</span><span class="p">,</span>
                    <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">,</span>
                    <span class="n">update_glob</span><span class="o">=</span><span class="n">update_glob</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">splines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="n">_on_yield</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span>

            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">measure_radius_by_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">_Interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">update_glob</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Also update the global radius&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure local and global radius for each layer.</span>

<span class="sd">        Please note that the radius defined by the peak of the radial profile is not always</span>
<span class="sd">        the same as the radius measured by this method. If the molecules are aligned using</span>
<span class="sd">        a template image whose mass density is not centered, these radii may differ a lot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layers}{interval}{depth}{update_glob}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>

        <span class="c1"># check duplicated spline sources</span>
        <span class="n">_splines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">CylSpline</span><span class="p">]()</span>
        <span class="n">_radius_df</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]()</span>
        <span class="n">_duplicated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">CylSpline</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">spl</span> <span class="ow">is</span> <span class="n">each</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">_splines</span><span class="p">):</span>
                <span class="n">_duplicated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
            <span class="n">_splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">features</span>
            <span class="n">_radius_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">cylmeasure</span><span class="o">.</span><span class="n">calc_radius</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">spl</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">_duplicated</span><span class="p">:</span>
            <span class="n">_layer_names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layers </span><span class="si">{</span><span class="n">_layer_names</span><span class="si">}</span><span class="s2"> have duplicated spline sources.&quot;</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="n">_splines</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">_splines</span><span class="p">,</span> <span class="n">_radius_df</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
                <span class="n">radii</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span> <span class="o">*</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">():</span>
                    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                    <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pred</span><span class="p">)[</span><span class="n">Mole</span><span class="o">.</span><span class="n">radius</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="n">radii</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">radii</span><span class="o">.</span><span class="n">is_nan</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> contains NaN radius.&lt;/b&gt;&quot;</span><span class="p">)</span>
                <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">([</span><span class="n">radii</span><span class="p">],</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">update_glob</span><span class="p">:</span>
                    <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">radius</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">(</span><span class="n">replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Local CFT analysis&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Local Cylindric Fourier transform&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="k">def</span> <span class="nf">local_cft_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">_Interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">radius</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span>
        <span class="n">update_glob</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Also update the global properties&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine local lattice parameters by local cylindric Fourier transformation.</span>

<span class="sd">        This method will sample subtomograms at given intervals and calculate the power</span>
<span class="sd">        spectra in a cylindrical coordinate. The peak position of the power spectra will</span>
<span class="sd">        used to determine the lattice parameters. Note that if the interval differs from</span>
<span class="sd">        the current spline anchors, the old local properties will be dropped.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{interval}{depth}{bin_size}</span>
<span class="sd">        radius : str, default &quot;global&quot;</span>
<span class="sd">            If &quot;local&quot;, use the local radius for the analysis. If &quot;global&quot;, use the</span>
<span class="sd">            global radius.</span>
<span class="sd">        {update_glob}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>

        <span class="c1"># first check radius</span>
        <span class="k">match</span> <span class="n">radius</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Global Radius of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-th spline is not measured yet. Please &quot;</span>
                            <span class="s2">&quot;measure the radius first from `Analysis &gt; Radius`.&quot;</span>
                        <span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">has_loc</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Local Radius of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-th spline is not measured yet. Please &quot;</span>
                            <span class="s2">&quot;measure the radius first from `Analysis &gt; Radius`.&quot;</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;With `interval`, local radius values will be dropped. Please &quot;</span>
                        <span class="s2">&quot;set `radius=&#39;global&#39;` or `interval=None`.&quot;</span>
                    <span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;radius must be &#39;local&#39; or &#39;global&#39;, got </span><span class="si">{</span><span class="n">radius</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_local_cft_analysis_on_yield</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">local_cft_params</span><span class="p">(</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                    <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                    <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                    <span class="n">update_glob</span><span class="o">=</span><span class="n">update_glob</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="n">_local_cft_analysis_on_yield</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Global CFT analysis&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Global Cylindric Fourier transform&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">global_cft_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine cylindrical global structural parameters by Fourier transformation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{bin_size}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tomo</span><span class="o">.</span><span class="n">measure_radius</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">global_cft_params</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">)</span>
                <span class="k">yield</span>

            <span class="c1"># show all in a table</span>
            <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">_global_cft_analysis_on_return</span><span class="p">():</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">],</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical_relaxed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
                <span class="n">_Logger</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_properties_in_widget</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">_global_cft_analysis_on_return</span>

    <span class="k">def</span> <span class="nf">_get_reanalysis_macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the macro expression for reanalysis in the given project path.&quot;&quot;&quot;</span>
        <span class="n">_ui_sym</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">CylindraProject</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">project</span><span class="o">.</span><span class="n">open_project</span><span class="p">()</span> <span class="k">as</span> <span class="n">_dir</span><span class="p">:</span>
            <span class="n">macro_path</span> <span class="o">=</span> <span class="n">_dir</span> <span class="o">/</span> <span class="s2">&quot;script.py&quot;</span>
            <span class="n">macro_expr</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">macro_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">_filter_macro_for_reanalysis</span><span class="p">(</span><span class="n">macro_expr</span><span class="p">,</span> <span class="n">_ui_sym</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Re-analyze current tomogram&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">reanalyze_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reanalyze the current tomogram.</span>

<span class="sd">        This method will extract the first manual operations from current session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_ui_sym</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">macro_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_macro</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="p">:]</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">_filter_macro_for_reanalysis</span><span class="p">(</span><span class="n">macro_expr</span><span class="p">,</span> <span class="n">_ui_sym</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
        <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">Head</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">macro</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">_ui_sym</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Re-analyze with new config&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">reanalyze_image_config_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reanalyze the current tomogram with newly set default spline config.</span>

<span class="sd">        This method is useful when you have mistakenly drawn splines with wrong spline</span>
<span class="sd">        config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_ui_sym</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">macro_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_macro</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="p">:]</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">_filter_macro_for_reanalysis</span><span class="p">(</span><span class="n">macro_expr</span><span class="p">,</span> <span class="n">_ui_sym</span><span class="p">)</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">_remove_config_kwargs</span><span class="p">(</span><span class="n">macro</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
        <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">Head</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">macro</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">_ui_sym</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Re-analyze project&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+L&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load_project_for_reanalysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a project file to re-analyze the data.</span>

<span class="sd">        This method will extract the first manual operations from a project file and</span>
<span class="sd">        run them. This is useful when you want to re-analyze the data with a different</span>
<span class="sd">        parameter set, or when there were some improvements in cylindra.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reanalysis_macro</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Monomer mapping methods</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Mapping monomers&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">map_monomers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="n">_OffsetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">radius</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extensions</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mole&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map monomers as a regular cylindric grid assembly.</span>

<span class="sd">        This method uses the spline global properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{orientation}{offsets}</span>
<span class="sd">        radius : nm, optional</span>
<span class="sd">            Radius of the cylinder to position monomers.</span>
<span class="sd">        extensions : (int, int), default (0, 0)</span>
<span class="sd">            Number of molecules to extend. Should be a tuple of (prepend, append).</span>
<span class="sd">            Negative values will remove molecules.</span>
<span class="sd">        {prefix}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>

        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;map_monomers&lt;/code&gt;&quot;</span><span class="p">)</span>
        <span class="n">_added_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_add_molecules</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">):</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
            <span class="n">_added_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">):</span>
            <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_monomers</span><span class="p">(</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
                <span class="n">offsets</span><span class="o">=</span><span class="n">normalize_offsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
                <span class="n">radius</span><span class="o">=</span><span class="n">normalize_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
                <span class="n">extensions</span><span class="o">=</span><span class="n">extensions</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">cb</span> <span class="o">=</span> <span class="n">_add_molecules</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">cb</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">await_call</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">_added_layers</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">map_monomers_with_extensions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
        <span class="n">n_extend</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;prepend/append&quot;</span><span class="p">,</span> <span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">ProtofilamentEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="n">_OffsetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">radius</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mole&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map monomers as a regular cylindric grid assembly.</span>

<span class="sd">        This method uses the spline global properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {spline}</span>
<span class="sd">        n_extend : dict[int, (int, int)]</span>
<span class="sd">            Number of molecules to extend. Should be mapping from the PF index to the (prepend,</span>
<span class="sd">            append) number of molecules to add. Remove molecules if negative values are given.</span>
<span class="sd">        {orientation}{offsets}</span>
<span class="sd">        radius : nm, optional</span>
<span class="sd">            Radius of the cylinder to position monomers.</span>
<span class="sd">        {prefix}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">coordinates_with_extensions</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">n_extend</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_on_grid</span><span class="p">(</span>
            <span class="n">i</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
            <span class="n">offsets</span><span class="o">=</span><span class="n">normalize_offsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">normalize_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spline</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">map_along_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">molecule_interval</span><span class="p">:</span> <span class="n">PolarsExprStrOrScalar</span> <span class="o">=</span> <span class="s2">&quot;col(&#39;spacing&#39;)&quot;</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rotate_molecules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Center&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map molecules along splines. Each molecule is rotated by skewing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {splines}{molecule_interval}{orientation}</span>
<span class="sd">        rotate_molecules : bool, default True</span>
<span class="sd">            If True, rotate molecules by the &quot;twist&quot; parameter of each spline.</span>
<span class="sd">        {prefix}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">interv_expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_scalar_expr</span><span class="p">(</span><span class="n">molecule_interval</span><span class="p">)</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;map_along_spline&lt;/code&gt;&quot;</span><span class="p">)</span>
        <span class="n">_added_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">interv</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">interv_expr</span><span class="p">)</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_centers</span><span class="p">(</span>
                <span class="n">i</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="n">interv</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
                <span class="n">rotate_molecules</span><span class="o">=</span><span class="n">rotate_molecules</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
            <span class="n">_added_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">_added_layers</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Map alogn PF&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">map_along_pf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
        <span class="n">molecule_interval</span><span class="p">:</span> <span class="n">PolarsExprStrOrScalar</span> <span class="o">=</span> <span class="s2">&quot;col(&#39;spacing&#39;)&quot;</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="n">_OffsetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PF&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map molecules along the line of a protofilament.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {spline}{molecule_interval}{offsets}{orientation}{prefix}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="n">interv_expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_scalar_expr</span><span class="p">(</span><span class="n">molecule_interval</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;map_along_PF&lt;/code&gt;&quot;</span><span class="p">)</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_pf_line</span><span class="p">(</span>
            <span class="n">i</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">interv_expr</span><span class="p">),</span>
            <span class="n">offsets</span><span class="o">=</span><span class="n">normalize_offsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spline</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_source_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set source spline for a molecules layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{spline}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">old_spl</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>

        <span class="nd">@undo_callback</span>
        <span class="k">def</span> <span class="nf">_undo</span><span class="p">():</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="n">old_spl</span>

        <span class="k">return</span> <span class="n">_undo</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Combine</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">concatenate_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mole-concat&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate selected molecules and create a new ones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layers}</span>
<span class="sd">        name : str, default &quot;Mole-concat&quot;</span>
<span class="sd">            Name of the new molecules layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">all_molecules</span> <span class="o">=</span> <span class="n">Molecules</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">])</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">add_molecules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">,</span> <span class="n">all_molecules</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># logging</span>
        <span class="n">layer_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">layer_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;concatenate_molecules&lt;/code&gt;&quot;</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Concatenated:&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layer_names</span><span class="p">))</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">points</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_molecules</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Combine</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">merge_molecule_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">rotation</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge molecule info from different molecules.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : MoleculesLayer</span>
<span class="sd">            Molecules whose positions are used.</span>
<span class="sd">        rotation : MoleculesLayer</span>
<span class="sd">            Molecules whose rotations are used.</span>
<span class="sd">        features : MoleculesLayer</span>
<span class="sd">            Molecules whose features are used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">_rot</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">_feat</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">_rot</span><span class="o">.</span><span class="n">rotator</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">_feat</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span>
            <span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mole-merged&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">pos</span><span class="o">.</span><span class="n">source_component</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Combine</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy_molecules_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">destinations</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
        <span class="n">column</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;copy_molecules_features&quot;</span><span class="p">)}],</span>
        <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy molecules features from one layer to another.</span>

<span class="sd">        This method is useful when a layer feature (such as seam search result) should be</span>
<span class="sd">        shared by multiple molecules layers that were aligned in a different parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : MoleculesLayer</span>
<span class="sd">            Layer whose features will be copied.</span>
<span class="sd">        destinations : MoleculesLayersType</span>
<span class="sd">            To which layers the features should be copied.</span>
<span class="sd">        column : str</span>
<span class="sd">            Column name of the feature to be copied.</span>
<span class="sd">        alias : str, optional</span>
<span class="sd">            If given, the copied feature will be renamed to this name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">destinations</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">destinations</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">([</span><span class="n">series</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Split molecules by feature&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">split_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">by</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;split_molecules&quot;</span><span class="p">)}],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split molecules by a feature column.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        by : str</span>
<span class="sd">            Name of the feature to split by.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
        <span class="n">_added_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">mole</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span>
                <span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">source_component</span>
            <span class="p">)</span>
            <span class="n">_added_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">_added_layers</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">register_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_spline_coordinates</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register manually added points as molecules.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">coords</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points are given.&quot;</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mole-manual&quot;</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">translate_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
        <span class="n">translation</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;translation Z, Y, X (nm)&quot;</span><span class="p">}],</span>
        <span class="n">internal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate molecule coordinates without changing their rotations.</span>

<span class="sd">        Output molecules layer will be named as &quot;&lt;original name&gt;-Shift&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layers}</span>
<span class="sd">        translation : tuple of float</span>
<span class="sd">            Translation (nm) of the molecules in (Z, Y, X) order. Whether the world</span>
<span class="sd">            coordinate or the internal coordinate is used depends on the `internal`</span>
<span class="sd">            argument.</span>
<span class="sd">        internal : bool, default True</span>
<span class="sd">            If true, the translation is applied to the internal coordinates, i.e.</span>
<span class="sd">            molecules with different rotations are translated differently.</span>
<span class="sd">        {inherit_source}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">new_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
            <span class="k">if</span> <span class="n">internal</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="c1"># update spline position feature</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">with_features</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="c1"># spline position is not predictable.</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop_features</span><span class="p">([</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">])</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Shift&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="n">new_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new_layers</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rotate_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
        <span class="n">degrees</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">]],</span>
            <span class="p">{</span><span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">SingleRotationEdit</span><span class="p">}},</span>
        <span class="p">],</span>
        <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate molecules without changing their positions.</span>

<span class="sd">        Output molecules layer will be named as &quot;&lt;original name&gt;-Rot&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layers}</span>
<span class="sd">        degrees : list of (str, float)</span>
<span class="sd">            Rotation axes and degrees. For example, `[(&quot;z&quot;, 20), (&quot;y&quot;, -10)]` means</span>
<span class="sd">            rotation by 20 degrees around the molecule Z axis and then by -10 degrees</span>
<span class="sd">            around the Y axis.</span>
<span class="sd">        {inherit_source}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">new_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
        <span class="n">rotvec</span> <span class="o">=</span> <span class="n">degrees_to_rotator</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">(</span><span class="n">rotvec</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Rot&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="n">new_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new_layers</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Rename molecule layers&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rename_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">old</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename multiple molecules layers at once.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        old : str</span>
<span class="sd">            Old string to be replaced.</span>
<span class="sd">        new : str</span>
<span class="sd">            New string to replace `old`.</span>
<span class="sd">        include : str, optional</span>
<span class="sd">            Delete layers whose names contain this string.</span>
<span class="sd">        exclude : str, optional</span>
<span class="sd">            Delete layers whose names do not contain this string.</span>
<span class="sd">        pattern : str, optional</span>
<span class="sd">            String pattern to match the layer names. Use `*` as wildcard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">old</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`old` is not given.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`new` is not given.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span>
        <span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Delete molecule layers&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete molecules by the layer names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include : str, optional</span>
<span class="sd">            Delete layers whose names contain this string.</span>
<span class="sd">        exclude : str, optional</span>
<span class="sd">            Delete layers whose names do not contain this string.</span>
<span class="sd">        pattern : str, optional</span>
<span class="sd">            String pattern to match the layer names. Use `*` as wildcard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">filter_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">predicate</span><span class="p">:</span> <span class="n">PolarsExprStr</span><span class="p">,</span>
        <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter molecules by their features.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        predicate : ExprStr</span>
<span class="sd">            A polars-style filter predicate, such as `pl.col(&quot;pf-id&quot;) == 3`</span>
<span class="sd">        {inherit_source}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_expr</span><span class="p">(</span><span class="n">predicate</span><span class="p">))</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Filt&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">drop_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">IndexEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drop a subset of molecules from a molecules layer by indices.</span>

<span class="sd">        Note that the indices start from 0. `ui.drop_molecules(layer, [0, 2, 6])` will</span>
<span class="sd">        drop 0th, 2nd, and 6th molecules.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        indices : str, int, slice or sequence of int or slice, optional</span>
<span class="sd">            A sequence of molecule indices to drop. You can use `npf` for the number</span>
<span class="sd">            of protofilaments and `N` for the number of molecules. `slice` is also</span>
<span class="sd">            allowed for dropping a range of indices. In GUI, this parameter must a</span>
<span class="sd">            string of comma-separated integers/slices (e.g. `3, N - 3`,</span>
<span class="sd">            `1, slice(12, 12 + npf)`).</span>
<span class="sd">        {inherit_source}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">_to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">spl</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">:</span>
                <span class="n">npf</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">npf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">IndexEdit</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">npf</span><span class="o">=</span><span class="n">npf</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                <span class="n">_to_drop</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="n">_to_drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indices must be integers, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_to_drop</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Drop&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">View</span><span class="p">)</span>
    <span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, C&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">paint_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">color_by</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;paint_molecules&quot;</span><span class="p">)}],</span>
        <span class="n">cmap</span><span class="p">:</span> <span class="n">_CmapType</span> <span class="o">=</span> <span class="n">DEFAULT_COLORMAP</span><span class="p">,</span>
        <span class="n">limits</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.00</span><span class="p">,</span> <span class="mf">4.24</span><span class="p">),</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Paint molecules by a feature.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{color_by}{cmap}{limits}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">color_by</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">face_color_setter</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">info</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span>
                    <span class="n">by</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">clim</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">cmap</span>
                <span class="p">)</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="nd">@confirm</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Column already exists. Overwrite?&quot;</span><span class="p">,</span>
        <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;column_name in layer.molecules.features.columns&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">calculate_molecule_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expression</span><span class="p">:</span> <span class="n">PolarsExprStr</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a new feature from the existing features.</span>

<span class="sd">        This method is identical to running `with_columns` on the features dataframe</span>
<span class="sd">        as a `polars.DataFrame`. For example,</span>
<span class="sd">        &gt;&gt;&gt; ui.calculate_molecule_features(layer, &quot;Y&quot;, &quot;pl.col(&#39;X&#39;) + 1&quot;)</span>
<span class="sd">        is equivalent to</span>
<span class="sd">        &gt;&gt;&gt; layer.features = layer.features.with_columns([(pl.col(&quot;X&quot;) + 1).alias(&quot;Y&quot;)])</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        column_name : str</span>
<span class="sd">            Name of the new column.</span>
<span class="sd">        expression : pl.Expr or str</span>
<span class="sd">            polars expression to calculate the new column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_expr</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="n">new_feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">column_name</span><span class="p">))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_feat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>  <span class="c1"># choices regarding to features need update</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">interpolate_spline_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_spl&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add new features by interpolating spline local properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{interpolation}</span>
<span class="sd">        suffix : str, default &quot;_spl&quot;</span>
<span class="sd">            Suffix of the new feature column names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span>
        <span class="n">anc</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">anc</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">pos_nm</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">pos_nm</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">anc</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">anc</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">calculate_lattice_structure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">props</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">CheckBoxes</span><span class="p">,</span> <span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">LatticeParameters</span><span class="o">.</span><span class="n">choices</span><span class="p">()}]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;spacing&quot;</span><span class="p">,),</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate lattice structures and store the results as new feature columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        props : list of str, optional</span>
<span class="sd">            Properties to calculate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">features</span>

        <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">LatticeParameters</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>

        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">([</span><span class="n">_calculate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>  <span class="c1"># choices regarding of features need update</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">convolve_feature</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;convolve_feature&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;uifb&quot;</span><span class="p">)}],</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">footprint</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">KernelEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a convolution on the lattice.</span>

<span class="sd">        The convolution is similar to that in the context of image analysis, except for</span>
<span class="sd">        the cylindric boundary. During the convolution, the edges will not be considered,</span>
<span class="sd">        i.e., NaN value will be ignored and convolution will be the convolution of valid</span>
<span class="sd">        regions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}</span>
<span class="sd">        method : str</span>
<span class="sd">            Convolution method.</span>
<span class="sd">        {target}{footprint}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
        <span class="n">nrise</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">nrise</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">run_filter</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">footprint</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">nrise</span><span class="p">,</span> <span class="n">method</span>
        <span class="p">)</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">feature_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">match</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span><span class="p">:</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="n">color</span>
            <span class="k">case</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">clim</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">count_neighbors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">footprint</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">KernelEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
        <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;neighbor_count&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of neighbors for each molecules.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{footprint}</span>
<span class="sd">        column_name : str</span>
<span class="sd">            Name of the new column that stores the number of counts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
        <span class="n">nrise</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">nrise</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">count_neighbors</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">footprint</span><span class="p">,</span> <span class="n">nrise</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">column_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">distance_from_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
        <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new column that stores the shortest distance from the given spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{spline}</span>
<span class="sd">        interval: nm, default 1.0</span>
<span class="sd">            Sampling interval along the spline. Note that small value will increase the</span>
<span class="sd">            memory usage and computation time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`precision` must be positive.&quot;</span><span class="p">)</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
        <span class="n">npartitions</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ceilint</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span>
        <span class="n">sample_points</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npartitions</span><span class="p">))</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">)</span>
        <span class="n">dist_min</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">dist_min</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">binarize_feature</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;binarize_feature&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;uif&quot;</span><span class="p">)}],</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="s2">&quot;FloatSlider&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">larger_true</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_binarize&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binarization of a layer feature by thresholding.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{target}</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            Threshold value used for binarization.</span>
<span class="sd">        larger_true : bool, optional</span>
<span class="sd">            If true, values larger than `threshold` will be True.</span>
<span class="sd">        suffix : str, default &quot;_binarize&quot;</span>
<span class="sd">            Suffix of the new feature column name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`suffix` cannot be empty.&quot;</span><span class="p">)</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">binarize</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">larger_true</span><span class="p">:</span>
            <span class="n">ser</span> <span class="o">=</span> <span class="o">-</span><span class="n">ser</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;#A5A5A5&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;#FF0000&quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">label_feature_clusters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;label_feature_clusters&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)}],</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_label&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Label a binarized feature column based on the molecules structure.</span>

<span class="sd">        This method does the similar task as `scipy.ndimage.label`, where the isolated</span>
<span class="sd">        &quot;islands&quot; of True values will be labeled by position integers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{target}</span>
<span class="sd">        suffix : str, default &quot;_binarize&quot;</span>
<span class="sd">            Suffix of the new feature column name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">napari.utils.colormaps</span> <span class="kn">import</span> <span class="n">label_colormap</span>

        <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`suffix` cannot be empty.&quot;</span><span class="p">)</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
        <span class="n">nrise</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">nrise</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">nrise</span><span class="p">)</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">feature_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="n">label_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">label_colormap</span><span class="p">(</span><span class="n">label_max</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mf">0.9414</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">label_max</span><span class="p">),</span> <span class="n">cmap</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>

    <span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Analyze region properties&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">regionprops_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;regionprops_features&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;uif&quot;</span><span class="p">)}],</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;regionprops_features&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;ui&quot;</span><span class="p">)}],</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">RegionProfiler</span><span class="o">.</span><span class="n">CHOICES</span><span class="p">,</span> <span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">CheckBoxes</span><span class="p">}]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
    <span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze region properties using another feature column as the labels.</span>

<span class="sd">        For instance, if the target data is [0, 1, 2, 3, 4] and the labels are [0, 1, 1, 2, 2],</span>
<span class="sd">        the the property &quot;mean&quot; will be [1.5, 3.5]. For some properties such as &quot;length&quot; and</span>
<span class="sd">        &quot;width&quot;, the monomer connection will be considered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {layer}{target}</span>
<span class="sd">        label: str</span>
<span class="sd">            The feature name that will be used as the labels.</span>
<span class="sd">        properties : list of str</span>
<span class="sd">            Properties to calculate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">magicclass.ext.polars</span> <span class="kn">import</span> <span class="n">DataFrameView</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="p">[</span><span class="n">target</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">RegionProfiler</span><span class="o">.</span><span class="n">from_components</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">label</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">DataFrameView</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">add_dock_widget</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Region properties&quot;</span><span class="p">)</span>
        <span class="n">dock</span><span class="o">.</span><span class="n">setFloating</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">dock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span><span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="n">dock</span><span class="o">.</span><span class="n">show</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Non-GUI methods</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="nd">@nogui</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">add_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">molecules</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;str | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="s2">&quot;BaseComponent | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="s2">&quot;dict[str, Any]&quot;</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MoleculesLayer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add molecules as a points layer to the viewer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">add_molecules</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">,</span>
            <span class="n">molecules</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@nogui</span>
    <span class="nd">@do_not_record</span>
    <span class="k">def</span> <span class="nf">get_loader</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_shape</span><span class="p">:</span> <span class="s2">&quot;tuple[nm, nm, nm] | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubtomogramLoader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a subtomogram loader using current tomogram and a molecules layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            Name of the molecules layer.</span>
<span class="sd">        order : int, default 1</span>
<span class="sd">            Interpolation order of the subtomogram loader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">get_subtomogram_loader</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_widget_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize widget state of spline control and local properties for new plot.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_init_widget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_init_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_init_plot</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_try_removing_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ValueError: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_try_removing_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="s2">&quot;Layer | list[Layer]&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_try_removing_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_layers_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="s2">&quot;Layer | list[Layer]&quot;</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">future_func</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">layers</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pend_reset_choices</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">future_func</span>

    <span class="k">def</span> <span class="nf">_undo_callback_for_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="s2">&quot;Layer | list[Layer]&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_try_removing_layers</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_layers_future</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">def</span> <span class="nf">_send_tomogram_to_viewer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tomo</span><span class="p">:</span> <span class="n">CylTomogram</span><span class="p">,</span>
        <span class="n">filt</span><span class="p">:</span> <span class="s2">&quot;ImageFilter | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tomogram</span> <span class="o">=</span> <span class="n">tomo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GeneralInfo</span><span class="o">.</span><span class="n">_refer_tomogram</span><span class="p">(</span><span class="n">tomo</span><span class="p">)</span>

        <span class="n">bin_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tomo</span><span class="o">.</span><span class="n">multiscaled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_binsize</span> <span class="o">=</span> <span class="n">bin_size</span>
        <span class="n">imgb</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_reference_image</span><span class="p">(</span><span class="n">imgb</span><span class="p">)</span>

        <span class="c1"># update viewer dimensions</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">imgb</span><span class="o">.</span><span class="n">scale_unit</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">axis_labels</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">change_viewer_focus</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imgb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imgb</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">parts</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;…/&quot;</span> <span class="o">+</span> <span class="n">Path</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_name</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tomogram&lt;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">tomo</span><span class="p">))</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;h2&gt;</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">&lt;/h2&gt;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pend_reset_choices</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_layers</span><span class="p">()</span>

            <span class="c1"># backward compatibility</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">filt</span><span class="p">:</span>
                    <span class="n">filt</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">filt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter_reference_image</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">invert_image</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GeneralInfo</span><span class="o">.</span><span class="n">project_desc</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># clear the project description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_reference_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span>
        <span class="k">if</span> <span class="n">bin_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bin_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">_is_lazy</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">is_lazy</span> <span class="o">=</span> <span class="n">_is_lazy</span>
        <span class="k">if</span> <span class="n">_is_lazy</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="n">like</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
            <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>
        <span class="c1"># update image layer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">reset_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pend_reset_choices</span><span class="p">():</span>
                <span class="n">viewer</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">update_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">highlight</span> <span class="ow">in</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">highlight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">bounding_box</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="n">_is_lazy</span>

        <span class="c1"># update overview</span>
        <span class="k">if</span> <span class="n">_is_lazy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_on_layer_removing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s2">&quot;Event&quot;</span><span class="p">):</span>
        <span class="c1"># NOTE: To make recorded macro completely reproducible, removing molecules</span>
        <span class="c1"># from the viewer layer list must always be monitored.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># may happen during cleanup</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">MoleculesLayer</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">active</span>
            <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">PREVIEW_LAYER_NAME</span>  <span class="c1"># ignore preview layer</span>
        <span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span>
            <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_layers_future</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">append_with_undo</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">expr</span><span class="p">]),</span> <span class="n">undo</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_on_molecules_layer_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s2">&quot;Event&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;When layer name is renamed, record `ui.parent_viewer[&quot;old&quot;].name = &quot;new&quot;`&quot;&quot;&quot;</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayer</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">source</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">_undo_renaming</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">old_name</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">_old_name</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span>
        <span class="k">assert</span> <span class="n">old_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">viewer_</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">.</span><span class="n">parent_viewer</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">Head</span><span class="o">.</span><span class="n">assign</span><span class="p">,</span> <span class="p">[</span><span class="n">viewer_</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">old_name</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">append_with_undo</span><span class="p">(</span>
            <span class="n">expr</span><span class="p">,</span>
            <span class="n">undo</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="n">old_name</span><span class="p">),</span>
            <span class="n">redo</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="n">new_name</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_layer_inserted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s2">&quot;Event&quot;</span><span class="p">):</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">value</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">MoleculesLayer</span><span class="p">):</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_molecules_layer_renamed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_disconnect_layerlist_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">removing</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_layer_removing</span><span class="p">)</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_layer_inserted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_layerlist_events</span><span class="p">()</span>

        <span class="c1"># remove all the molecules layers</span>
        <span class="n">_layers_to_remove</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="n">MoleculesLayer</span><span class="p">,</span> <span class="n">LandscapeSurface</span><span class="p">)):</span>
                <span class="n">_layers_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="p">):</span>
                <span class="n">_layers_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pend_reset_choices</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_layers_to_remove</span><span class="p">:</span>
                <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">init_layers</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">to_be_removed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">viewer</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="p">)</span>
            <span class="n">viewer</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GlobalProperties</span><span class="o">.</span><span class="n">_init_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

        <span class="c1"># Connect layer events.</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">removing</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_layer_removing</span><span class="p">)</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_layer_inserted</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">_pend_reset_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Temporarily disable the reset_choices method for better performance.&quot;&quot;&quot;</span>
        <span class="n">reset_choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span> <span class="o">=</span> <span class="n">reset_choices</span>

    <span class="k">def</span> <span class="nf">_highlight_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">SplineColor</span><span class="o">.</span><span class="n">SELECTED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">SplineColor</span><span class="o">.</span><span class="n">DEFAULT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">highlight_spline</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_update_global_properties_in_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show global property values in widgets.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GlobalProperties</span><span class="o">.</span><span class="n">_set_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_update_local_properties_in_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">replot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">has_loc</span><span class="p">([</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_set_text</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_init_plot</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_init_text</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">replot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LocalProperties</span><span class="o">.</span><span class="n">_plot_properties</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_add_spline_to_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">add_curve</span><span class="p">(</span>
            <span class="n">fit</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
            <span class="n">fit</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">SplineColor</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_set_orientation_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">set_orientation</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_splines_in_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh splines in overview canvas and napari canvas.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_spline_to_images</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_anchors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span>
                <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">SplineColor</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">,</span>
                <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-anc&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_spline</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_refer_spline_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">SplineConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update GUI states that are related to global variables.&quot;&quot;&quot;</span>
        <span class="n">fgui</span> <span class="o">=</span> <span class="n">get_function_gui</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_spline_props</span><span class="p">)</span>
        <span class="n">fgui</span><span class="o">.</span><span class="n">npf</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">fgui</span><span class="o">.</span><span class="n">npf</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="n">fgui</span><span class="o">.</span><span class="n">npf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
        <span class="n">fgui</span><span class="o">.</span><span class="n">npf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># update GUI default values</span>
        <span class="n">fgui</span> <span class="o">=</span> <span class="n">get_function_gui</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">generate_molecules</span><span class="p">)</span>
        <span class="n">fgui</span><span class="o">.</span><span class="n">spacing</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">spacing_range</span><span class="o">.</span><span class="n">center</span>
        <span class="n">fgui</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">twist_range</span><span class="o">.</span><span class="n">center</span>
        <span class="n">fgui</span><span class="o">.</span><span class="n">npf</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_monomers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_monomers_with_extensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_along_pf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_along_spline</span><span class="p">]:</span>  <span class="c1"># fmt: skip</span>
            <span class="n">get_function_gui</span><span class="p">(</span><span class="n">method</span><span class="p">)[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clockwise</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="cylindra.widgets.main.CylindraMainWidget.batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch</span><span class="p">:</span> <span class="n">CylindraBatchWidget</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Return the batch analyzer.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="cylindra.widgets.main.CylindraMainWidget.default_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_config</span><span class="p">:</span> <span class="n">SplineConfig</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Default spline configuration.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="cylindra.widgets.main.CylindraMainWidget.logger" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">logger</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>The logger instance.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="cylindra.widgets.main.CylindraMainWidget.splines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">splines</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>The spline list.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="cylindra.widgets.main.CylindraMainWidget.sub_viewer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sub_viewer</span><span class="p">:</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>The sub-viewer for subtomogram averages.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="cylindra.widgets.main.CylindraMainWidget.tomogram" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tomogram</span><span class="p">:</span> <span class="n">CylTomogram</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>The current tomogram instance.</p>
    </div>

</div>



<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.add_anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_anchors</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;pack&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add anchors to splines.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval (nm) between spline anchors. Please note that resetting interval will discard
all the existing local properties.</p>
              </div>
            </td>
            <td>
                  <code>25.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>how</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to add anchors.</p>
<ul>
<li>"pack": (x———x———x—) Pack anchors from the starting point of splines.</li>
<li>"equal": (x——x——x——x) Equally distribute anchors between the starting
  point and the end point of splines. Actual intervals will be smaller.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>&#34;pack&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_anchors</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Interval between anchors (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">25.0</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pack&quot;</span><span class="p">,</span> <span class="s2">&quot;equal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pack&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add anchors to splines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{interval}</span>
<span class="sd">    how : str, default &quot;pack&quot;</span>
<span class="sd">        How to add anchors.</span>

<span class="sd">        - &quot;pack&quot;: (x———x———x—) Pack anchors from the starting point of splines.</span>
<span class="sd">        - &quot;equal&quot;: (x——x——x——x) Equally distribute anchors between the starting</span>
<span class="sd">          point and the end point of splines. Actual intervals will be smaller.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">how</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;pack&quot;</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">splines</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">splines</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.add_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_molecules</span><span class="p">(</span><span class="n">molecules</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add molecules as a points layer to the viewer.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@nogui</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">add_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">molecules</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;str | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="s2">&quot;BaseComponent | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="s2">&quot;dict[str, Any]&quot;</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MoleculesLayer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add molecules as a points layer to the viewer.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">add_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">,</span>
        <span class="n">molecules</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.add_multiscale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_multiscale</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add a new multi-scale image of current tomogram.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of the new image</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add multi-scale&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
<span class="nd">@dask_thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">bin_size</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Adding multiscale (bin = </span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
<span class="k">def</span> <span class="nf">add_multiscale</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">))}]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a new multi-scale image of current tomogram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bin_size : int, default 4</span>
<span class="sd">        Bin size of the new image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">tomo</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_multiscale</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.align_to_polarity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">align_to_polarity</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;MinusToPlus&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Align all the splines in the direction parallel to the cylinder polarity.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>orientation</code></td>
            <td>
                  <code><span title="cylindra.const.Ori">Ori</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>To which direction splines will be aligned.</p>
              </div>
            </td>
            <td>
                  <code>Ori.MinusToPlus</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Orientation</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">align_to_polarity</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;MinusToPlus&quot;</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MinusToPlus&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align all the splines in the direction parallel to the cylinder polarity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orientation : Ori, default Ori.MinusToPlus</span>
<span class="sd">        To which direction splines will be aligned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">need_resample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">need_resample</span>
    <span class="n">_old_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">align_to_polarity</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">need_resample</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">_new_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">)</span>
        <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">_old_orientations</span><span class="p">,</span> <span class="n">need_resample</span><span class="p">)</span>
        <span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">(</span><span class="n">_new_orientations</span><span class="p">))</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.binarize_feature" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">binarize_feature</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">larger_true</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_binarize&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Binarization of a layer feature by thresholding.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>target</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target column name on which calculation will run.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>threshold</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold value used for binarization.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>larger_true</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, values larger than <code>threshold</code> will be True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>suffix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suffix of the new feature column name.</p>
              </div>
            </td>
            <td>
                  <code>&#34;_binarize&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">binarize_feature</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;binarize_feature&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;uif&quot;</span><span class="p">)}],</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="s2">&quot;FloatSlider&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">larger_true</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_binarize&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Binarization of a layer feature by thresholding.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{target}</span>
<span class="sd">    threshold : float, optional</span>
<span class="sd">        Threshold value used for binarization.</span>
<span class="sd">    larger_true : bool, optional</span>
<span class="sd">        If true, values larger than `threshold` will be True.</span>
<span class="sd">    suffix : str, default &quot;_binarize&quot;</span>
<span class="sd">        Suffix of the new feature column name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`suffix` cannot be empty.&quot;</span><span class="p">)</span>
    <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">binarize</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">larger_true</span><span class="p">:</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="o">-</span><span class="n">ser</span>
    <span class="n">feature_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span>
        <span class="n">ser</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;#A5A5A5&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;#FF0000&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.calculate_lattice_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_lattice_structure</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;spacing&#39;</span><span class="p">))</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate lattice structures and store the results as new feature columns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>props</code></td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Properties to calculate.</p>
              </div>
            </td>
            <td>
                  <code>(&#39;spacing&#39;)</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">calculate_lattice_structure</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">props</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">CheckBoxes</span><span class="p">,</span> <span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">LatticeParameters</span><span class="o">.</span><span class="n">choices</span><span class="p">()}]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;spacing&quot;</span><span class="p">,),</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lattice structures and store the results as new feature columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    props : list of str, optional</span>
<span class="sd">        Properties to calculate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">feat</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">LatticeParameters</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>

    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">([</span><span class="n">_calculate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>  <span class="c1"># choices regarding of features need update</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.calculate_molecule_features" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_molecule_features</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate a new feature from the existing features.</p>
<p>This method is identical to running <code>with_columns</code> on the features dataframe
as a <code>polars.DataFrame</code>. For example,
<div class="highlight"><pre><span></span><code><span class="n">ui</span><span class="o">.</span><span class="n">calculate_molecule_features</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;pl.col(&#39;X&#39;) + 1&quot;</span><span class="p">)</span>
</code></pre></div>
is equivalent to
<div class="highlight"><pre><span></span><code><span class="n">layer</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)])</span>
</code></pre></div></p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>column_name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the new column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>expression</code></td>
            <td>
                  <code><span title="polars.Expr">Expr</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>polars expression to calculate the new column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="nd">@confirm</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Column already exists. Overwrite?&quot;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;column_name in layer.molecules.features.columns&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">calculate_molecule_features</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expression</span><span class="p">:</span> <span class="n">PolarsExprStr</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a new feature from the existing features.</span>

<span class="sd">    This method is identical to running `with_columns` on the features dataframe</span>
<span class="sd">    as a `polars.DataFrame`. For example,</span>
<span class="sd">    &gt;&gt;&gt; ui.calculate_molecule_features(layer, &quot;Y&quot;, &quot;pl.col(&#39;X&#39;) + 1&quot;)</span>
<span class="sd">    is equivalent to</span>
<span class="sd">    &gt;&gt;&gt; layer.features = layer.features.with_columns([(pl.col(&quot;X&quot;) + 1).alias(&quot;Y&quot;)])</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    column_name : str</span>
<span class="sd">        Name of the new column.</span>
<span class="sd">    expression : pl.Expr or str</span>
<span class="sd">        polars expression to calculate the new column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">feat</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_expr</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
    <span class="n">new_feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">column_name</span><span class="p">))</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">new_feat</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>  <span class="c1"># choices regarding to features need update</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.clear_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_all</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Clear all the splines and results.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s2">&quot;material-symbols:bomb&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">Toolbar</span><span class="p">)</span>
<span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Are you sure to clear all?</span><span class="se">\n</span><span class="s2">You cannot undo this.&quot;</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear all the splines and results.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_layers</span><span class="p">()</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.clear_current" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_current</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Clear current selection.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s2">&quot;solar:eraser-bold&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">Toolbar</span><span class="p">)</span>
<span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Spline has properties. Are you sure to delete it?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">_confirm_delete</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
<span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clear_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear current selection.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.clip_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clip_spline</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Clip selected spline at its edges by given lengths.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>spline</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of spline to be clipped.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lengths</code></td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The length in nm to be clipped at the start and end of the spline.</p>
              </div>
            </td>
            <td>
                  <code>(0., 0.)</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+X&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clip_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
    <span class="n">lengths</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;clip length (nm)&quot;</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip selected spline at its edges by given lengths.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spline : int</span>
<span class="sd">        The ID of spline to be clipped.</span>
<span class="sd">    lengths : tuple of float, default (0., 0.)</span>
<span class="sd">        The length in nm to be clipped at the start and end of the spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="n">_old_spl</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="c1"># current layer will be removed. Select another layer.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="p">}</span>

    <span class="nd">@undo_callback</span>
    <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">_old_spl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.concatenate_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">concatenate_molecules</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Mole-concat&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Concatenate selected molecules and create a new ones.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layers</code></td>
            <td>
                  <code>list of MoleculesLayer</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>All the points layers of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the new molecules layer.</p>
              </div>
            </td>
            <td>
                  <code>&#34;Mole-concat&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Combine</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">concatenate_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mole-concat&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate selected molecules and create a new ones.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layers}</span>
<span class="sd">    name : str, default &quot;Mole-concat&quot;</span>
<span class="sd">        Name of the new molecules layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">all_molecules</span> <span class="o">=</span> <span class="n">Molecules</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">add_molecules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">,</span> <span class="n">all_molecules</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># logging</span>
    <span class="n">layer_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">layer_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;concatenate_molecules&lt;/code&gt;&quot;</span><span class="p">)</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Concatenated:&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layer_names</span><span class="p">))</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">points</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_molecules</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.convolve_feature" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convolve_feature</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Run a convolution on the lattice.</p>
<p>The convolution is similar to that in the context of image analysis, except for
the cylindric boundary. During the convolution, the edges will not be considered,
i.e., NaN value will be ignored and convolution will be the convolution of valid
regions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>method</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Convolution method.</p>
              </div>
            </td>
            <td>
                  <code>&#39;mean&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>target</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target column name on which calculation will run.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>footprint</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>2D binary array that define the convolution kernel structure.</p>
              </div>
            </td>
            <td>
                  <code>[[0, 1, 0], [1, 1, 1], [0, 1, 0]]</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">convolve_feature</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;convolve_feature&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;uifb&quot;</span><span class="p">)}],</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">footprint</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">KernelEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a convolution on the lattice.</span>

<span class="sd">    The convolution is similar to that in the context of image analysis, except for</span>
<span class="sd">    the cylindric boundary. During the convolution, the edges will not be considered,</span>
<span class="sd">    i.e., NaN value will be ignored and convolution will be the convolution of valid</span>
<span class="sd">    regions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    method : str</span>
<span class="sd">        Convolution method.</span>
<span class="sd">    {target}{footprint}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
    <span class="n">nrise</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">nrise</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">run_filter</span><span class="p">(</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">footprint</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">nrise</span><span class="p">,</span> <span class="n">method</span>
    <span class="p">)</span>
    <span class="n">feature_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">feature_name</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="k">match</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span><span class="p">:</span>
        <span class="k">case</span> <span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">case</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">clim</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.copy_molecules_features" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy_molecules_features</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destinations</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Copy molecules features from one layer to another.</p>
<p>This method is useful when a layer feature (such as seam search result) should be
shared by multiple molecules layers that were aligned in a different parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>source</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Layer whose features will be copied.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>destinations</code></td>
            <td>
                  <code><span title="cylindra.widgets._annotated.MoleculesLayersType">MoleculesLayersType</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>To which layers the features should be copied.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>column</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name of the feature to be copied.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>alias</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If given, the copied feature will be renamed to this name.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Combine</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">copy_molecules_features</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">destinations</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
    <span class="n">column</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;copy_molecules_features&quot;</span><span class="p">)}],</span>
    <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy molecules features from one layer to another.</span>

<span class="sd">    This method is useful when a layer feature (such as seam search result) should be</span>
<span class="sd">    shared by multiple molecules layers that were aligned in a different parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : MoleculesLayer</span>
<span class="sd">        Layer whose features will be copied.</span>
<span class="sd">    destinations : MoleculesLayersType</span>
<span class="sd">        To which layers the features should be copied.</span>
<span class="sd">    column : str</span>
<span class="sd">        Column name of the feature to be copied.</span>
<span class="sd">    alias : str, optional</span>
<span class="sd">        If given, the copied feature will be renamed to this name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">destinations</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">destinations</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">([</span><span class="n">series</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.copy_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy_spline</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Make a copy of the current spline</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">copy_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a copy of the current spline&quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.copy_spline_new_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy_spline_new_config</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">npf_range</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="n">spacing_range</span><span class="o">=</span><span class="p">(</span><span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">),</span> <span class="n">twist_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">rise_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">),</span> <span class="n">rise_sign</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">clockwise</span><span class="o">=</span><span class="s1">&#39;MinusToPlus&#39;</span><span class="p">,</span> <span class="n">thickness_inner</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">thickness_outer</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">fit_depth</span><span class="o">=</span><span class="mf">49.0</span><span class="p">,</span> <span class="n">fit_width</span><span class="o">=</span><span class="mf">44.0</span><span class="p">,</span> <span class="n">copy_props</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Make a copy of the current spline with a new configuration.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Copy spline (new config)&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">copy_spline_new_config</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}],</span>
    <span class="n">npf_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
    <span class="n">spacing_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">),</span>
    <span class="n">twist_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">rise_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">),</span>
    <span class="n">rise_sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">clockwise</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">,</span>
    <span class="n">thickness_inner</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">2.8</span><span class="p">,</span>
    <span class="n">thickness_outer</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">2.8</span><span class="p">,</span>
    <span class="n">fit_depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">49.0</span><span class="p">,</span>
    <span class="n">fit_width</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">44.0</span><span class="p">,</span>
    <span class="n">copy_props</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a copy of the current spline with a new configuration.&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;copy_props&quot;</span><span class="p">]</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">spl_new</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">copy_props</span><span class="o">=</span><span class="n">copy_props</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_new</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.count_neighbors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">count_neighbors</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">column_name</span><span class="o">=</span><span class="s1">&#39;neighbor_count&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Count the number of neighbors for each molecules.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>footprint</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>2D binary array that define the convolution kernel structure.</p>
              </div>
            </td>
            <td>
                  <code>[[0, 1, 0], [1, 0, 1], [0, 1, 0]]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>column_name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the new column that stores the number of counts.</p>
              </div>
            </td>
            <td>
                  <code>&#39;neighbor_count&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">count_neighbors</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">footprint</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">KernelEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;neighbor_count&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count the number of neighbors for each molecules.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{footprint}</span>
<span class="sd">    column_name : str</span>
<span class="sd">        Name of the new column that stores the number of counts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
    <span class="n">nrise</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">nrise</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">count_neighbors</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">footprint</span><span class="p">,</span> <span class="n">nrise</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">column_name</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.delete_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_molecules</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Delete molecules by the layer names.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>include</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Delete layers whose names contain this string.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>exclude</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Delete layers whose names do not contain this string.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pattern</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String pattern to match the layer names. Use <code>*</code> as wildcard.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Delete molecule layers&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete molecules by the layer names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    include : str, optional</span>
<span class="sd">        Delete layers whose names contain this string.</span>
<span class="sd">    exclude : str, optional</span>
<span class="sd">        Delete layers whose names do not contain this string.</span>
<span class="sd">    pattern : str, optional</span>
<span class="sd">        String pattern to match the layer names. Use `*` as wildcard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.delete_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_spline</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Delete currently selected spline.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
<span class="nd">@confirm</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Spline has properties. Are you sure to delete it?&quot;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">_confirm_delete</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete currently selected spline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

    <span class="c1"># update layer</span>
    <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">features</span>
    <span class="n">old_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">select_spline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">need_resample</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>

    <span class="nd">@undo_callback</span>
    <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">old_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_spline_to_images</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.distance_from_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distance_from_spline</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">spline</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add a new column that stores the shortest distance from the given spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>spline</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of splines to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sampling interval along the spline. Note that small value will increase the
memory usage and computation time.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">distance_from_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
    <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a new column that stores the shortest distance from the given spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{spline}</span>
<span class="sd">    interval: nm, default 1.0</span>
<span class="sd">        Sampling interval along the spline. Note that small value will increase the</span>
<span class="sd">        memory usage and computation time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`precision` must be positive.&quot;</span><span class="p">)</span>
    <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
    <span class="n">npartitions</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ceilint</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">sample_points</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npartitions</span><span class="p">))</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">)</span>
    <span class="n">dist_min</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">dist_min</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.drop_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">drop_molecules</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inherit_source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Drop a subset of molecules from a molecules layer by indices.</p>
<p>Note that the indices start from 0. <code>ui.drop_molecules(layer, [0, 2, 6])</code> will
drop 0th, 2nd, and 6th molecules.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>indices</code></td>
            <td>
                  <code>str, int, slice or sequence of int or slice</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of molecule indices to drop. You can use <code>npf</code> for the number
of protofilaments and <code>N</code> for the number of molecules. <code>slice</code> is also
allowed for dropping a range of indices. In GUI, this parameter must a
string of comma-separated integers/slices (e.g. <code>3, N - 3</code>,
<code>1, slice(12, 12 + npf)</code>).</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>inherit_source</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True and the input molecules layer has its spline source, the new layer will inherit it.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">drop_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">IndexEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop a subset of molecules from a molecules layer by indices.</span>

<span class="sd">    Note that the indices start from 0. `ui.drop_molecules(layer, [0, 2, 6])` will</span>
<span class="sd">    drop 0th, 2nd, and 6th molecules.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    indices : str, int, slice or sequence of int or slice, optional</span>
<span class="sd">        A sequence of molecule indices to drop. You can use `npf` for the number</span>
<span class="sd">        of protofilaments and `N` for the number of molecules. `slice` is also</span>
<span class="sd">        allowed for dropping a range of indices. In GUI, this parameter must a</span>
<span class="sd">        string of comma-separated integers/slices (e.g. `3, N - 3`,</span>
<span class="sd">        `1, slice(12, 12 + npf)`).</span>
<span class="sd">    {inherit_source}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">_to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spl</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">:</span>
            <span class="n">npf</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">IndexEdit</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">npf</span><span class="o">=</span><span class="n">npf</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">_to_drop</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">_to_drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indices must be integers, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_to_drop</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Drop&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.filter_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_molecules</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">inherit_source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Filter molecules by their features.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>predicate</code></td>
            <td>
                  <code>ExprStr</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A polars-style filter predicate, such as <code>pl.col("pf-id") == 3</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>inherit_source</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True and the input molecules layer has its spline source, the new layer will inherit it.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">filter_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">predicate</span><span class="p">:</span> <span class="n">PolarsExprStr</span><span class="p">,</span>
    <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter molecules by their features.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    predicate : ExprStr</span>
<span class="sd">        A polars-style filter predicate, such as `pl.col(&quot;pf-id&quot;) == 3`</span>
<span class="sd">    {inherit_source}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_expr</span><span class="p">(</span><span class="n">predicate</span><span class="p">))</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Filt&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.filter_reference_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_reference_image</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Apply filter to enhance contrast of the reference image.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
<span class="nd">@dask_thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="n">_pdesc</span><span class="o">.</span><span class="n">filter_image_fmt</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">filter_reference_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">ImageFilter</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply filter to enhance contrast of the reference image.&quot;&quot;&quot;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">is_dummy</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">set_gpu</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image_data</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
        <span class="n">_tiled</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">tiled</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.6</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">match</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">:</span>
                <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">lowpass_filter</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">:</span>
                <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">fourier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">DoG</span><span class="p">:</span>
                <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">dog_filter</span><span class="p">(</span><span class="n">low_sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">fourier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">LoG</span><span class="p">:</span>
                <span class="n">img_filt</span> <span class="o">=</span> <span class="n">_tiled</span><span class="o">.</span><span class="n">log_filter</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No method matches </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">fast_percentile</span><span class="p">(</span><span class="n">img_filt</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">])</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">def</span> <span class="nf">_filter_reference_image_on_return</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">img_filt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">contrast_limits</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">contrast_limits</span>

    <span class="n">t0</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_filter_reference_image_on_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.fit_splines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_splines</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">degree_precision</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edge_sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">max_shift</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit splines to the cylinder by auto-correlation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval (nm) between spline anchors.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>err_max</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>S.D. allowed for spline fitting. Larger value will result in smoother spline, i.e. fewer spline knots.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>degree_precision</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Precision of xy-tilt degree in angular correlation.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>edge_sigma</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Check if cylindric structures are densely packed. Initial spline position
must be "almost" fitted in dense mode.</p>
              </div>
            </td>
            <td>
                  <code>2.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_shift</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum shift to be applied to each point of splines.</p>
              </div>
            </td>
            <td>
                  <code>5.0</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Fitting</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Spline Fitting&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fit_splines</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max interval (nm)&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">degree_precision</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">edge_sigma</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not mask image&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;edge σ&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit splines to the cylinder by auto-correlation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{max_interval}{bin_size}{err_max}</span>
<span class="sd">    degree_precision : float, default 0.5</span>
<span class="sd">        Precision of xy-tilt degree in angular correlation.</span>
<span class="sd">    edge_sigma : bool, default 2.0</span>
<span class="sd">        Check if cylindric structures are densely packed. Initial spline position</span>
<span class="sd">        must be &quot;almost&quot; fitted in dense mode.</span>
<span class="sd">    max_shift : nm, default 5.0</span>
<span class="sd">        Maximum shift to be applied to each point of splines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">,</span>
                <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                <span class="n">degree_precision</span><span class="o">=</span><span class="n">degree_precision</span><span class="p">,</span>
                <span class="n">edge_sigma</span><span class="o">=</span><span class="n">edge_sigma</span><span class="p">,</span>
                <span class="n">max_shift</span><span class="o">=</span><span class="n">max_shift</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">)</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.fit_splines_by_centroid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_splines_by_centroid</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_shift</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit splines to the cylinder by centroid of sub-volumes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval (nm) between spline anchors.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>err_max</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>S.D. allowed for spline fitting. Larger value will result in smoother spline, i.e. fewer spline knots.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_shift</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum shift to be applied to each point of splines.</p>
              </div>
            </td>
            <td>
                  <code>5.0</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Fitting</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Spline Fitting&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fit_splines_by_centroid</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max interval (nm)&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit splines to the cylinder by centroid of sub-volumes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{max_interval}{bin_size}{err_max}</span>
<span class="sd">    max_shift : nm, default 5.0</span>
<span class="sd">        Maximum shift to be applied to each point of splines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">fit_centroid</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">,</span>
                <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                <span class="n">max_shift</span><span class="o">=</span><span class="n">max_shift</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">)</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.get_loader" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_loader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a subtomogram loader using current tomogram and a molecules layer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the molecules layer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>order</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interpolation order of the subtomogram loader.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@nogui</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">get_loader</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_shape</span><span class="p">:</span> <span class="s2">&quot;tuple[nm, nm, nm] | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubtomogramLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a subtomogram loader using current tomogram and a molecules layer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        Name of the molecules layer.</span>
<span class="sd">    order : int, default 1</span>
<span class="sd">        Interpolation order of the subtomogram loader.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">molecules</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">get_subtomogram_loader</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.global_cft_analysis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">global_cft_analysis</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Determine cylindrical global structural parameters by Fourier transformation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Global CFT analysis&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span>
    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Global Cylindric Fourier transform&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">global_cft_analysis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine cylindrical global structural parameters by Fourier transformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{bin_size}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">measure_radius</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">global_cft_params</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">)</span>
            <span class="k">yield</span>

        <span class="c1"># show all in a table</span>
        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_global_cft_analysis_on_return</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">],</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical_relaxed&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_properties_in_widget</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_global_cft_analysis_on_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.infer_polarity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">infer_polarity</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Automatically detect the cylinder polarities.</p>
<p>This function uses Fourier vorticity to detect the polarities of the splines.
The subtomogram at the center of the spline will be sampled in the cylindric
coordinate and the power spectra in (radius, angle) space will be calculated.
The peak position of the <code>angle = nPF</code> line scan will be used to detect the
polarity of the spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>depth</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depth (length parallel to the spline tangent) of the subtomograms to be sampled.</p>
              </div>
            </td>
            <td>
                  <code>40</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Orientation</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Auto-detecting polarities...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">infer_polarity</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatically detect the cylinder polarities.</span>

<span class="sd">    This function uses Fourier vorticity to detect the polarities of the splines.</span>
<span class="sd">    The subtomogram at the center of the spline will be sampled in the cylindric</span>
<span class="sd">    coordinate and the power spectra in (radius, angle) space will be calculated.</span>
<span class="sd">    The peak position of the `angle = nPF` line scan will be used to detect the</span>
<span class="sd">    polarity of the spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{depth}{bin_size}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">_old_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">):</span>
        <span class="n">tomo</span><span class="o">.</span><span class="n">infer_polarity</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">yield</span>
    <span class="n">_new_orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">]</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">def</span> <span class="nf">_on_return</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_update_canvas</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">_old_orientations</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientations</span><span class="p">(</span><span class="n">_new_orientations</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">_on_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.interpolate_spline_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">interpolate_spline_properties</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_spl&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add new features by interpolating spline local properties.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>interpolation</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interpolation order.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>suffix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suffix of the new feature column names.</p>
              </div>
            </td>
            <td>
                  <code>&#34;_spl&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">interpolate_spline_properties</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_spl&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add new features by interpolating spline local properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{interpolation}</span>
<span class="sd">    suffix : str, default &quot;_spl&quot;</span>
<span class="sd">        Suffix of the new feature column names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">feat</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span>
    <span class="n">anc</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
        <span class="n">anc</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">pos_nm</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">pos_nm</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">anc</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">anc</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.invert_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invert_image</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Invert the intensity of the images.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Inverting image&quot;</span><span class="p">)</span>
<span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">invert_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Invert the intensity of the images.&quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">is_lazy</span><span class="p">:</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_invert_image_on_return</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invert_image</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">img_inv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">fast_percentile</span><span class="p">(</span><span class="n">img_inv</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cmin</span> <span class="o">&gt;=</span> <span class="n">cmax</span><span class="p">:</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">cmin</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">_invert_image_on_return</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">img_inv</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="p">)</span>
            <span class="n">clow</span><span class="p">,</span> <span class="n">chigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">contrast_limits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">contrast_limits</span> <span class="o">=</span> <span class="o">-</span><span class="n">chigh</span><span class="p">,</span> <span class="o">-</span><span class="n">clow</span>
            <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invert_image</span><span class="p">)</span>

    <span class="n">t0</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_invert_image_on_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.invert_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invert_spline</span><span class="p">(</span><span class="n">spline</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Invert current displayed spline <strong>in place</strong>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>spline</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of splines to be inverted.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Orientation</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">invert_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invert current displayed spline **in place**.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spline : int, optional</span>
<span class="sd">        ID of splines to be inverted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>

    <span class="n">need_resample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">need_resample</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">need_resample</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation_marker</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invert_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.label_feature_clusters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">label_feature_clusters</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_label&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Label a binarized feature column based on the molecules structure.</p>
<p>This method does the similar task as <code>scipy.ndimage.label</code>, where the isolated
"islands" of True values will be labeled by position integers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>target</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target column name on which calculation will run.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>suffix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suffix of the new feature column name.</p>
              </div>
            </td>
            <td>
                  <code>&#34;_binarize&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">label_feature_clusters</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;label_feature_clusters&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)}],</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_label&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Label a binarized feature column based on the molecules structure.</span>

<span class="sd">    This method does the similar task as `scipy.ndimage.label`, where the isolated</span>
<span class="sd">    &quot;islands&quot; of True values will be labeled by position integers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{target}</span>
<span class="sd">    suffix : str, default &quot;_binarize&quot;</span>
<span class="sd">        Suffix of the new feature column name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">napari.utils.colormaps</span> <span class="kn">import</span> <span class="n">label_colormap</span>

    <span class="kn">from</span> <span class="nn">cylindra</span> <span class="kn">import</span> <span class="n">cylfilters</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`suffix` cannot be empty.&quot;</span><span class="p">)</span>
    <span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
    <span class="n">nrise</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">nrise</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">cylfilters</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">nrise</span><span class="p">)</span>
    <span class="n">feature_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">feature_name</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="n">label_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">label_colormap</span><span class="p">(</span><span class="n">label_max</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mf">0.9414</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">label_max</span><span class="p">),</span> <span class="n">cmap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">feature_setter</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">cmap_info</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.load_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_molecules</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load molecules from a csv file.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Multiple</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">MOLE</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load molecules from a csv file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
    <span class="n">moles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Molecules</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mole</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">moles</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="n">add_molecules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.load_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_project</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span> <span class="n">read_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_config</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load a project file (project.json, tar file or zip file).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>path</code></td>
            <td>
                  <code>path - like or <a class="autorefs autorefs-internal" title="cylindra.project.CylindraProject" href="../../project/#cylindra.project.CylindraProject">CylindraProject</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the project file, or the project directory that contains a project
file, or a CylindraProject object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>filter</code></td>
            <td>
                  <code><span title="cylindra.const.ImageFilter">ImageFilter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filter to be applied to the reference image. This does not affect the image data itself.</p>
<ul>
<li>Lowpass: butterworth low-pass filter.</li>
<li>Gaussian: Gaussian blur.</li>
<li>DoG: difference of Gaussian.</li>
<li>LoG: Laplacian of Gaussian.</li>
</ul>
              </div>
            </td>
            <td>
                  <code><span title="cylindra.const.ImageFilter.Lowpass">Lowpass</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>read_image</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to read image data from the project directory. If false, image data
will be memory-mapped and will not be shown in the viewer. Unchecking this
is useful to decrease loading time.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>update_config</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to update the default spline configuration with the one described
in the project.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Reading project&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;You may have unsaved data. Open a new project?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;self._need_save&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
<span class="nd">@do_not_record</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+P&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_project</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">],</span>
    <span class="nb">filter</span><span class="p">:</span> <span class="n">ImageFilter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span>
    <span class="n">read_image</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;read image data&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">update_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a project file (project.json, tar file or zip file).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : path-like or CylindraProject</span>
<span class="sd">        Path to the project file, or the project directory that contains a project</span>
<span class="sd">        file, or a CylindraProject object.</span>
<span class="sd">    {filter}</span>
<span class="sd">    read_image : bool, default True</span>
<span class="sd">        Whether to read image data from the project directory. If false, image data</span>
<span class="sd">        will be memory-mapped and will not be shown in the viewer. Unchecking this</span>
<span class="sd">        is useful to decrease loading time.</span>
<span class="sd">    update_config : bool, default False</span>
<span class="sd">        Whether to update the default spline configuration with the one described</span>
<span class="sd">        in the project.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">CylindraProject</span><span class="p">):</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">project_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">CylindraProject</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">project_path</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;ui.load_project(&#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;filter=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">read_image</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">update_config</span><span class="si">=}</span><span class="s2">)&lt;/code&gt;&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">project_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project loaded: </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="o">=</span> <span class="n">project_path</span>
    <span class="k">yield from</span> <span class="n">project</span><span class="o">.</span><span class="n">_to_gui</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="n">read_image</span><span class="o">=</span><span class="n">read_image</span><span class="p">,</span>
        <span class="n">update_config</span><span class="o">=</span><span class="n">update_config</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.load_project_for_reanalysis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_project_for_reanalysis</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load a project file to re-analyze the data.</p>
<p>This method will extract the first manual operations from a project file and
run them. This is useful when you want to re-analyze the data with a different
parameter set, or when there were some improvements in cylindra.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Re-analyze project&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+L&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_project_for_reanalysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a project file to re-analyze the data.</span>

<span class="sd">    This method will extract the first manual operations from a project file and</span>
<span class="sd">    run them. This is useful when you want to re-analyze the data with a different</span>
<span class="sd">    parameter set, or when there were some improvements in cylindra.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reanalysis_macro</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">macro</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.load_splines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_splines</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load splines from a list of json paths.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>paths</code></td>
            <td>
                  <code>list of path-like objects</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Paths to json files that describe spline parameters in the correct format.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_splines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Multiple</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">JSON</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load splines from a list of json paths.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    paths : list of path-like objects</span>
<span class="sd">        Paths to json files that describe spline parameters in the correct format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="p">[</span><span class="n">CylSpline</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.local_cft_analysis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_cft_analysis</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">update_glob</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Determine local lattice parameters by local cylindric Fourier transformation.</p>
<p>This method will sample subtomograms at given intervals and calculate the power
spectra in a cylindrical coordinate. The peak position of the power spectra will
used to determine the lattice parameters. Note that if the interval differs from
the current spline anchors, the old local properties will be dropped.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval (nm) between spline anchors. Please note that resetting interval will discard
all the existing local properties.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>depth</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depth (length parallel to the spline tangent) of the subtomograms to be sampled.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>radius</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If "local", use the local radius for the analysis. If "global", use the
global radius.</p>
              </div>
            </td>
            <td>
                  <code>&#34;global&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>update_glob</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, also update the global property to the mean of local properties.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Local CFT analysis&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Local Cylindric Fourier transform&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
<span class="k">def</span> <span class="nf">local_cft_analysis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">_Interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span>
    <span class="n">update_glob</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Also update the global properties&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine local lattice parameters by local cylindric Fourier transformation.</span>

<span class="sd">    This method will sample subtomograms at given intervals and calculate the power</span>
<span class="sd">    spectra in a cylindrical coordinate. The peak position of the power spectra will</span>
<span class="sd">    used to determine the lattice parameters. Note that if the interval differs from</span>
<span class="sd">    the current spline anchors, the old local properties will be dropped.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{interval}{depth}{bin_size}</span>
<span class="sd">    radius : str, default &quot;global&quot;</span>
<span class="sd">        If &quot;local&quot;, use the local radius for the analysis. If &quot;global&quot;, use the</span>
<span class="sd">        global radius.</span>
<span class="sd">    {update_glob}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>

    <span class="c1"># first check radius</span>
    <span class="k">match</span> <span class="n">radius</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Global Radius of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-th spline is not measured yet. Please &quot;</span>
                        <span class="s2">&quot;measure the radius first from `Analysis &gt; Radius`.&quot;</span>
                    <span class="p">)</span>
        <span class="k">case</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">has_loc</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Local Radius of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-th spline is not measured yet. Please &quot;</span>
                        <span class="s2">&quot;measure the radius first from `Analysis &gt; Radius`.&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;With `interval`, local radius values will be dropped. Please &quot;</span>
                    <span class="s2">&quot;set `radius=&#39;global&#39;` or `interval=None`.&quot;</span>
                <span class="p">)</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;radius must be &#39;local&#39; or &#39;global&#39;, got </span><span class="si">{</span><span class="n">radius</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">def</span> <span class="nf">_local_cft_analysis_on_yield</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">num</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">local_cft_params</span><span class="p">(</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                <span class="n">update_glob</span><span class="o">=</span><span class="n">update_glob</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">_local_cft_analysis_on_yield</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.map_along_pf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_along_pf</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">molecule_interval</span><span class="o">=</span><span class="s2">&quot;col(&#39;spacing&#39;)&quot;</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;PF&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Map molecules along the line of a protofilament.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>spline</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of splines to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>molecule_interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval (nm) between molecules.
<code>col</code> is available in this namespace to refer to the spline global properties.
For example, <code>col('spacing') * 2</code> means twice the spacing of the spline.</p>
              </div>
            </td>
            <td>
                  <code>&#34;col(&#39;spacing&#39;)&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>offsets</code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Offset values that will be used to define molecule positions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>orientation</code></td>
            <td>
                  <code>(None, PlusToMinus, MinusToPlus)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of molecules' y-axis. If none, use the
current spline orientation as is.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prefix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix of the new molecules layer(s).</p>
              </div>
            </td>
            <td>
                  <code>&#39;PF&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Map alogn PF&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_along_pf</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
    <span class="n">molecule_interval</span><span class="p">:</span> <span class="n">PolarsExprStrOrScalar</span> <span class="o">=</span> <span class="s2">&quot;col(&#39;spacing&#39;)&quot;</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="n">_OffsetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PF&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map molecules along the line of a protofilament.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {spline}{molecule_interval}{offsets}{orientation}{prefix}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">interv_expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_scalar_expr</span><span class="p">(</span><span class="n">molecule_interval</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;map_along_PF&lt;/code&gt;&quot;</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_pf_line</span><span class="p">(</span>
        <span class="n">i</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">interv_expr</span><span class="p">),</span>
        <span class="n">offsets</span><span class="o">=</span><span class="n">normalize_offsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
        <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spline</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.map_along_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_along_spline</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">molecule_interval</span><span class="o">=</span><span class="s2">&quot;col(&#39;spacing&#39;)&quot;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotate_molecules</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Map molecules along splines. Each molecule is rotated by skewing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>molecule_interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval (nm) between molecules.
<code>col</code> is available in this namespace to refer to the spline global properties.
For example, <code>col('spacing') * 2</code> means twice the spacing of the spline.</p>
              </div>
            </td>
            <td>
                  <code>&#34;col(&#39;spacing&#39;)&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>orientation</code></td>
            <td>
                  <code>(None, PlusToMinus, MinusToPlus)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of molecules' y-axis. If none, use the
current spline orientation as is.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>rotate_molecules</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, rotate molecules by the "twist" parameter of each spline.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prefix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix of the new molecules layer(s).</p>
              </div>
            </td>
            <td>
                  <code>&#39;Center&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_along_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">molecule_interval</span><span class="p">:</span> <span class="n">PolarsExprStrOrScalar</span> <span class="o">=</span> <span class="s2">&quot;col(&#39;spacing&#39;)&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rotate_molecules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Center&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map molecules along splines. Each molecule is rotated by skewing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{molecule_interval}{orientation}</span>
<span class="sd">    rotate_molecules : bool, default True</span>
<span class="sd">        If True, rotate molecules by the &quot;twist&quot; parameter of each spline.</span>
<span class="sd">    {prefix}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">interv_expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_scalar_expr</span><span class="p">(</span><span class="n">molecule_interval</span><span class="p">)</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;map_along_spline&lt;/code&gt;&quot;</span><span class="p">)</span>
    <span class="n">_added_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">interv</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">interv_expr</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_centers</span><span class="p">(</span>
            <span class="n">i</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interv</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
            <span class="n">rotate_molecules</span><span class="o">=</span><span class="n">rotate_molecules</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
        <span class="n">_added_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">_added_layers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.map_monomers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_monomers</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Mole&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Map monomers as a regular cylindric grid assembly.</p>
<p>This method uses the spline global properties.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>orientation</code></td>
            <td>
                  <code>(None, PlusToMinus, MinusToPlus)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of molecules' y-axis. If none, use the
current spline orientation as is.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>offsets</code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Offset values that will be used to define molecule positions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>radius</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Radius of the cylinder to position monomers.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>extensions</code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of molecules to extend. Should be a tuple of (prepend, append).
Negative values will remove molecules.</p>
              </div>
            </td>
            <td>
                  <code>(0, 0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prefix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix of the new molecules layer(s).</p>
              </div>
            </td>
            <td>
                  <code>&#39;Mole&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Mapping monomers&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_monomers</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="n">_OffsetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extensions</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mole&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map monomers as a regular cylindric grid assembly.</span>

<span class="sd">    This method uses the spline global properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{orientation}{offsets}</span>
<span class="sd">    radius : nm, optional</span>
<span class="sd">        Radius of the cylinder to position monomers.</span>
<span class="sd">    extensions : (int, int), default (0, 0)</span>
<span class="sd">        Number of molecules to extend. Should be a tuple of (prepend, append).</span>
<span class="sd">        Negative values will remove molecules.</span>
<span class="sd">    {prefix}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>

    <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;map_monomers&lt;/code&gt;&quot;</span><span class="p">)</span>
    <span class="n">_added_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">def</span> <span class="nf">_add_molecules</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
        <span class="n">_added_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">):</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_monomers</span><span class="p">(</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
            <span class="n">offsets</span><span class="o">=</span><span class="n">normalize_offsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">normalize_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
            <span class="n">extensions</span><span class="o">=</span><span class="n">extensions</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">_add_molecules</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">cb</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">await_call</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">_added_layers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.map_monomers_with_extensions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_monomers_with_extensions</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">n_extend</span><span class="o">=</span><span class="p">{},</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Mole&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Map monomers as a regular cylindric grid assembly.</p>
<p>This method uses the spline global properties.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>spline</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of splines to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>n_extend</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, (<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>)]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of molecules to extend. Should be mapping from the PF index to the (prepend,
append) number of molecules to add. Remove molecules if negative values are given.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>orientation</code></td>
            <td>
                  <code>(None, PlusToMinus, MinusToPlus)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of molecules' y-axis. If none, use the
current spline orientation as is.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>offsets</code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Offset values that will be used to define molecule positions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>radius</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Radius of the cylinder to position monomers.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prefix</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix of the new molecules layer(s).</p>
              </div>
            </td>
            <td>
                  <code>&#39;Mole&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_monomers_with_extensions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
    <span class="n">n_extend</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;prepend/append&quot;</span><span class="p">,</span> <span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">ProtofilamentEdit</span><span class="p">}]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="n">_OffsetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mole&quot;</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map monomers as a regular cylindric grid assembly.</span>

<span class="sd">    This method uses the spline global properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {spline}</span>
<span class="sd">    n_extend : dict[int, (int, int)]</span>
<span class="sd">        Number of molecules to extend. Should be mapping from the PF index to the (prepend,</span>
<span class="sd">        append) number of molecules to add. Remove molecules if negative values are given.</span>
<span class="sd">    {orientation}{offsets}</span>
<span class="sd">    radius : nm, optional</span>
<span class="sd">        Radius of the cylinder to position monomers.</span>
<span class="sd">    {prefix}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">coordinates_with_extensions</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">n_extend</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">map_on_grid</span><span class="p">(</span>
        <span class="n">i</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
        <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="n">offsets</span><span class="o">=</span><span class="n">normalize_offsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">normalize_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">spl</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spline</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">spl</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.measure_local_radius" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">measure_local_radius</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">update_glob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Measure radius for each local region along splines.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval (nm) between spline anchors. Please note that resetting interval will discard
all the existing local properties.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>depth</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depth (length parallel to the spline tangent) of the subtomograms to be sampled.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>min_radius</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum possible radius in nm.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_radius</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum possible radius in nm.</p>
              </div>
            </td>
            <td>
                  <code>100.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>update_glob</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, also update the global property to the mean of local properties.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Measuring local radii&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">measure_local_radius</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">_Interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">min_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="n">update_glob</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Also update the global radius&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measure radius for each local region along splines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{interval}{depth}{bin_size}{min_radius}{max_radius}{update_glob}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>

    <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
    <span class="k">def</span> <span class="nf">_on_yield</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">(</span><span class="n">replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">local_radii</span><span class="p">(</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
                <span class="n">min_radius</span><span class="o">=</span><span class="n">min_radius</span><span class="p">,</span>
                <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">,</span>
                <span class="n">update_glob</span><span class="o">=</span><span class="n">update_glob</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">splines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">_on_yield</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span>

        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.measure_radius" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">measure_radius</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Measure cylinder radius for each spline curve.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>min_radius</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum possible radius in nm.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_radius</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum possible radius in nm.</p>
              </div>
            </td>
            <td>
                  <code>100.0</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Measuring Radius&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">measure_radius</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">min_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_radius</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measure cylinder radius for each spline curve.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{bin_size}{min_radius}{max_radius}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">measure_radius</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">min_radius</span><span class="o">=</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span>
            <span class="p">)</span>
            <span class="k">yield</span>

        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.measure_radius_by_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">measure_radius_by_molecules</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">(),</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">update_glob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Measure local and global radius for each layer.</p>
<p>Please note that the radius defined by the peak of the radial profile is not always
the same as the radius measured by this method. If the molecules are aligned using
a template image whose mass density is not centered, these radii may differ a lot.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layers</code></td>
            <td>
                  <code>list of MoleculesLayer</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>All the points layers of molecules to be used.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval (nm) between spline anchors. Please note that resetting interval will discard
all the existing local properties.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>depth</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depth (length parallel to the spline tangent) of the subtomograms to be sampled.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>update_glob</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, also update the global property to the mean of local properties.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">measure_radius_by_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">_Interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">update_glob</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Also update the global radius&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measure local and global radius for each layer.</span>

<span class="sd">    Please note that the radius defined by the peak of the radial profile is not always</span>
<span class="sd">    the same as the radius measured by this method. If the molecules are aligned using</span>
<span class="sd">    a template image whose mass density is not centered, these radii may differ a lot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layers}{interval}{depth}{update_glob}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>

    <span class="c1"># check duplicated spline sources</span>
    <span class="n">_splines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">CylSpline</span><span class="p">]()</span>
    <span class="n">_radius_df</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]()</span>
    <span class="n">_duplicated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">CylSpline</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">spl</span> <span class="ow">is</span> <span class="n">each</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">_splines</span><span class="p">):</span>
            <span class="n">_duplicated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
        <span class="n">_splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">features</span>
        <span class="n">_radius_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">cylmeasure</span><span class="o">.</span><span class="n">calc_radius</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">spl</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">_duplicated</span><span class="p">:</span>
        <span class="n">_layer_names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layers </span><span class="si">{</span><span class="n">_layer_names</span><span class="si">}</span><span class="s2"> have duplicated spline sources.&quot;</span><span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="k">for</span> <span class="n">spl</span> <span class="ow">in</span> <span class="n">_splines</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">_splines</span><span class="p">,</span> <span class="n">_radius_df</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span> <span class="o">*</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">():</span>
                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pred</span><span class="p">)[</span><span class="n">Mole</span><span class="o">.</span><span class="n">radius</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">radii</span><span class="o">.</span><span class="n">is_nan</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">_Logger</span><span class="o">.</span><span class="n">print_html</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> contains NaN radius.&lt;/b&gt;&quot;</span><span class="p">)</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">([</span><span class="n">radii</span><span class="p">],</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_glob</span><span class="p">:</span>
                <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">radius</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">(</span><span class="n">replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.merge_molecule_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">merge_molecule_info</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Merge molecule info from different molecules.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>pos</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules whose positions are used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>rotation</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules whose rotations are used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>features</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules whose features are used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Combine</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">merge_molecule_info</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">rotation</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge molecule info from different molecules.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : MoleculesLayer</span>
<span class="sd">        Molecules whose positions are used.</span>
<span class="sd">    rotation : MoleculesLayer</span>
<span class="sd">        Molecules whose rotations are used.</span>
<span class="sd">    features : MoleculesLayer</span>
<span class="sd">        Molecules whose features are used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">_rot</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">_feat</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">_pos</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">_rot</span><span class="o">.</span><span class="n">rotator</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">_feat</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span>
        <span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mole-merged&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">pos</span><span class="o">.</span><span class="n">source_component</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.molecules_to_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">molecules_to_spline</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="p">(),</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">delete_old</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inherits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">missing_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_sources</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create splines from molecules.</p>
<p>This function is useful to refine splines using results of subtomogram
alignment. If the molecules layer alreadly has a source spline, replace
it with the new one.
Note that this function only works with molecules that is correctly
assembled by such as :func:<code>map_monomers</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layers</code></td>
            <td>
                  <code>list of MoleculesLayer</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>All the points layers of molecules to be used.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>err_max</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>S.D. allowed for spline fitting. Larger value will result in smoother spline, i.e. fewer spline knots.</p>
              </div>
            </td>
            <td>
                  <code>0.8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>delete_old</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, delete the old spline if the molecules has one. For instance, if
"Mole-0" has the spline "Spline-0" as the source, and a spline "Spline-1" is
created from "Mole-0", then "Spline-0" will be deleted from the list.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>inherits</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Which global properties to be copied to the new one. If None, all the properties
will be copied.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>missing_ok</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, raise an error if the source spline is not found in the tomogram.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>update_sources</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, all the molecules with the out-of-date source spline will be updated
to the newly created splines. For instance, if "Mole-0" and "Mole-1" have the
spline "Spline-0" as the source, and a spline "Spline-1" is created from
"Mole-1", then the source of "Mole-1" will be updated to "Spline-1" as well.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">molecules_to_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">delete_old</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Delete old splines&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">inherits</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Properties to inherit&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;All properties&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">missing_ok</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing OK&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">update_sources</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Update all the spline sources&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create splines from molecules.</span>

<span class="sd">    This function is useful to refine splines using results of subtomogram</span>
<span class="sd">    alignment. If the molecules layer alreadly has a source spline, replace</span>
<span class="sd">    it with the new one.</span>
<span class="sd">    Note that this function only works with molecules that is correctly</span>
<span class="sd">    assembled by such as :func:`map_monomers`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layers}{err_max}</span>
<span class="sd">    delete_old : bool, default True</span>
<span class="sd">        If True, delete the old spline if the molecules has one. For instance, if</span>
<span class="sd">        &quot;Mole-0&quot; has the spline &quot;Spline-0&quot; as the source, and a spline &quot;Spline-1&quot; is</span>
<span class="sd">        created from &quot;Mole-0&quot;, then &quot;Spline-0&quot; will be deleted from the list.</span>
<span class="sd">    inherits : bool, optional</span>
<span class="sd">        Which global properties to be copied to the new one. If None, all the properties</span>
<span class="sd">        will be copied.</span>
<span class="sd">    missing_ok : bool, default False</span>
<span class="sd">        If False, raise an error if the source spline is not found in the tomogram.</span>
<span class="sd">    update_sources : bool, default True</span>
<span class="sd">        If True, all the molecules with the out-of-date source spline will be updated</span>
<span class="sd">        to the newly created splines. For instance, if &quot;Mole-0&quot; and &quot;Mole-1&quot; have the</span>
<span class="sd">        spline &quot;Spline-0&quot; as the source, and a spline &quot;Spline-1&quot; is created from</span>
<span class="sd">        &quot;Mole-1&quot;, then the source of &quot;Mole-1&quot; will be updated to &quot;Spline-1&quot; as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>

    <span class="c1"># first check missing_ok=False case</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_ok</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="c1"># NOTE: The source spline may not exist in the list</span>
            <span class="k">if</span> <span class="n">_s</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>  <span class="c1"># raise error here if not found</span>

    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_s</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">:</span>
            <span class="n">_config</span> <span class="o">=</span> <span class="n">_s</span><span class="o">.</span><span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">layer</span><span class="o">.</span><span class="n">regular_shape</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_shape</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">CylSpline</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">_config</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">source_spline</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_spl</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="n">old_spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">glob</span> <span class="o">=</span> <span class="n">old_spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span>
                <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">glob</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inherits</span><span class="p">}</span>

            <span class="c1"># Must be updated here, otherwise each.source_component may return</span>
            <span class="c1"># None since GC may delete the old spline.</span>
            <span class="k">if</span> <span class="n">update_sources</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">each</span><span class="o">.</span><span class="n">source_component</span> <span class="ow">is</span> <span class="n">old_spl</span><span class="p">:</span>
                        <span class="n">each</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="n">spl</span>
            <span class="k">if</span> <span class="n">delete_old</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="n">spl</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.open_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">open_image</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tilt_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">filter</span><span class="o">=</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load an image file and process it before sending it to the viewer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>path</code></td>
            <td>
                  <code><span title="magicclass.types.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the tomogram. Must be 3-D image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>scale</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size in nm/pixel unit.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>tilt_range</code></td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of tilt angles in degrees.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code>int or list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial bin size of image. Binned image will be used for visualization in the viewer.
You can use both binned and non-binned image for analysis.</p>
              </div>
            </td>
            <td>
                  <code>[1]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>filter</code></td>
            <td>
                  <code><span title="cylindra.const.ImageFilter">ImageFilter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filter to be applied to the reference image. This does not affect the image data itself.</p>
<ul>
<li>Lowpass: butterworth low-pass filter.</li>
<li>Gaussian: Gaussian blur.</li>
<li>DoG: difference of Gaussian.</li>
<li>LoG: Laplacian of Gaussian.</li>
</ul>
              </div>
            </td>
            <td>
                  <code><span title="cylindra.const.ImageFilter.Lowpass">Lowpass</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>invert</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, invert the intensity of the image.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>eager</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, the image will be loaded immediately. Otherwise, it will be loaded
lazily.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_image_loader</span><span class="p">)</span>
<span class="nd">@dask_thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Reading image&quot;</span><span class="p">)</span>
<span class="nd">@confirm</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;You may have unsaved data. Open a new tomogram?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;self._need_save&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
<span class="k">def</span> <span class="nf">open_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">path</span><span class="p">}],</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">scale_value</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tilt_range</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">tilt_model</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">bin_size</span><span class="p">}]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="nb">filter</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">ImageFilter</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">filter</span><span class="p">}]</span> <span class="o">=</span> <span class="n">ImageFilter</span><span class="o">.</span><span class="n">Lowpass</span><span class="p">,</span>
    <span class="n">invert</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">invert</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">eager</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_image_loader</span><span class="o">.</span><span class="n">eager</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load an image file and process it before sending it to the viewer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path</span>
<span class="sd">        Path to the tomogram. Must be 3-D image.</span>
<span class="sd">    scale : float, default 1.0</span>
<span class="sd">        Pixel size in nm/pixel unit.</span>
<span class="sd">    tilt_range : tuple of float, default None</span>
<span class="sd">        Range of tilt angles in degrees.</span>
<span class="sd">    bin_size : int or list of int, default [1]</span>
<span class="sd">        Initial bin size of image. Binned image will be used for visualization in the viewer.</span>
<span class="sd">        You can use both binned and non-binned image for analysis.</span>
<span class="sd">    {filter}</span>
<span class="sd">    invert : bool, default False</span>
<span class="sd">        If true, invert the intensity of the image.</span>
<span class="sd">    eager : bool, default False</span>
<span class="sd">        If true, the image will be loaded immediately. Otherwise, it will be loaded</span>
<span class="sd">        lazily.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">lazy</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">_config</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">dask_chunk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">bin_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">bin_size</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify at least one bin size.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bin_size</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bin_size</span><span class="p">))</span>  <span class="c1"># delete duplication</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="n">CylTomogram</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">tilt</span><span class="o">=</span><span class="n">tilt_range</span><span class="p">,</span>
        <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_macro_state</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_tomogram_to_viewer</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">tomo</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.open_label_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">open_label_image</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Open an image file as a label image of the current tomogram.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">open_label_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open an image file as a label image of the current tomogram.&quot;&quot;&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Label image must be 3-D.&quot;</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
        <span class="n">label</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">translate</span><span class="o">=</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">],</span>
        <span class="n">scale</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">to_be_removed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">label</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.open_reference_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">open_reference_image</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Open an image as a reference image of the current tomogram.</p>
<p>The input image is usually a denoised image created by other softwares, or
simply a filtered image. Please note that this method does not check that the
input image is appropriate as a reference of the current tomogram, as
potentially any 3D image can be used.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>path</code></td>
            <td>
                  <code>path - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the image file. The image must be 3-D.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">open_reference_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Read</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open an image as a reference image of the current tomogram.</span>

<span class="sd">    The input image is usually a denoised image created by other softwares, or</span>
<span class="sd">    simply a filtered image. Please note that this method does not check that the</span>
<span class="sd">    input image is appropriate as a reference of the current tomogram, as</span>
<span class="sd">    potentially any 3D image can be used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : path-like</span>
<span class="sd">        Path to the image file. The image must be 3-D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_reference_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.overwrite_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">overwrite_project</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Overwrite currently opened project.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+Shift+S&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">overwrite_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Overwrite currently opened project.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No project is loaded. You can use `Save project` &quot;</span>
            <span class="s2">&quot;(ui.save_project(...)) to save the current state.&quot;</span>
        <span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">CylindraProject</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">molecules_info</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">molecules_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.paint_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">paint_molecules</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">color_by</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">DEFAULT_COLORMAP</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.24</span><span class="p">))</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Paint molecules by a feature.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>color_by</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the feature to paint by.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>cmap</code></td>
            <td>
                  <code>colormap</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to be used for painting.</p>
              </div>
            </td>
            <td>
                  <code><span title="cylindra.widgets.main.DEFAULT_COLORMAP">DEFAULT_COLORMAP</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>limits</code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lower and upper limits of the colormap.</p>
              </div>
            </td>
            <td>
                  <code>(4.0, 4.24)</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">View</span><span class="p">)</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, C&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">paint_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">color_by</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;paint_molecules&quot;</span><span class="p">)}],</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="n">_CmapType</span> <span class="o">=</span> <span class="n">DEFAULT_COLORMAP</span><span class="p">,</span>
    <span class="n">limits</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}}]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.00</span><span class="p">,</span> <span class="mf">4.24</span><span class="p">),</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Paint molecules by a feature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{color_by}{cmap}{limits}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">colormap_info</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="n">color_by</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>

    <span class="k">match</span> <span class="n">info</span><span class="p">:</span>
        <span class="k">case</span> <span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">face_color_setter</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span>
                <span class="n">by</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">clim</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">cmap</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.protofilaments_to_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">protofilaments_to_spline</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">(),</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convert protofilaments to splines.</p>
<p>If no IDs are given, all the molecules will be fitted to a spline, therefore
essentially the same as manual filament picking. If IDs are given, selected
protofilaments will be fitted to a spline separately.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>err_max</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>S.D. allowed for spline fitting. Larger value will result in smoother spline, i.e. fewer spline knots.</p>
              </div>
            </td>
            <td>
                  <code>0.8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>ids</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Protofilament IDs to be converted.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protofilaments_to_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_default_config</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert protofilaments to splines.</span>

<span class="sd">    If no IDs are given, all the molecules will be fitted to a spline, therefore</span>
<span class="sd">    essentially the same as manual filament picking. If IDs are given, selected</span>
<span class="sd">    protofilaments will be fitted to a spline separately.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{err_max}</span>
<span class="sd">    ids : list of int, default ()</span>
<span class="sd">        Protofilament IDs to be converted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tomo</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tomo</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">)</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.reanalyze_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reanalyze_image</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Reanalyze the current tomogram.</p>
<p>This method will extract the first manual operations from current session.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Re-analyze current tomogram&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">reanalyze_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reanalyze the current tomogram.</span>

<span class="sd">    This method will extract the first manual operations from current session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_ui_sym</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">macro_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_macro</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="p">:]</span>
    <span class="n">macro</span> <span class="o">=</span> <span class="n">_filter_macro_for_reanalysis</span><span class="p">(</span><span class="n">macro_expr</span><span class="p">,</span> <span class="n">_ui_sym</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">Head</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">macro</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">_ui_sym</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.reanalyze_image_config_updated" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reanalyze_image_config_updated</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Reanalyze the current tomogram with newly set default spline config.</p>
<p>This method is useful when you have mistakenly drawn splines with wrong spline
config.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Re-analyze with new config&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">reanalyze_image_config_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reanalyze the current tomogram with newly set default spline config.</span>

<span class="sd">    This method is useful when you have mistakenly drawn splines with wrong spline</span>
<span class="sd">    config.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_ui_sym</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">macro_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_macro</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_macro_image_load_offset</span> <span class="p">:]</span>
    <span class="n">macro</span> <span class="o">=</span> <span class="n">_filter_macro_for_reanalysis</span><span class="p">(</span><span class="n">macro_expr</span><span class="p">,</span> <span class="n">_ui_sym</span><span class="p">)</span>
    <span class="n">macro</span> <span class="o">=</span> <span class="n">_remove_config_kwargs</span><span class="p">(</span><span class="n">macro</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">mk</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">mk</span><span class="o">.</span><span class="n">Head</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">macro</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">_ui_sym</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">clear_undo_stack</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.refine_splines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">refine_splines</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">corr_allowed</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Refine splines using the global cylindric structural parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_interval</code></td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval (nm) between spline anchors.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>err_max</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>S.D. allowed for spline fitting. Larger value will result in smoother spline, i.e. fewer spline knots.</p>
              </div>
            </td>
            <td>
                  <code>0.8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>corr_allowed</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many images will be used to make template for alignment. If 0.9, then
top 90% will be used.</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscale image to be used. Set to &gt;1 to boost performance.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="o">.</span><span class="n">Fitting</span><span class="p">)</span>
<span class="nd">@thread_worker</span><span class="o">.</span><span class="n">with_progress</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Refining splines&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">_NSPLINES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refine_splines</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum interval (nm)&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;max fit error (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">corr_allowed</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;correlation allowed&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refine splines using the global cylindric structural parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}{max_interval}{err_max}</span>
<span class="sd">    corr_allowed : float, default 0.9</span>
<span class="sd">        How many images will be used to make template for alignment. If 0.9, then</span>
<span class="sd">        top 90% will be used.</span>
<span class="sd">    {bin_size}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">tomo</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">,</span>
                <span class="n">corr_allowed</span><span class="o">=</span><span class="n">corr_allowed</span><span class="p">,</span>
                <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">thread_worker</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">)</span>

        <span class="nd">@thread_worker</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_widget_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.regionprops_features" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regionprops_features</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">))</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Analyze region properties using another feature column as the labels.</p>
<p>For instance, if the target data is [0, 1, 2, 3, 4] and the labels are [0, 1, 1, 2, 2],
the the property "mean" will be [1.5, 3.5]. For some properties such as "length" and
"width", the monomer connection will be considered.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>target</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target column name on which calculation will run.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>label</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Annotated" href="https://docs.python.org/3/library/typing.html#typing.Annotated">Annotated</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, {choices: <span title="cylindra.widgets.main._choice_getter">_choice_getter</span>(<a class="autorefs autorefs-internal" title="cylindra.widgets.main.CylindraMainWidget.regionprops_features" href="#cylindra.widgets.main.CylindraMainWidget.regionprops_features">regionprops_features</a>, dtype_kind=ui)}]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The feature name that will be used as the labels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>properties</code></td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Properties to calculate.</p>
              </div>
            </td>
            <td>
                  <code>(&#39;area&#39;, &#39;mean&#39;)</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Analyze region properties&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">Features</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">regionprops_features</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;regionprops_features&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;uif&quot;</span><span class="p">)}],</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;regionprops_features&quot;</span><span class="p">,</span> <span class="n">dtype_kind</span><span class="o">=</span><span class="s2">&quot;ui&quot;</span><span class="p">)}],</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">RegionProfiler</span><span class="o">.</span><span class="n">CHOICES</span><span class="p">,</span> <span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">CheckBoxes</span><span class="p">}]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze region properties using another feature column as the labels.</span>

<span class="sd">    For instance, if the target data is [0, 1, 2, 3, 4] and the labels are [0, 1, 1, 2, 2],</span>
<span class="sd">    the the property &quot;mean&quot; will be [1.5, 3.5]. For some properties such as &quot;length&quot; and</span>
<span class="sd">    &quot;width&quot;, the monomer connection will be considered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{target}</span>
<span class="sd">    label: str</span>
<span class="sd">        The feature name that will be used as the labels.</span>
<span class="sd">    properties : list of str</span>
<span class="sd">        Properties to calculate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">magicclass.ext.polars</span> <span class="kn">import</span> <span class="n">DataFrameView</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="p">[</span><span class="n">target</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">_assert_source_spline_exists</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">cylmeasure</span><span class="o">.</span><span class="n">RegionProfiler</span><span class="o">.</span><span class="n">from_components</span><span class="p">(</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">label</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
    <span class="n">view</span> <span class="o">=</span> <span class="n">DataFrameView</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="n">dock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">add_dock_widget</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Region properties&quot;</span><span class="p">)</span>
    <span class="n">dock</span><span class="o">.</span><span class="n">setFloating</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="n">dock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span><span class="o">.</span><span class="n">with_redo</span><span class="p">(</span><span class="n">dock</span><span class="o">.</span><span class="n">show</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.register_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_molecules</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Register manually added points as molecules.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">register_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_spline_coordinates</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register manually added points as molecules.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">coords</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points are given.&quot;</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mole-manual&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.register_path" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_path</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Register points as a spline path.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s2">&quot;mdi:pen-add&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">Toolbar</span><span class="p">)</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;F1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">register_path</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_spline_coordinates</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">_get_default_config</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register points as a spline path.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">coords</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points are given.&quot;</span><span class="p">)</span>

    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">tomo</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_add_spline_instance</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_spline</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.rename_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rename_molecules</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Rename multiple molecules layers at once.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>old</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Old string to be replaced.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>new</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New string to replace <code>old</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>include</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Delete layers whose names contain this string.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>exclude</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Delete layers whose names do not contain this string.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pattern</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String pattern to match the layer names. Use <code>*</code> as wildcard.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Rename molecule layers&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rename_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">old</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">new</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rename multiple molecules layers at once.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    old : str</span>
<span class="sd">        Old string to be replaced.</span>
<span class="sd">    new : str</span>
<span class="sd">        New string to replace `old`.</span>
<span class="sd">    include : str, optional</span>
<span class="sd">        Delete layers whose names contain this string.</span>
<span class="sd">    exclude : str, optional</span>
<span class="sd">        Delete layers whose names do not contain this string.</span>
<span class="sd">    pattern : str, optional</span>
<span class="sd">        String pattern to match the layer names. Use `*` as wildcard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">old</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`old` is not given.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`new` is not given.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_layers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.rotate_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rotate_molecules</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">inherit_source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Rotate molecules without changing their positions.</p>
<p>Output molecules layer will be named as "<original name>-Rot".</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layers</code></td>
            <td>
                  <code>list of MoleculesLayer</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>All the points layers of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>degrees</code></td>
            <td>
                  <code>list of (str, float)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rotation axes and degrees. For example, <code>[("z", 20), ("y", -10)]</code> means
rotation by 20 degrees around the molecule Z axis and then by -10 degrees
around the Y axis.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>inherit_source</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True and the input molecules layer has its spline source, the new layer will inherit it.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rotate_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
    <span class="n">degrees</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="p">{</span><span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;widget_type&quot;</span><span class="p">:</span> <span class="n">SingleRotationEdit</span><span class="p">}},</span>
    <span class="p">],</span>
    <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotate molecules without changing their positions.</span>

<span class="sd">    Output molecules layer will be named as &quot;&lt;original name&gt;-Rot&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layers}</span>
<span class="sd">    degrees : list of (str, float)</span>
<span class="sd">        Rotation axes and degrees. For example, `[(&quot;z&quot;, 20), (&quot;y&quot;, -10)]` means</span>
<span class="sd">        rotation by 20 degrees around the molecule Z axis and then by -10 degrees</span>
<span class="sd">        around the Y axis.</span>
<span class="sd">    {inherit_source}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">new_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
    <span class="n">rotvec</span> <span class="o">=</span> <span class="n">degrees_to_rotator</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">(</span><span class="n">rotvec</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Rot&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="n">new_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new_layers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.run_workflow" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_workflow</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Run a user-defined workflow.</p>
<p>This method will run a .py file that was defined by the user from
<code>Workflow &gt; Define workflow</code>. <em>args and </em>*kwargs follow the signature of the
main function of the workflow.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@do_not_record</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@nogui</span>
<span class="k">def</span> <span class="nf">run_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a user-defined workflow.</span>

<span class="sd">    This method will run a .py file that was defined by the user from</span>
<span class="sd">    `Workflow &gt; Define workflow`. *args and **kwargs follow the signature of the</span>
<span class="sd">    main function of the workflow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">get_main_function</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.sample_subtomograms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_subtomograms</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Sample subtomograms at the anchor points on splines</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sample_subtomograms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample subtomograms at the anchor points on splines&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spline_fitter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># initialize GUI</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No spline found.&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">has_anchors</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_num_changed</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;pan_zoom&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_update_local_properties_in_widget</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_properties_in_widget</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_spline</span><span class="p">()</span>

    <span class="c1"># reset contrast limits</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">SplineControl</span><span class="o">.</span><span class="n">_reset_contrast_limits</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.save_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_molecules</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save monomer coordinates, orientation and features as a csv file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>save_path</code></td>
            <td>
                  <code><span title="magicclass.types.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Where to save the molecules.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@do_not_record</span>
<span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Save</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">MOLE</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save monomer coordinates, orientation and features as a csv file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    save_path : Path</span>
<span class="sd">        Where to save the molecules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.save_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_project</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">molecules_ext</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">save_landscape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save current project state and the results in a directory.</p>
<p>The json file contains paths of images and results, parameters of splines,
scales and version. Local and global properties will be exported as csv files.
Molecule coordinates and features will be exported as the <code>molecules_ext</code>
format. If results are saved at the default directory, they will be
written as relative paths in the project json file so that moving root
directory does not affect the loading behavior.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>path</code></td>
            <td>
                  <code><span title="magicclass.types.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path of json file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>molecules_ext</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extension of the molecule file. Can be ".csv" or ".parquet".</p>
              </div>
            </td>
            <td>
                  <code>&#34;.csv&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>save_landscape</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Save landscape layers if any. False by default because landscape layers are
usually large.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="nd">@bind_key</span><span class="p">(</span><span class="s2">&quot;Ctrl+K, Ctrl+S&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_project</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Save</span><span class="p">,</span>
    <span class="n">molecules_ext</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span>
    <span class="n">save_landscape</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Save landscape layers&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save current project state and the results in a directory.</span>

<span class="sd">    The json file contains paths of images and results, parameters of splines,</span>
<span class="sd">    scales and version. Local and global properties will be exported as csv files.</span>
<span class="sd">    Molecule coordinates and features will be exported as the `molecules_ext`</span>
<span class="sd">    format. If results are saved at the default directory, they will be</span>
<span class="sd">    written as relative paths in the project json file so that moving root</span>
<span class="sd">    directory does not affect the loading behavior.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path</span>
<span class="sd">        Path of json file.</span>
<span class="sd">    molecules_ext : str, default &quot;.csv&quot;</span>
<span class="sd">        Extension of the molecule file. Can be &quot;.csv&quot; or &quot;.parquet&quot;.</span>
<span class="sd">    save_landscape : bool, default False</span>
<span class="sd">        Save landscape layers if any. False by default because landscape layers are</span>
<span class="sd">        usually large.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">CylindraProject</span><span class="o">.</span><span class="n">save_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">molecules_ext</span><span class="p">,</span> <span class="n">save_landscape</span><span class="p">)</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project saved: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_project_dir</span> <span class="o">=</span> <span class="n">path</span>
    <span class="n">autosave_path</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">autosave_path</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">autosave_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">autosave_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.save_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_spline</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save splines as a json file.</p>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">FileMenu</span><span class="p">)</span>
<span class="nd">@do_not_record</span>
<span class="k">def</span> <span class="nf">save_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Path</span><span class="o">.</span><span class="n">Save</span><span class="p">[</span><span class="n">FileFilter</span><span class="o">.</span><span class="n">JSON</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save splines as a json file.&quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="n">spl</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.set_multiscale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_multiscale</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set multiscale used for image display.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>bin_size</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Annotated" href="https://docs.python.org/3/library/typing.html#typing.Annotated">Annotated</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, {choices: <span title="cylindra.widgets.main.CylindraMainWidget._get_available_binsize">_get_available_binsize</span>}]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size of multiscaled image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Set multi-scale&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">ImageMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_available_binsize</span><span class="p">}]):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set multiscale used for image display.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bin_size: int</span>
<span class="sd">        Bin size of multiscaled image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span>
    <span class="n">_old_bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_binsize</span>
    <span class="n">imgb</span> <span class="o">=</span> <span class="n">tomo</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">imgb</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_layers</span><span class="o">.</span><span class="n">update_image</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">tomo</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">bin_size</span><span class="p">))</span>
    <span class="n">current_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">current_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">set_current_step</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">current_z</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>

    <span class="c1"># update overview</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">imgb</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">factor</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">xlim</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">*</span> <span class="n">factor</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="o">.</span><span class="n">ylim</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_binsize</span> <span class="o">=</span> <span class="n">bin_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_choices</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">undo_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_multiscale</span><span class="p">)</span><span class="o">.</span><span class="n">with_args</span><span class="p">(</span><span class="n">_old_bin_size</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.set_radius" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_radius</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set radius of the splines.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>splines</code></td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of splines to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>radius</code></td>
            <td>
                  <code>float or str expression</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Radius of the spline. If a string expression is given, it will be evaluated to get
the polars.Expr object. The returned expression will be evaluated with the global
properties of the spline as the context.</p>
              </div>
            </td>
            <td>
                  <code>10.0</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">AnalysisMenu</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_radius</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">splines</span><span class="p">:</span> <span class="n">SplinesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="n">PolarsExprStrOrScalar</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set radius of the splines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {splines}</span>
<span class="sd">    radius : float or str expression</span>
<span class="sd">        Radius of the spline. If a string expression is given, it will be evaluated to get</span>
<span class="sd">        the polars.Expr object. The returned expression will be evaluated with the global</span>
<span class="sd">        properties of the spline as the context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">radius_expr</span> <span class="o">=</span> <span class="n">widget_utils</span><span class="o">.</span><span class="n">norm_scalar_expr</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_splines</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
    <span class="n">rdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
        <span class="n">_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">radius_expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_radius</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Radius must be converted into a number, got </span><span class="si">{</span><span class="n">_radius</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_radius</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Radius must be positive, got </span><span class="si">{</span><span class="n">_radius</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">rdict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_radius</span>
    <span class="k">with</span> <span class="n">SplineTracker</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">splines</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">rdict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">as_undo_callback</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.set_source_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_source_spline</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">spline</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set source spline for a molecules layer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>spline</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of splines to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="o">.</span><span class="n">FromToSpline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_source_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_get_splines</span><span class="p">}],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set source spline for a molecules layer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}{spline}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">old_spl</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>

    <span class="nd">@undo_callback</span>
    <span class="k">def</span> <span class="nf">_undo</span><span class="p">():</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="o">=</span> <span class="n">old_spl</span>

    <span class="k">return</span> <span class="n">_undo</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.set_spline_props" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_spline_props</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">npf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set spline global properties.</p>
<p>This method will overwrite spline properties with the user input. You should
not call this method unless there's a good reason to do so, e.g. the number
of protofilaments is obviously wrong.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>npf</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If given, update the number of protofilaments.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>start</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If given, update the start number of the spline.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>orientation</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If given, update the spline orientation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Set spline properties&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">SplinesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_spline_props</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bind&quot;</span><span class="p">:</span> <span class="n">_get_spline_idx</span><span class="p">}],</span>
    <span class="n">npf</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;number of PF&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not update&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;start number&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not update&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;MinusToPlus&quot;</span><span class="p">,</span> <span class="s2">&quot;PlusToMinus&quot;</span><span class="p">]],</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Do not update&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set spline global properties.</span>

<span class="sd">    This method will overwrite spline properties with the user input. You should</span>
<span class="sd">    not call this method unless there&#39;s a good reason to do so, e.g. the number</span>
<span class="sd">    of protofilaments is obviously wrong.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    npf : int, optional</span>
<span class="sd">        If given, update the number of protofilaments.</span>
<span class="sd">    start : int, optional</span>
<span class="sd">        If given, update the start number of the spline.</span>
<span class="sd">    orientation : str, optional</span>
<span class="sd">        If given, update the spline orientation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span>
    <span class="n">old_spl</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">spl</span><span class="o">.</span><span class="n">update_props</span><span class="p">(</span><span class="n">npf</span><span class="o">=</span><span class="n">npf</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>

    <span class="nd">@undo_callback</span>
    <span class="k">def</span> <span class="nf">out</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tomogram</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">spline</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_spl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_subtomograms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_splines_in_images</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.split_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_molecules</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Split molecules by a feature column.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layer</code></td>
            <td>
                  <code><span title="cylindra._napari.MoleculesLayer">MoleculesLayer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Points layer of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>by</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the feature to split by.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Split molecules by feature&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">split_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">MoleculesLayerType</span><span class="p">,</span>
    <span class="n">by</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">_choice_getter</span><span class="p">(</span><span class="s2">&quot;split_molecules&quot;</span><span class="p">)}],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split molecules by a feature column.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layer}</span>
<span class="sd">    by : str</span>
<span class="sd">        Name of the feature to split by.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">assert_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">assert_column_exists</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
    <span class="n">_added_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">mole</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span>
            <span class="n">mole</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">source_component</span>
        <span class="p">)</span>
        <span class="n">_added_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">_added_layers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.widgets.main.CylindraMainWidget.translate_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">translate_molecules</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inherit_source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Translate molecule coordinates without changing their rotations.</p>
<p>Output molecules layer will be named as "<original name>-Shift".</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>layers</code></td>
            <td>
                  <code>list of MoleculesLayer</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>All the points layers of molecules to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>translation</code></td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Translation (nm) of the molecules in (Z, Y, X) order. Whether the world
coordinate or the internal coordinate is used depends on the <code>internal</code>
argument.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>internal</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, the translation is applied to the internal coordinates, i.e.
molecules with different rotations are translated differently.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>inherit_source</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True and the input molecules layer has its spline source, the new layer will inherit it.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cylindra/widgets/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@set_design</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">capitalize</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">_sw</span><span class="o">.</span><span class="n">MoleculesMenu</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">translate_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">MoleculesLayersType</span><span class="p">,</span>
    <span class="n">translation</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;translation Z, Y, X (nm)&quot;</span><span class="p">}],</span>
    <span class="n">internal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">inherit_source</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Inherit source spline&quot;</span><span class="p">}]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate molecule coordinates without changing their rotations.</span>

<span class="sd">    Output molecules layer will be named as &quot;&lt;original name&gt;-Shift&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {layers}</span>
<span class="sd">    translation : tuple of float</span>
<span class="sd">        Translation (nm) of the molecules in (Z, Y, X) order. Whether the world</span>
<span class="sd">        coordinate or the internal coordinate is used depends on the `internal`</span>
<span class="sd">        argument.</span>
<span class="sd">    internal : bool, default True</span>
<span class="sd">        If true, the translation is applied to the internal coordinates, i.e.</span>
<span class="sd">        molecules with different rotations are translated differently.</span>
<span class="sd">    {inherit_source}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">assert_list_of_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_viewer</span><span class="p">)</span>
    <span class="n">new_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">MoleculesLayer</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">if</span> <span class="n">internal</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># update spline position feature</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">with_features</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># spline position is not predictable.</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop_features</span><span class="p">([</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">])</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source_component</span> <span class="k">if</span> <span class="n">inherit_source</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-Shift&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="n">new_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_callback_for_layer</span><span class="p">(</span><span class="n">new_layers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../plugin/" class="md-footer__link md-footer__link--prev" aria-label="Previous: cylindra.plugin">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                cylindra.plugin
              </div>
            </div>
          </a>
        
        
          
          <a href="../sta/" class="md-footer__link md-footer__link--next" aria-label="Next: cylindra.widgets.sta.SubtomogramAveraging">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                cylindra.widgets.sta.SubtomogramAveraging
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2023 - 2024 Hanjin Liu
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "navigation.sections", "navigation.indexes", "navigation.footer", "toc.follow", "search.suggest", "search.share"], "search": "../../../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>