
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Cryo-ET image analysis tool for cylindric periodic structures such as microtubules.">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../core/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>cylindra.components - Cylindra</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="lime" data-md-color-accent="light-green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cylindracomponents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Cylindra" class="md-header__button md-logo" aria-label="Cylindra" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cylindra
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cylindra.components
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="lime" data-md-color-accent="light-green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="lime" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hanjinliu/cylindra" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cylindra
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cylindra" class="md-nav__button md-logo" aria-label="Cylindra" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Cylindra
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hanjinliu/cylindra" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cylindra
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../open_image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Start Cylindra
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fit_splines/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fit Splines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lattice_params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Measure Lattice Parameters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inspect_results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inspect CFT Results
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Load &amp; Save Projects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plugins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Plugin System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../spline/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Spline
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            Spline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spline/clip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Clip and Invert Splines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spline/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spline Configurations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../molecules/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Molecules
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            Molecules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/spline_to_molecules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spline to Molecules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Molecule Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/expressions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The "Expressions"
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/split_and_combine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Split &amp; Combine Molecules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/filter_molecules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Filter Molecules by Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transform Molecules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../molecules/headers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Feature Names
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../alignment/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Alignment
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            Alignment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../alignment/conventional/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conventional Methods in Cryo-ET Studies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../alignment/landscape/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build Correlation Landscapes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../alignment/viterbi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Viterbi Alignment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../alignment/rma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Restricted Mesh Annealing (RMA)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_11" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../batch/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Working with Many Projects
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_11" id="__nav_4_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_11">
            <span class="md-nav__icon md-icon"></span>
            Working with Many Projects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../batch/collect_projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Collect projects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../batch/construct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Construct Batch Loaders
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../batch/average/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Average Across Projects
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_12" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../extern/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Working with External Softwares
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_12" id="__nav_4_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_12">
            <span class="md-nav__icon md-icon"></span>
            Working with External Softwares
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../extern/imod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IMOD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../extern/relion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RELION
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../process_images/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Process Images
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulate Tomograms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_16" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../case_studies/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Case Studies
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_16" id="__nav_4_16_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_16">
            <span class="md-nav__icon md-icon"></span>
            Case Studies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../case_studies/rma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analyzing Microtubule Local Structures with RMA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../case_studies/seam_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microtubule Seam-search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../case_studies/ssta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Segmented Subtomogram Averaging (SSTA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../case_studies/make_figure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microtubule for Figures
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    API References
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    cylindra.components
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    cylindra.components
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline" class="md-nav__link">
    <span class="md-ellipsis">
      spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline" class="md-nav__link">
    <span class="md-ellipsis">
      CylSpline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CylSpline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.orientation" class="md-nav__link">
    <span class="md-ellipsis">
      orientation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.radius" class="md-nav__link">
    <span class="md-ellipsis">
      radius
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.clip" class="md-nav__link">
    <span class="md-ellipsis">
      clip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.cylinder_model" class="md-nav__link">
    <span class="md-ellipsis">
      cylinder_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.cylinder_params" class="md-nav__link">
    <span class="md-ellipsis">
      cylinder_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.nrise" class="md-nav__link">
    <span class="md-ellipsis">
      nrise
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.radius_range" class="md-nav__link">
    <span class="md-ellipsis">
      radius_range
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.restore" class="md-nav__link">
    <span class="md-ellipsis">
      restore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.update_glob_by_cylinder_params" class="md-nav__link">
    <span class="md-ellipsis">
      update_glob_by_cylinder_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.update_props" class="md-nav__link">
    <span class="md-ellipsis">
      update_props
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline" class="md-nav__link">
    <span class="md-ellipsis">
      Spline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Spline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.anchors" class="md-nav__link">
    <span class="md-ellipsis">
      anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.coeff" class="md-nav__link">
    <span class="md-ellipsis">
      coeff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.config" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.extrapolate" class="md-nav__link">
    <span class="md-ellipsis">
      extrapolate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.has_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      has_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.knots" class="md-nav__link">
    <span class="md-ellipsis">
      knots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.lims" class="md-nav__link">
    <span class="md-ellipsis">
      lims
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.order" class="md-nav__link">
    <span class="md-ellipsis">
      order
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.params" class="md-nav__link">
    <span class="md-ellipsis">
      params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.props" class="md-nav__link">
    <span class="md-ellipsis">
      props
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline._get_coords" class="md-nav__link">
    <span class="md-ellipsis">
      _get_coords
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.anchors_to_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      anchors_to_molecules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cartesian" class="md-nav__link">
    <span class="md-ellipsis">
      cartesian
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cartesian_to_world" class="md-nav__link">
    <span class="md-ellipsis">
      cartesian_to_world
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.clip" class="md-nav__link">
    <span class="md-ellipsis">
      clip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.close_to" class="md-nav__link">
    <span class="md-ellipsis">
      close_to
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.copy" class="md-nav__link">
    <span class="md-ellipsis">
      copy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.curvature" class="md-nav__link">
    <span class="md-ellipsis">
      curvature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.curvature_radii" class="md-nav__link">
    <span class="md-ellipsis">
      curvature_radii
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cylindrical" class="md-nav__link">
    <span class="md-ellipsis">
      cylindrical
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cylindrical_to_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      cylindrical_to_molecules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cylindrical_to_world" class="md-nav__link">
    <span class="md-ellipsis">
      cylindrical_to_world
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.distances" class="md-nav__link">
    <span class="md-ellipsis">
      distances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.get_rotator" class="md-nav__link">
    <span class="md-ellipsis">
      get_rotator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.has_props" class="md-nav__link">
    <span class="md-ellipsis">
      has_props
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.is_inverted" class="md-nav__link">
    <span class="md-ellipsis">
      is_inverted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.length" class="md-nav__link">
    <span class="md-ellipsis">
      length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.line" class="md-nav__link">
    <span class="md-ellipsis">
      line
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.local_cartesian" class="md-nav__link">
    <span class="md-ellipsis">
      local_cartesian
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.local_cylindrical" class="md-nav__link">
    <span class="md-ellipsis">
      local_cylindrical
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.make_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      make_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.map" class="md-nav__link">
    <span class="md-ellipsis">
      map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.partition" class="md-nav__link">
    <span class="md-ellipsis">
      partition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.resample" class="md-nav__link">
    <span class="md-ellipsis">
      resample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.restore" class="md-nav__link">
    <span class="md-ellipsis">
      restore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.shift" class="md-nav__link">
    <span class="md-ellipsis">
      shift
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.translate" class="md-nav__link">
    <span class="md-ellipsis">
      translate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.with_config" class="md-nav__link">
    <span class="md-ellipsis">
      with_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.with_extrapolation" class="md-nav__link">
    <span class="md-ellipsis">
      with_extrapolation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.y_to_position" class="md-nav__link">
    <span class="md-ellipsis">
      y_to_position
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline.SplineConfig" class="md-nav__link">
    <span class="md-ellipsis">
      SplineConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SplineConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.SplineConfig.construct" class="md-nav__link">
    <span class="md-ellipsis">
      construct
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.tomogram" class="md-nav__link">
    <span class="md-ellipsis">
      tomogram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram" class="md-nav__link">
    <span class="md-ellipsis">
      CylTomogram
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CylTomogram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.splines" class="md-nav__link">
    <span class="md-ellipsis">
      splines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.add_spline" class="md-nav__link">
    <span class="md-ellipsis">
      add_spline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.align_to_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      align_to_polarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.get_cylinder_model" class="md-nav__link">
    <span class="md-ellipsis">
      get_cylinder_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.global_cft" class="md-nav__link">
    <span class="md-ellipsis">
      global_cft
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.global_cft_params" class="md-nav__link">
    <span class="md-ellipsis">
      global_cft_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.global_cps" class="md-nav__link">
    <span class="md-ellipsis">
      global_cps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.infer_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      infer_polarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_cft" class="md-nav__link">
    <span class="md-ellipsis">
      local_cft
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_cft_params" class="md-nav__link">
    <span class="md-ellipsis">
      local_cft_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_cps" class="md-nav__link">
    <span class="md-ellipsis">
      local_cps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_radii" class="md-nav__link">
    <span class="md-ellipsis">
      local_radii
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.make_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      make_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_centers" class="md-nav__link">
    <span class="md-ellipsis">
      map_centers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_monomers" class="md-nav__link">
    <span class="md-ellipsis">
      map_monomers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_on_grid" class="md-nav__link">
    <span class="md-ellipsis">
      map_on_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_pf_line" class="md-nav__link">
    <span class="md-ellipsis">
      map_pf_line
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.measure_radius" class="md-nav__link">
    <span class="md-ellipsis">
      measure_radius
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.refine" class="md-nav__link">
    <span class="md-ellipsis">
      refine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.straighten" class="md-nav__link">
    <span class="md-ellipsis">
      straighten
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.straighten_cylindric" class="md-nav__link">
    <span class="md-ellipsis">
      straighten_cylindric
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram" class="md-nav__link">
    <span class="md-ellipsis">
      Tomogram
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tomogram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.image" class="md-nav__link">
    <span class="md-ellipsis">
      image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.is_dummy" class="md-nav__link">
    <span class="md-ellipsis">
      is_dummy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.is_inverted" class="md-nav__link">
    <span class="md-ellipsis">
      is_inverted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.metadata" class="md-nav__link">
    <span class="md-ellipsis">
      metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.multiscaled" class="md-nav__link">
    <span class="md-ellipsis">
      multiscaled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.source" class="md-nav__link">
    <span class="md-ellipsis">
      source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.tilt" class="md-nav__link">
    <span class="md-ellipsis">
      tilt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.tilt_model" class="md-nav__link">
    <span class="md-ellipsis">
      tilt_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.__hash__" class="md-nav__link">
    <span class="md-ellipsis">
      __hash__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram._get_multiscale_or_original" class="md-nav__link">
    <span class="md-ellipsis">
      _get_multiscale_or_original
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.add_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      add_multiscale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.dummy" class="md-nav__link">
    <span class="md-ellipsis">
      dummy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.from_image" class="md-nav__link">
    <span class="md-ellipsis">
      from_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.get_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      get_multiscale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.get_subtomogram_loader" class="md-nav__link">
    <span class="md-ellipsis">
      get_subtomogram_loader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.imread" class="md-nav__link">
    <span class="md-ellipsis">
      imread
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.multiscale_translation" class="md-nav__link">
    <span class="md-ellipsis">
      multiscale_translation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.nm2pixel" class="md-nav__link">
    <span class="md-ellipsis">
      nm2pixel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.with_cache_info" class="md-nav__link">
    <span class="md-ellipsis">
      with_cache_info
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components._base" class="md-nav__link">
    <span class="md-ellipsis">
      _base
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent._dump" class="md-nav__link">
    <span class="md-ellipsis">
      _dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.from_json" class="md-nav__link">
    <span class="md-ellipsis">
      from_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.rescale" class="md-nav__link">
    <span class="md-ellipsis">
      rescale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.to_json" class="md-nav__link">
    <span class="md-ellipsis">
      to_json
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape" class="md-nav__link">
    <span class="md-ellipsis">
      landscape
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.AnnealingResult" class="md-nav__link">
    <span class="md-ellipsis">
      AnnealingResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape" class="md-nav__link">
    <span class="md-ellipsis">
      Landscape
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Landscape">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.offset" class="md-nav__link">
    <span class="md-ellipsis">
      offset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.offset_nm" class="md-nav__link">
    <span class="md-ellipsis">
      offset_nm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.create_surface" class="md-nav__link">
    <span class="md-ellipsis">
      create_surface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.cylindric_annealing_model" class="md-nav__link">
    <span class="md-ellipsis">
      cylindric_annealing_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.from_dir" class="md-nav__link">
    <span class="md-ellipsis">
      from_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.from_loader" class="md-nav__link">
    <span class="md-ellipsis">
      from_loader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.normed" class="md-nav__link">
    <span class="md-ellipsis">
      normed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_annealing" class="md-nav__link">
    <span class="md-ellipsis">
      run_annealing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_min_energy" class="md-nav__link">
    <span class="md-ellipsis">
      run_min_energy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_viterbi" class="md-nav__link">
    <span class="md-ellipsis">
      run_viterbi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_viterbi_fixed_start" class="md-nav__link">
    <span class="md-ellipsis">
      run_viterbi_fixed_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.transform_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      transform_molecules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.SurfaceData" class="md-nav__link">
    <span class="md-ellipsis">
      SurfaceData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.ViterbiResult" class="md-nav__link">
    <span class="md-ellipsis">
      ViterbiResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape._update_mole_pos" class="md-nav__link">
    <span class="md-ellipsis">
      _update_mole_pos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.delayed_isosurface" class="md-nav__link">
    <span class="md-ellipsis">
      delayed_isosurface
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.seam_search" class="md-nav__link">
    <span class="md-ellipsis">
      seam_search
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.seam_search.CorrelationSeamSearcher" class="md-nav__link">
    <span class="md-ellipsis">
      CorrelationSeamSearcher
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.seam_search.SeamSearcher" class="md-nav__link">
    <span class="md-ellipsis">
      SeamSearcher
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SeamSearcher">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.seam_search.SeamSearcher.search" class="md-nav__link">
    <span class="md-ellipsis">
      search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.project
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cylmeasure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.cylmeasure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cylfilters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.cylfilters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plugin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.plugin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Widgets
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Widgets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../widgets/main/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.main.CylindraMainWidget
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../widgets/sta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.sta.SubtomogramAveraging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../widgets/subwidgets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.subwidgets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../widgets/batch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra.widgets.batch
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Builtin Plugins
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Builtin Plugins
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../builtins/imod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra_builtins.imod
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../builtins/relion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cylindra_builtins.relion
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline" class="md-nav__link">
    <span class="md-ellipsis">
      spline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline" class="md-nav__link">
    <span class="md-ellipsis">
      CylSpline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CylSpline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.orientation" class="md-nav__link">
    <span class="md-ellipsis">
      orientation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.radius" class="md-nav__link">
    <span class="md-ellipsis">
      radius
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.clip" class="md-nav__link">
    <span class="md-ellipsis">
      clip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.cylinder_model" class="md-nav__link">
    <span class="md-ellipsis">
      cylinder_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.cylinder_params" class="md-nav__link">
    <span class="md-ellipsis">
      cylinder_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.nrise" class="md-nav__link">
    <span class="md-ellipsis">
      nrise
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.radius_range" class="md-nav__link">
    <span class="md-ellipsis">
      radius_range
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.restore" class="md-nav__link">
    <span class="md-ellipsis">
      restore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.update_glob_by_cylinder_params" class="md-nav__link">
    <span class="md-ellipsis">
      update_glob_by_cylinder_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.CylSpline.update_props" class="md-nav__link">
    <span class="md-ellipsis">
      update_props
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline" class="md-nav__link">
    <span class="md-ellipsis">
      Spline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Spline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.anchors" class="md-nav__link">
    <span class="md-ellipsis">
      anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.coeff" class="md-nav__link">
    <span class="md-ellipsis">
      coeff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.config" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.extrapolate" class="md-nav__link">
    <span class="md-ellipsis">
      extrapolate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.has_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      has_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.knots" class="md-nav__link">
    <span class="md-ellipsis">
      knots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.lims" class="md-nav__link">
    <span class="md-ellipsis">
      lims
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.order" class="md-nav__link">
    <span class="md-ellipsis">
      order
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.params" class="md-nav__link">
    <span class="md-ellipsis">
      params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.props" class="md-nav__link">
    <span class="md-ellipsis">
      props
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline._get_coords" class="md-nav__link">
    <span class="md-ellipsis">
      _get_coords
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.anchors_to_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      anchors_to_molecules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cartesian" class="md-nav__link">
    <span class="md-ellipsis">
      cartesian
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cartesian_to_world" class="md-nav__link">
    <span class="md-ellipsis">
      cartesian_to_world
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.clip" class="md-nav__link">
    <span class="md-ellipsis">
      clip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.close_to" class="md-nav__link">
    <span class="md-ellipsis">
      close_to
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.copy" class="md-nav__link">
    <span class="md-ellipsis">
      copy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.curvature" class="md-nav__link">
    <span class="md-ellipsis">
      curvature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.curvature_radii" class="md-nav__link">
    <span class="md-ellipsis">
      curvature_radii
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cylindrical" class="md-nav__link">
    <span class="md-ellipsis">
      cylindrical
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cylindrical_to_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      cylindrical_to_molecules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.cylindrical_to_world" class="md-nav__link">
    <span class="md-ellipsis">
      cylindrical_to_world
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.distances" class="md-nav__link">
    <span class="md-ellipsis">
      distances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.get_rotator" class="md-nav__link">
    <span class="md-ellipsis">
      get_rotator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.has_props" class="md-nav__link">
    <span class="md-ellipsis">
      has_props
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.is_inverted" class="md-nav__link">
    <span class="md-ellipsis">
      is_inverted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.length" class="md-nav__link">
    <span class="md-ellipsis">
      length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.line" class="md-nav__link">
    <span class="md-ellipsis">
      line
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.local_cartesian" class="md-nav__link">
    <span class="md-ellipsis">
      local_cartesian
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.local_cylindrical" class="md-nav__link">
    <span class="md-ellipsis">
      local_cylindrical
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.make_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      make_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.map" class="md-nav__link">
    <span class="md-ellipsis">
      map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.partition" class="md-nav__link">
    <span class="md-ellipsis">
      partition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.resample" class="md-nav__link">
    <span class="md-ellipsis">
      resample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.restore" class="md-nav__link">
    <span class="md-ellipsis">
      restore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.shift" class="md-nav__link">
    <span class="md-ellipsis">
      shift
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.translate" class="md-nav__link">
    <span class="md-ellipsis">
      translate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.with_config" class="md-nav__link">
    <span class="md-ellipsis">
      with_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.with_extrapolation" class="md-nav__link">
    <span class="md-ellipsis">
      with_extrapolation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.Spline.y_to_position" class="md-nav__link">
    <span class="md-ellipsis">
      y_to_position
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.spline.SplineConfig" class="md-nav__link">
    <span class="md-ellipsis">
      SplineConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SplineConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.spline.SplineConfig.construct" class="md-nav__link">
    <span class="md-ellipsis">
      construct
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.tomogram" class="md-nav__link">
    <span class="md-ellipsis">
      tomogram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram" class="md-nav__link">
    <span class="md-ellipsis">
      CylTomogram
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CylTomogram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.splines" class="md-nav__link">
    <span class="md-ellipsis">
      splines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.add_spline" class="md-nav__link">
    <span class="md-ellipsis">
      add_spline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.align_to_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      align_to_polarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.get_cylinder_model" class="md-nav__link">
    <span class="md-ellipsis">
      get_cylinder_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.global_cft" class="md-nav__link">
    <span class="md-ellipsis">
      global_cft
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.global_cft_params" class="md-nav__link">
    <span class="md-ellipsis">
      global_cft_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.global_cps" class="md-nav__link">
    <span class="md-ellipsis">
      global_cps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.infer_polarity" class="md-nav__link">
    <span class="md-ellipsis">
      infer_polarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_cft" class="md-nav__link">
    <span class="md-ellipsis">
      local_cft
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_cft_params" class="md-nav__link">
    <span class="md-ellipsis">
      local_cft_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_cps" class="md-nav__link">
    <span class="md-ellipsis">
      local_cps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.local_radii" class="md-nav__link">
    <span class="md-ellipsis">
      local_radii
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.make_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      make_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_centers" class="md-nav__link">
    <span class="md-ellipsis">
      map_centers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_monomers" class="md-nav__link">
    <span class="md-ellipsis">
      map_monomers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_on_grid" class="md-nav__link">
    <span class="md-ellipsis">
      map_on_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.map_pf_line" class="md-nav__link">
    <span class="md-ellipsis">
      map_pf_line
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.measure_radius" class="md-nav__link">
    <span class="md-ellipsis">
      measure_radius
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.refine" class="md-nav__link">
    <span class="md-ellipsis">
      refine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.straighten" class="md-nav__link">
    <span class="md-ellipsis">
      straighten
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.CylTomogram.straighten_cylindric" class="md-nav__link">
    <span class="md-ellipsis">
      straighten_cylindric
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram" class="md-nav__link">
    <span class="md-ellipsis">
      Tomogram
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tomogram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.image" class="md-nav__link">
    <span class="md-ellipsis">
      image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.is_dummy" class="md-nav__link">
    <span class="md-ellipsis">
      is_dummy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.is_inverted" class="md-nav__link">
    <span class="md-ellipsis">
      is_inverted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.metadata" class="md-nav__link">
    <span class="md-ellipsis">
      metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.multiscaled" class="md-nav__link">
    <span class="md-ellipsis">
      multiscaled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.source" class="md-nav__link">
    <span class="md-ellipsis">
      source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.tilt" class="md-nav__link">
    <span class="md-ellipsis">
      tilt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.tilt_model" class="md-nav__link">
    <span class="md-ellipsis">
      tilt_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.__hash__" class="md-nav__link">
    <span class="md-ellipsis">
      __hash__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram._get_multiscale_or_original" class="md-nav__link">
    <span class="md-ellipsis">
      _get_multiscale_or_original
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.add_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      add_multiscale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.dummy" class="md-nav__link">
    <span class="md-ellipsis">
      dummy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.from_image" class="md-nav__link">
    <span class="md-ellipsis">
      from_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.get_multiscale" class="md-nav__link">
    <span class="md-ellipsis">
      get_multiscale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.get_subtomogram_loader" class="md-nav__link">
    <span class="md-ellipsis">
      get_subtomogram_loader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.imread" class="md-nav__link">
    <span class="md-ellipsis">
      imread
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.multiscale_translation" class="md-nav__link">
    <span class="md-ellipsis">
      multiscale_translation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.nm2pixel" class="md-nav__link">
    <span class="md-ellipsis">
      nm2pixel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.tomogram.Tomogram.with_cache_info" class="md-nav__link">
    <span class="md-ellipsis">
      with_cache_info
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components._base" class="md-nav__link">
    <span class="md-ellipsis">
      _base
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent._dump" class="md-nav__link">
    <span class="md-ellipsis">
      _dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.from_json" class="md-nav__link">
    <span class="md-ellipsis">
      from_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.rescale" class="md-nav__link">
    <span class="md-ellipsis">
      rescale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components._base.BaseComponent.to_json" class="md-nav__link">
    <span class="md-ellipsis">
      to_json
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape" class="md-nav__link">
    <span class="md-ellipsis">
      landscape
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.AnnealingResult" class="md-nav__link">
    <span class="md-ellipsis">
      AnnealingResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape" class="md-nav__link">
    <span class="md-ellipsis">
      Landscape
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Landscape">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.offset" class="md-nav__link">
    <span class="md-ellipsis">
      offset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.offset_nm" class="md-nav__link">
    <span class="md-ellipsis">
      offset_nm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.create_surface" class="md-nav__link">
    <span class="md-ellipsis">
      create_surface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.cylindric_annealing_model" class="md-nav__link">
    <span class="md-ellipsis">
      cylindric_annealing_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.from_dir" class="md-nav__link">
    <span class="md-ellipsis">
      from_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.from_loader" class="md-nav__link">
    <span class="md-ellipsis">
      from_loader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.normed" class="md-nav__link">
    <span class="md-ellipsis">
      normed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_annealing" class="md-nav__link">
    <span class="md-ellipsis">
      run_annealing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_min_energy" class="md-nav__link">
    <span class="md-ellipsis">
      run_min_energy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_viterbi" class="md-nav__link">
    <span class="md-ellipsis">
      run_viterbi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.run_viterbi_fixed_start" class="md-nav__link">
    <span class="md-ellipsis">
      run_viterbi_fixed_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cylindra.components.landscape.Landscape.transform_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      transform_molecules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.SurfaceData" class="md-nav__link">
    <span class="md-ellipsis">
      SurfaceData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.ViterbiResult" class="md-nav__link">
    <span class="md-ellipsis">
      ViterbiResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape._update_mole_pos" class="md-nav__link">
    <span class="md-ellipsis">
      _update_mole_pos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.landscape.delayed_isosurface" class="md-nav__link">
    <span class="md-ellipsis">
      delayed_isosurface
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.seam_search" class="md-nav__link">
    <span class="md-ellipsis">
      seam_search
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.seam_search.CorrelationSeamSearcher" class="md-nav__link">
    <span class="md-ellipsis">
      CorrelationSeamSearcher
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cylindra.components.seam_search.SeamSearcher" class="md-nav__link">
    <span class="md-ellipsis">
      SeamSearcher
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SeamSearcher">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cylindra.components.seam_search.SeamSearcher.search" class="md-nav__link">
    <span class="md-ellipsis">
      search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="cylindracomponents">cylindra.components</h1>


<div class="doc doc-object doc-module">



<a id="cylindra.components.spline"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="cylindra.components.spline.CylSpline" class="doc doc-heading">
            <code>CylSpline</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code></p>


        <p>A spline object with cylindrical structure.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CylSpline</span><span class="p">(</span><span class="n">Spline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A spline object with cylindrical structure.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average radius of the cylinder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@radius</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">H</span><span class="o">.</span><span class="n">radius</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">drop_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius must be positive.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius got NaN value.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)])</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">radius_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rc</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the range of the radius used for the cylindric coordinate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius is not set.&quot;</span><span class="p">)</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rc</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">thickness_inner</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">rc</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">thickness_outer</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ori</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Orientation of the spline.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Ori</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">orientation</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)))</span>

    <span class="nd">@orientation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Ori</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">orientation</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)])])</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert the direction of spline. Also invert orientation if exists.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CylSpline</span>
<span class="sd">            Inverted object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: invert() calls clip() internally.</span>
        <span class="c1"># We don&#39;t have to invert the orientation here.</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clip spline and generate a new one.</span>

<span class="sd">        This method does not convert spline bases. ``_lims`` is updated instead.</span>
<span class="sd">        For instance, if you want to clip spline at 20% to 80% position, call</span>
<span class="sd">        ``spl.clip(0.2, 0.8)``. If ``stop &lt; start``, the orientation of spline</span>
<span class="sd">        will be inverted, thus the ``orientation`` attribute will also be inverted.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : float</span>
<span class="sd">            New starting position.</span>
<span class="sd">        stop : float</span>
<span class="sd">            New stopping position.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CylSpline</span>
<span class="sd">            Clipped spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

        <span class="n">clipped</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">clipped</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_glob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_glob</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">clipped</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clipped</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
        <span class="k">return</span> <span class="n">clipped</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore the original, not-clipped spline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Copy of the original spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">original</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
        <span class="k">return</span> <span class="n">original</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">nrise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw start number (minus for microtubule)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylinder_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">start</span>
        <span class="k">return</span> <span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rise_sign</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cylinder_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylinderParameters</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the cylinder parameters of the spline.&quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius is not known.&quot;</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thickness_outer</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thickness_inner</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">CylinderParameters</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">),</span>
            <span class="n">pitch</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">),</span>
            <span class="n">twist</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">),</span>
            <span class="n">skew</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">),</span>
            <span class="n">rise_angle</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">),</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">npf</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
            <span class="n">allow_duplicate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rise_sign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rise_sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cylinder_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylinderModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the cylinder model of the spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        offsets : tuple of float, optional</span>
<span class="sd">            Offset of the model. See :meth:`map_monomers` for details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CylinderModel</span>
<span class="sd">            The cylinder model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylinder_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ly</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">spacing_proj</span>
        <span class="n">la</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">lat_spacing_proj</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">ly</span> <span class="o">/</span> <span class="n">la</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">ly</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of monomers in y-direction</span>

        <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">CylinderModel</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">npf</span><span class="p">),</span>
            <span class="n">tilts</span><span class="o">=</span><span class="p">(</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">tan_skew</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">tan_rise_raw</span> <span class="o">/</span> <span class="n">factor</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">intervals</span><span class="o">=</span><span class="p">(</span><span class="n">ly</span><span class="p">,</span> <span class="n">la</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">perimeter</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_props</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">npf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the npf or orientation parameters in place.&quot;&quot;&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">]()</span>
        <span class="n">glob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]()</span>
        <span class="k">if</span> <span class="n">npf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">npf</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">))</span>
            <span class="n">glob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">npf</span><span class="p">])</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
            <span class="n">glob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">start</span><span class="p">])</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">glob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">orientation</span><span class="p">)])</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="p">,</span> <span class="n">glob</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_glob_by_cylinder_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cparams</span><span class="p">:</span> <span class="n">CylinderParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the global properties using a CylinderParameters object.&quot;&quot;&quot;</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">rise_angle</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">rise_length</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">rise_length</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">skew</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_need_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="ow">is</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either molecules&#39; orientation or the input orientation should &quot;</span>
                    <span class="s2">&quot;not be none.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.CylSpline.orientation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">orientation</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Orientation of the spline.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.CylSpline.radius" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">radius</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Average radius of the cylinder.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.clip" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Clip spline and generate a new one.</p>
<p>This method does not convert spline bases. <code>_lims</code> is updated instead.
For instance, if you want to clip spline at 20% to 80% position, call
<code>spl.clip(0.2, 0.8)</code>. If <code>stop &lt; start</code>, the orientation of spline
will be inverted, thus the <code>orientation</code> attribute will also be inverted.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New starting position.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stop</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New stopping position.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="CylSpline (cylindra.components.spline._cyl_spline.CylSpline)" href="#cylindra.components.spline.CylSpline">CylSpline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Clipped spline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip spline and generate a new one.</span>

<span class="sd">    This method does not convert spline bases. ``_lims`` is updated instead.</span>
<span class="sd">    For instance, if you want to clip spline at 20% to 80% position, call</span>
<span class="sd">    ``spl.clip(0.2, 0.8)``. If ``stop &lt; start``, the orientation of spline</span>
<span class="sd">    will be inverted, thus the ``orientation`` attribute will also be inverted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : float</span>
<span class="sd">        New starting position.</span>
<span class="sd">    stop : float</span>
<span class="sd">        New stopping position.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CylSpline</span>
<span class="sd">        Clipped spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clipped</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

    <span class="n">clipped</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">clipped</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_glob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_glob</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
        <span class="n">clipped</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clipped</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
    <span class="k">return</span> <span class="n">clipped</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.cylinder_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cylinder_model</span><span class="p">(</span><span class="n">offsets</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return the cylinder model of the spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>offsets</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Offset of the model. See :meth:<code>map_monomers</code> for details.</p>
              </div>
            </td>
            <td>
                  <code>(0.0, 0.0)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="cylindra.components.cylindric.CylinderModel">CylinderModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cylinder model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cylinder_model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylinderModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the cylinder model of the spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    offsets : tuple of float, optional</span>
<span class="sd">        Offset of the model. See :meth:`map_monomers` for details.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CylinderModel</span>
<span class="sd">        The cylinder model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylinder_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ly</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">spacing_proj</span>
    <span class="n">la</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">lat_spacing_proj</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">ly</span> <span class="o">/</span> <span class="n">la</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">ly</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of monomers in y-direction</span>

    <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CylinderModel</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">npf</span><span class="p">),</span>
        <span class="n">tilts</span><span class="o">=</span><span class="p">(</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">tan_skew</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">tan_rise_raw</span> <span class="o">/</span> <span class="n">factor</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">intervals</span><span class="o">=</span><span class="p">(</span><span class="n">ly</span><span class="p">,</span> <span class="n">la</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">perimeter</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.cylinder_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cylinder_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get the cylinder parameters of the spline.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cylinder_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylinderParameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the cylinder parameters of the spline.&quot;&quot;&quot;</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius is not known.&quot;</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thickness_outer</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thickness_inner</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">CylinderParameters</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
        <span class="n">spacing</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">),</span>
        <span class="n">pitch</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">),</span>
        <span class="n">twist</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">),</span>
        <span class="n">skew</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">),</span>
        <span class="n">rise_angle</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">),</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">npf</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">),</span>
        <span class="n">start</span><span class="o">=</span><span class="n">_get_globalprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
        <span class="n">allow_duplicate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">rise_sign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rise_sign</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.invert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invert</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Invert the direction of spline. Also invert orientation if exists.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="CylSpline (cylindra.components.spline._cyl_spline.CylSpline)" href="#cylindra.components.spline.CylSpline">CylSpline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverted object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invert the direction of spline. Also invert orientation if exists.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CylSpline</span>
<span class="sd">        Inverted object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: invert() calls clip() internally.</span>
    <span class="c1"># We don&#39;t have to invert the orientation here.</span>
    <span class="n">new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
    <span class="n">new</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.nrise" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">nrise</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Raw start number (minus for microtubule)</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">nrise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raw start number (minus for microtubule)&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylinder_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">start</span>
    <span class="k">return</span> <span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rise_sign</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.radius_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">radius_range</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return the range of the radius used for the cylindric coordinate.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">radius_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rc</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the range of the radius used for the cylindric coordinate.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius is not set.&quot;</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rc</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">thickness_inner</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">rc</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">thickness_outer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.restore" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">restore</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Restore the original, not-clipped spline.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Copy of the original spline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restore the original, not-clipped spline.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Copy of the original spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
        <span class="n">original</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">original</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
    <span class="k">return</span> <span class="n">original</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.update_glob_by_cylinder_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_glob_by_cylinder_params</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Update the global properties using a CylinderParameters object.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_glob_by_cylinder_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cparams</span><span class="p">:</span> <span class="n">CylinderParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the global properties using a CylinderParameters object.&quot;&quot;&quot;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">rise_angle</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">rise_length</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">rise_length</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">skew</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
        <span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">:</span> <span class="n">cparams</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.CylSpline.update_props" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_props</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">npf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Update the npf or orientation parameters in place.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_cyl_spline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_props</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">npf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the npf or orientation parameters in place.&quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">]()</span>
    <span class="n">glob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]()</span>
    <span class="k">if</span> <span class="n">npf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">npf</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">))</span>
        <span class="n">glob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">npf</span><span class="p">])</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="n">glob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">start</span><span class="p">])</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">glob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">orientation</span><span class="p">)])</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span> <span class="o">=</span> <span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="p">,</span> <span class="n">glob</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.spline.Spline" class="doc doc-heading">
            <code>Spline</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseComponent (cylindra.components._base.BaseComponent)" href="#cylindra.components._base.BaseComponent">BaseComponent</a></code></p>


        <p>3D spline curve model with coordinate system.</p>
<p>Anchor points can be set via <code>anchor</code> property. A spline object is semi-immutable.
Different spline curves are always of different objects, but the anchors and
properties can be dynamically changed.</p>


<details class="references" open>
  <summary>References</summary>
  <ul>
<li>Scipy document
  https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.splprep.html</li>
</ul>
</details>






              <details class="quote">
                <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Spline</span><span class="p">(</span><span class="n">BaseComponent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;3D spline curve model with coordinate system.</span>

<span class="sd">    Anchor points can be set via `anchor` property. A spline object is semi-immutable.</span>
<span class="sd">    Different spline curves are always of different objects, but the anchors and</span>
<span class="sd">    properties can be dynamically changed.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    - Scipy document</span>
<span class="sd">      https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.splprep.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lims</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">extrapolate</span><span class="p">:</span> <span class="n">ExtrapolationMode</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">:</span> <span class="n">TCKType</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extrapolate</span> <span class="o">=</span> <span class="n">ExtrapolationMode</span><span class="p">(</span><span class="n">extrapolate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span> <span class="o">=</span> <span class="n">lims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">SplineProps</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">SplineConfig</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">props</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineProps</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the spline properties&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the spline configuration&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_props</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if there are any properties.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_props</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">copy_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy Spline object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        copy_props : bool, default True</span>
<span class="sd">            Also copy local/global properties if true.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Copied object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span>
        <span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>

        <span class="k">if</span> <span class="n">copy_props</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">copy_config</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">copy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_extrapolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extrapolate</span><span class="p">:</span> <span class="n">ExtrapolationMode</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a copy of the spline with a new extrapolation mode.&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_extrapolate</span> <span class="o">=</span> <span class="n">ExtrapolationMode</span><span class="p">(</span><span class="n">extrapolate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span><span class="p">,</span>
        <span class="n">copy_props</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a copy of the spline with a new config.&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">copy_props</span><span class="o">=</span><span class="n">copy_props</span><span class="p">,</span> <span class="n">copy_config</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">SplineConfig</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">knots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spline knots.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spline coefficient.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spline order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extrapolate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExtrapolationMode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extrapolation mode of the spline.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extrapolate</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spline parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a linear spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : array_like</span>
<span class="sd">            Start point of the line.</span>
<span class="sd">        end : array_like</span>
<span class="sd">            End point of the line.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Line spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the spline by given shift vectors.&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if there are any anchors.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Local anchors along spline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Anchor has not been set yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>

    <span class="nd">@anchors</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_anc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_anc</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Could not convert positions into 1D array.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_anc</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">_anc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Anchor positions should be set between 0 and 1. Otherwise spline &quot;</span>
                <span class="s2">&quot;curve does not fit well.&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_old</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">_anc</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">_old</span><span class="o">.</span><span class="n">size</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">_anc</span><span class="p">,</span> <span class="n">_old</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">clear_loc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span> <span class="o">=</span> <span class="n">_anc</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@anchors</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">clear_loc</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_inverted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return true if spline is inverted.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return spline limit positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="n">tck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="n">u</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prep_anchor_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stop</span><span class="p">,</span> <span class="n">n_segs</span> <span class="o">=</span> <span class="n">interval_divmod</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n_segs</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">length</span>
        <span class="k">elif</span> <span class="n">max_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ceilint</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">max_interval</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either &#39;interval&#39; or &#39;n&#39; must be specified.&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_anchors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make anchor points at constant intervals.</span>

<span class="sd">        Either interval, number of anchor or the maximum interval between anchors can be</span>
<span class="sd">        specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interval : nm, optional</span>
<span class="sd">            Interval between anchor points.</span>
<span class="sd">        n : int, optional</span>
<span class="sd">            Number of anchor points, including both ends.</span>
<span class="sd">        max_interval: nm, optional</span>
<span class="sd">            Spline will be split by as little anchors as possible but interval between</span>
<span class="sd">            anchors will not be larger than this. The number of anchors are also</span>
<span class="sd">            guaranteed to be larger than spline order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">max_interval</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use start/end points to describe a spline.&quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Spline[</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close_to</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if two objects draws the same curve.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">t0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">k0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_tck</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">k0</span> <span class="o">==</span> <span class="n">k1</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_u</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clip spline and generate a new one.</span>

<span class="sd">        This method does not convert spline bases. `_lims` is updated instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : float</span>
<span class="sd">            New starting position.</span>
<span class="sd">        stop : float</span>
<span class="sd">            New stopping position.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Clipped spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u0</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">lims</span><span class="o">=</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">),</span>
            <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore the original, not-clipped spline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Copy of the original spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">lims</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample a new spline along the original spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_interval : nm, default 1.0</span>
<span class="sd">            Maximum interval between resampling points.</span>
<span class="sd">        err_max : float, default 0.1</span>
<span class="sd">            Spline fitting maximum error.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Resampled spline object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ceilint</span><span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">max_interval</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit spline model to coordinates.</span>

<span class="sd">        This method uses `scipy.interpolate.splprep` to fit given coordinates to a</span>
<span class="sd">        spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : np.ndarray</span>
<span class="sd">            Coordinates. Must be (N, 3).</span>
<span class="sd">        err_max : float, default 1.0</span>
<span class="sd">            Error allowed for fitting. Several upper limit of residual values will be</span>
<span class="sd">            used and the fit that results in error lower than this value and minimize</span>
<span class="sd">            the maximum curvature will be chosen.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            New spline fit to given coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">npoints</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of input coordinates must be &gt; 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npoints</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_inverted</span><span class="p">():</span>
            <span class="n">crds</span> <span class="o">=</span> <span class="n">crds</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">err_max</span> <span class="o">&gt;</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;std_max must be smaller than 4.0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err_max</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">std_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">err_max</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrial</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">err_max</span> <span class="o">/</span> <span class="mf">0.02</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">std_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">err_max</span><span class="p">,</span> <span class="n">ntrial</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">fit_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">SplineFitResult</span><span class="p">]()</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># fitting may fail for some std</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">std_list</span><span class="p">:</span>
                <span class="n">_tck</span><span class="p">,</span> <span class="n">_u</span> <span class="o">=</span> <span class="n">splprep</span><span class="p">(</span><span class="n">crds</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">std</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">npoints</span><span class="p">)</span>
                <span class="n">new</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="n">_tck</span><span class="p">,</span> <span class="n">_u</span><span class="p">)</span>
                <span class="n">_crds_at_u</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_u</span><span class="p">)</span>
                <span class="n">res</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">_crds_at_u</span> <span class="o">-</span> <span class="n">crds</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">_knots</span> <span class="o">=</span> <span class="n">_tck</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">new</span><span class="o">.</span><span class="n">order</span> <span class="p">:</span> <span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">order</span><span class="p">]</span>
                <span class="n">nedge</span> <span class="o">=</span> <span class="n">_knots</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">nedge</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">nanc</span> <span class="o">=</span> <span class="n">nedge</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">anc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nanc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nedge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">_knots</span>
                <span class="p">)</span>
                <span class="n">max_curvature</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">curvature</span><span class="p">(</span><span class="n">anc</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">err_max</span>
                <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">SplineFitResult</span><span class="p">((</span><span class="n">_tck</span><span class="p">,</span> <span class="n">_u</span><span class="p">),</span> <span class="n">max_curvature</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">fit_results_filt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">success</span><span class="p">,</span> <span class="n">fit_results</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_results_filt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_results_filt</span> <span class="o">=</span> <span class="n">fit_results</span>

        <span class="n">reult_opt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fit_results_filt</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">curvature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="o">*</span><span class="n">reult_opt</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shift</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shifts</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit spline model using a list of shifts in XZ-plane.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : sequence of float, optional</span>
<span class="sd">            Positions. Between 0 and 1. If not given, anchors are used instead.</span>
<span class="sd">        shifts : np.ndarray</span>
<span class="sd">            Shift from center in nm. Must be (N, 2).</span>
<span class="sd">        err_max : float, default 1.0</span>
<span class="sd">            Error allowed for fitting. See `Spline.fit`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Spline shifted by fitting to given coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shifts must be given.&quot;</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotator</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="c1"># insert 0 in y coordinates.</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rot</span><span class="p">)),</span> <span class="n">shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">+=</span> <span class="n">rot</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">distances</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the distances from u=0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : sequence of float, optional</span>
<span class="sd">            Positions. Between 0 and 1. If not given, anchors are used instead.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Distances for each `u`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Positions must be 1D array.&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="p">)</span>
        <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">tck</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">_u</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate coordinates (or n-th derivative) at points on the spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : np.ndarray or float, optional</span>
<span class="sd">            Positions. Between 0 and 1. If not given, anchors are used instead.</span>
<span class="sd">        der : int, default 0</span>
<span class="sd">            `der`-th derivative will be calculated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Positions or vectors in (3,) or (N, 3) shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_assert_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
        <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">der</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">u_tr</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="n">u_tr</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">u_tr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">der0</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">der1</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">der0</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">der1</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">dr</span> <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">der0</span><span class="p">,</span> <span class="n">der1</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">u_tr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">coord</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">coord</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrapolation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">der</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">u_tr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span>
                <span class="n">sl_small</span> <span class="o">=</span> <span class="n">u_tr</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="n">sl_large</span> <span class="o">=</span> <span class="n">u_tr</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="n">n_small</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">sl_small</span><span class="p">)</span>
                <span class="n">n_large</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">sl_large</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n_small</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">der0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                        <span class="n">der1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                        <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span>
                        <span class="n">coords_new</span> <span class="o">=</span> <span class="n">der0</span> <span class="o">+</span> <span class="n">der1</span> <span class="o">*</span> <span class="n">dr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords_new</span>

                    <span class="k">if</span> <span class="n">n_large</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">der0</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">der1</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">coords_new</span> <span class="o">=</span> <span class="n">der0</span> <span class="o">+</span> <span class="n">der1</span> <span class="o">*</span> <span class="n">dr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords_new</span>

                <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n_small</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n_large</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n_small</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">n_large</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrapolation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u0</span> <span class="o">&gt;</span> <span class="n">u1</span> <span class="ow">and</span> <span class="n">der</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="nb">map</span>  <span class="c1"># scipy-style alias</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the n-partitioning coordinates of the spline.&quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">der</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the length of the spline.</span>

<span class="sd">        This method approximates the length of B-spline between [start, stop] by</span>
<span class="sd">        partitioning the spline with &#39;nknots&#39; knots. nknots=256 is large enough for most</span>
<span class="sd">        cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_assert_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">nknots</span><span class="p">)</span>
        <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the direction of spline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Inverted object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>
        <span class="n">inverted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anchors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inverted</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">anchors</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">inverted</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">at</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
        <span class="n">from_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trim</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">allow_discard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the spline at the given position.&quot;&quot;&quot;</span>
        <span class="n">spl_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_start</span><span class="p">:</span>
            <span class="n">at</span> <span class="o">=</span> <span class="n">spl_len</span> <span class="o">-</span> <span class="n">at</span>
        <span class="n">at_rel_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">at</span> <span class="o">-</span> <span class="n">trim</span><span class="p">)</span> <span class="o">/</span> <span class="n">spl_len</span>
        <span class="n">at_rel_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">at</span> <span class="o">+</span> <span class="n">trim</span><span class="p">)</span> <span class="o">/</span> <span class="n">spl_len</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Self&quot;</span><span class="p">]()</span>
        <span class="k">if</span> <span class="n">at_rel_0</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">at_rel_0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">allow_discard</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Split position must be over `trim` if allow_discard is False, but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;tried to split at </span><span class="si">{</span><span class="n">at</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> nm.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">at_rel_1</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">at_rel_1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">allow_discard</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Split position must be under `length - trim` if allow_discard is &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;False, but tried to split at </span><span class="si">{</span><span class="n">at</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> nm (length = </span><span class="si">{</span><span class="n">spl_len</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">curvature</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate curvature of spline curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : sequence of float, optional</span>
<span class="sd">            Positions. Between 0 and 1. If not given, anchors are used instead.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array of curvature.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        - https://en.wikipedia.org/wiki/Curvature#Space_curves</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>

        <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">ddz</span><span class="p">,</span> <span class="n">ddy</span><span class="p">,</span> <span class="n">ddx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">ddz</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">-</span> <span class="n">ddy</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">ddx</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">-</span> <span class="n">ddz</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">ddy</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">-</span> <span class="n">ddx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">curvature_radii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse of curvature.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvature</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert spline info into a dict.&quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()},</span>
            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s2">&quot;lims&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">,</span>
            <span class="s2">&quot;localprops_window_size&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">window_size</span><span class="p">),</span>
            <span class="s2">&quot;binsize_loc&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">binsize_loc</span><span class="p">),</span>
            <span class="s2">&quot;binsize_glob&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">binsize_glob</span><span class="p">),</span>
            <span class="s2">&quot;extrapolate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extrapolate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span> <span class="n">d</span><span class="p">:</span> <span class="n">SplineInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a spline model from a dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d: dict</span>
<span class="sd">            Dictionary with keys &quot;t&quot;, &quot;c&quot;, &quot;k&quot;, &quot;u&quot; and &quot;lims&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Spline</span>
<span class="sd">            Spline object constructed from the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">lims</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lims&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">extrapolate</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s2">&quot;zyx&quot;</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_window_size</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;localprops_window_size&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_loc</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;binsize_loc&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_glob</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;binsize_glob&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">cfg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_rotator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rotation</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate list of Affine transformation matrix along spline.</span>

<span class="sd">        The matrices correspond to the orientation of spline curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : array-like, (N,)</span>
<span class="sd">            Positions. Between 0 and 1.</span>
<span class="sd">        inverse : bool, default False</span>
<span class="sd">            If True, rotation matrix will be inversed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Rotation</span>
<span class="sd">            Rotation object at each anchor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">axes_to_rotator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">local_cartesian</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
        <span class="n">u</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate local Cartesian coordinate systems.</span>

<span class="sd">        The generated array can be used for `ndi.map_coordinates`. The result coordinate</span>
<span class="sd">        systems are flat, i.e., not distorted by the curvature of spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape : (float, float)</span>
<span class="sd">            Vertical and horizontal length of Cartesian coordinates. Corresponds to zx</span>
<span class="sd">            axes.</span>
<span class="sd">        depth : float</span>
<span class="sd">            Length of y axis in nm.</span>
<span class="sd">        u : float, optional</span>
<span class="sd">            Position on the spline at which local Cartesian coordinates will be built.</span>
<span class="sd">        scale: nm, default 1.0</span>
<span class="sd">            Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            (D, V, S, H) shape. Each cooresponds to dimensional vertical, longitudinal</span>
<span class="sd">            and horizontal axis, which is ready to be used in `ndi.map_coordinates`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors_to_molecules</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">depth</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mole</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">local_cylindrical</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">r_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
        <span class="n">u</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate local cylindrical coordinate systems.</span>

<span class="sd">        The generated array can be used for `ndi.map_coordinates`. The result coordinate</span>
<span class="sd">        systems are flat, i.e., not distorted by the curvature of spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r_range : (float, float)</span>
<span class="sd">            Lower and upper bound of radius in nm.</span>
<span class="sd">        depth : nm</span>
<span class="sd">            Length of y axis in nm.</span>
<span class="sd">        u : float</span>
<span class="sd">            Position on the spline at which local cylindrical coordinates will be built.</span>
<span class="sd">        scale: nm, default 1.0</span>
<span class="sd">            Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            (D, V, S, H) shape. Each cooresponds to dimensional, radius, longitudinal</span>
<span class="sd">            and angle axis, which is ready to be used in `ndi.map_coordinates`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
        <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">r_range</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ds_norm</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ds</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">depth_px</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">depth</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">depth_px</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">depth_px</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">depth_px</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">ds_norm</span> <span class="o">*</span> <span class="n">grid</span>
        <span class="n">y_ax_coords</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dslist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ds</span><span class="p">]</span> <span class="o">*</span> <span class="n">depth_px</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">map_</span> <span class="o">=</span> <span class="n">polar_coords_2d</span><span class="p">(</span><span class="n">rmin</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">map_slice</span> <span class="o">=</span> <span class="n">_stack_coords</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_rot_with_vector</span><span class="p">(</span><span class="n">map_slice</span><span class="p">,</span> <span class="n">y_ax_coords</span><span class="p">,</span> <span class="n">dslist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cartesian</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
        <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a Cartesian coordinate system along spline.</span>

<span class="sd">        Generated coordinate can be used for `ndi.map_coordinate`. Note that this</span>
<span class="sd">        coordinate system is distorted, thus does not reflect real geometry (such as</span>
<span class="sd">        distance and derivatives).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape : (float, float)</span>
<span class="sd">            The ZX-shape of output coordinate system. Center of the array will be</span>
<span class="sd">            spline curve itself after coodinate transformation.</span>
<span class="sd">        s_range : tuple[float, float], default (0, 1)</span>
<span class="sd">            Range of spline. Spline coordinate system will be built between</span>
<span class="sd">            `spl[s_range[0]]` and `spl[s_range[1]]`.</span>
<span class="sd">        scale: nm, default 1.0</span>
<span class="sd">            Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            (V, S, H, D) shape. Each cooresponds to vertical, longitudinal, horizontal</span>
<span class="sd">            and dimensional axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords</span><span class="p">(</span><span class="n">_cartesian_coords_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">dz</span><span class="p">,</span> <span class="n">dx</span><span class="p">),</span> <span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cylindrical</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">r_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
        <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a cylindrical coordinate system along spline.</span>

<span class="sd">        Generated coordinate can be used for `ndi.map_coordinate`. Note that this</span>
<span class="sd">        coordinate system is distorted, thus does not reflect real geometry (such as</span>
<span class="sd">        distance and derivatives).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r_range : (nm, nm)</span>
<span class="sd">            Range of radius in nm. r=0 will be spline curve itself after coodinate</span>
<span class="sd">            transformation.</span>
<span class="sd">        s_range : tuple[float, float], default (0, 1)</span>
<span class="sd">            Range of spline. Spline coordinate system will be built between</span>
<span class="sd">            `spl[s_range[0]]` and `spl[s_range[1]]`.</span>
<span class="sd">        scale: nm, default 1.0</span>
<span class="sd">            Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            (V, S, H, D) shape. Each cooresponds to radius, longitudinal, angle and</span>
<span class="sd">            dimensional axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rmin</span> <span class="o">=</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords</span><span class="p">(</span><span class="n">polar_coords_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">y_to_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span> <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert y-coordinate to spline position parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y : array-like</span>
<span class="sd">            Y coordinates.</span>
<span class="sd">        nknots : int, optional</span>
<span class="sd">            Number of knots. Increasing the number of knots will increase the accuracy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># almost equal to y / self.length()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="p">)</span>
        <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
        <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">tck</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cartesian_to_world</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
        <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse Cartesian coordinate mapping, (z&#39;, y&#39;, x&#39;) to world coordinate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : np.ndarray</span>
<span class="sd">            Spline Cartesian coordinates. All the coordinates must be in nm unit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            World coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ncoords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_zs</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">_us</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nknots</span><span class="o">=</span><span class="n">nknots</span><span class="p">)</span>
        <span class="n">_xs</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncoords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">coords_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">_zs</span><span class="p">,</span> <span class="n">_zeros</span><span class="p">,</span> <span class="n">_xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotator</span><span class="p">(</span><span class="n">_us</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">coords_ext</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_us</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cylindrical_to_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse cylindrical coordinate mapping, (r, y, angle) to world coordinate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : np.ndarray</span>
<span class="sd">            Cylindrical coordinates. &quot;r&quot; and &quot;y&quot; must be in scale of &quot;nm&quot;, while angle</span>
<span class="sd">            must be in radian.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            World coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">cart_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cartesian_to_world</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">anchors_to_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rotation</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert coordinates of anchors to `Molecules` instance.</span>

<span class="sd">        Coordinates of anchors must be in range from 0 to 1. The y-direction of</span>
<span class="sd">        `Molecules` always points at the direction of spline and the z- direction always</span>
<span class="sd">        in the plane orthogonal to YX-plane.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : iterable of float, optional</span>
<span class="sd">            Positions. Between 0 and 1. If not given, anchors are used instead.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Molecules object of points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">positions</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">yvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">axes_to_rotator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">yvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rotvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">rotvec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">*</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">rotvec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="n">rot</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="p">{</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">))})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cylindrical_to_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert coordinates of points near the spline to `Molecules` instance.</span>

<span class="sd">        Coordinates of points must be those in spline cylindrical coordinate system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : (N, 3) array</span>
<span class="sd">            Spline cylindrical coordinates of points.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Molecules object of points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylindrical_to_world</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># world coordinates of the projection point of coords onto the spline</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ycoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">zvec</span> <span class="o">=</span> <span class="n">world_coords</span> <span class="o">-</span> <span class="n">ycoords</span>
        <span class="n">yvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Molecules</span><span class="o">.</span><span class="n">from_axes</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">world_coords</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">zvec</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yvec</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="n">_t</span><span class="p">,</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">*</span> <span class="n">factor</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_c</span><span class="p">]</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_coords</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">map_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]],</span>
        <span class="n">map_params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make coordinate system using function `map_func` and stack the same point cloud</span>
<span class="sd">        in the direction of the spline, in the range of `s_range`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">y_ax_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_y_ax_coords</span><span class="p">(</span><span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">dslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">map_</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="o">*</span><span class="n">map_params</span><span class="p">)</span>
        <span class="n">map_slice</span> <span class="o">=</span> <span class="n">_stack_coords</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_rot_with_vector</span><span class="p">(</span><span class="n">map_slice</span><span class="p">,</span> <span class="n">y_ax_coords</span><span class="p">,</span> <span class="n">dslist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_y_ax_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span><span class="p">):</span>
        <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">s_range</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">s0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">s1</span><span class="p">)</span>
        <span class="n">stop_length</span><span class="p">,</span> <span class="n">n_segs</span> <span class="o">=</span> <span class="n">interval_divmod</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">n_pixels</span> <span class="o">=</span> <span class="n">n_segs</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1</span> <span class="o">-</span> <span class="n">s0</span><span class="p">)</span> <span class="o">*</span> <span class="n">stop_length</span> <span class="o">/</span> <span class="n">length</span> <span class="o">+</span> <span class="n">s0</span>
        <span class="k">if</span> <span class="n">n_pixels</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Too short. Change &#39;s_range&#39;.&quot;</span><span class="p">)</span>
        <span class="n">d0</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">([</span><span class="n">s0</span><span class="p">,</span> <span class="n">s2</span><span class="p">])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>  <span class="c1"># world coordinates of y-axis in spline coords system</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">anchors</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-deletable"><code>deletable</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Local anchors along spline.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.coeff" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coeff</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Spline coefficient.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Return the spline configuration</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.extrapolate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extrapolate</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Extrapolation mode of the spline.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.has_anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">has_anchors</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>True if there are any anchors.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.knots" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">knots</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Spline knots.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.lims" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">lims</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Return spline limit positions.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.order" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">order</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Spline order.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">params</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Spline parameters.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.spline.Spline.props" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">props</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Return the spline properties</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Use start/end points to describe a spline.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use start/end points to describe a spline.&quot;&quot;&quot;</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">, </span><span class="si">{:.1f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Spline[</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">]&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline._get_coords" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_coords</span><span class="p">(</span><span class="n">map_func</span><span class="p">,</span> <span class="n">map_params</span><span class="p">,</span> <span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Make coordinate system using function <code>map_func</code> and stack the same point cloud
in the direction of the spline, in the range of <code>s_range</code>.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_coords</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">map_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]],</span>
    <span class="n">map_params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make coordinate system using function `map_func` and stack the same point cloud</span>
<span class="sd">    in the direction of the spline, in the range of `s_range`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">y_ax_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_y_ax_coords</span><span class="p">(</span><span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">dslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">map_</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="o">*</span><span class="n">map_params</span><span class="p">)</span>
    <span class="n">map_slice</span> <span class="o">=</span> <span class="n">_stack_coords</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">_rot_with_vector</span><span class="p">(</span><span class="n">map_slice</span><span class="p">,</span> <span class="n">y_ax_coords</span><span class="p">,</span> <span class="n">dslist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.anchors_to_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">anchors_to_molecules</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Convert coordinates of anchors to <code>Molecules</code> instance.</p>
<p>Coordinates of anchors must be in range from 0 to 1. The y-direction of
<code>Molecules</code> always points at the direction of spline and the z- direction always
in the plane orthogonal to YX-plane.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code>iterable of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions. Between 0 and 1. If not given, anchors are used instead.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules object of points.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">anchors_to_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rotation</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert coordinates of anchors to `Molecules` instance.</span>

<span class="sd">    Coordinates of anchors must be in range from 0 to 1. The y-direction of</span>
<span class="sd">    `Molecules` always points at the direction of spline and the z- direction always</span>
<span class="sd">    in the plane orthogonal to YX-plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : iterable of float, optional</span>
<span class="sd">        Positions. Between 0 and 1. If not given, anchors are used instead.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Molecules object of points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">positions</span><span class="p">]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">yvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">axes_to_rotator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">yvec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rotvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">rotvec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">*</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">rotvec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="n">rot</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="p">{</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">))})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.cartesian" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cartesian</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">s_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generate a Cartesian coordinate system along spline.</p>
<p>Generated coordinate can be used for <code>ndi.map_coordinate</code>. Note that this
coordinate system is distorted, thus does not reflect real geometry (such as
distance and derivatives).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>shape</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ZX-shape of output coordinate system. Center of the array will be
spline curve itself after coodinate transformation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>s_range</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of spline. Spline coordinate system will be built between
<code>spl[s_range[0]]</code> and <code>spl[s_range[1]]</code>.</p>
              </div>
            </td>
            <td>
                  <code>(0, 1)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale of coordinates, i.e. spacing of the grid.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(V, S, H, D) shape. Each cooresponds to vertical, longitudinal, horizontal
and dimensional axis.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cartesian</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
    <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a Cartesian coordinate system along spline.</span>

<span class="sd">    Generated coordinate can be used for `ndi.map_coordinate`. Note that this</span>
<span class="sd">    coordinate system is distorted, thus does not reflect real geometry (such as</span>
<span class="sd">    distance and derivatives).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : (float, float)</span>
<span class="sd">        The ZX-shape of output coordinate system. Center of the array will be</span>
<span class="sd">        spline curve itself after coodinate transformation.</span>
<span class="sd">    s_range : tuple[float, float], default (0, 1)</span>
<span class="sd">        Range of spline. Spline coordinate system will be built between</span>
<span class="sd">        `spl[s_range[0]]` and `spl[s_range[1]]`.</span>
<span class="sd">    scale: nm, default 1.0</span>
<span class="sd">        Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        (V, S, H, D) shape. Each cooresponds to vertical, longitudinal, horizontal</span>
<span class="sd">        and dimensional axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords</span><span class="p">(</span><span class="n">_cartesian_coords_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">dz</span><span class="p">,</span> <span class="n">dx</span><span class="p">),</span> <span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.cartesian_to_world" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cartesian_to_world</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Inverse Cartesian coordinate mapping, (z', y', x') to world coordinate.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline Cartesian coordinates. All the coordinates must be in nm unit.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>World coordinates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cartesian_to_world</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
    <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inverse Cartesian coordinate mapping, (z&#39;, y&#39;, x&#39;) to world coordinate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : np.ndarray</span>
<span class="sd">        Spline Cartesian coordinates. All the coordinates must be in nm unit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        World coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ncoords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_zs</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">_us</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nknots</span><span class="o">=</span><span class="n">nknots</span><span class="p">)</span>
    <span class="n">_xs</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncoords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">coords_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">_zs</span><span class="p">,</span> <span class="n">_zeros</span><span class="p">,</span> <span class="n">_xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotator</span><span class="p">(</span><span class="n">_us</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">coords_ext</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_us</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.clip" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Clip spline and generate a new one.</p>
<p>This method does not convert spline bases. <code>_lims</code> is updated instead.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New starting position.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stop</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New stopping position.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Clipped spline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clip spline and generate a new one.</span>

<span class="sd">    This method does not convert spline bases. `_lims` is updated instead.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : float</span>
<span class="sd">        New starting position.</span>
<span class="sd">    stop : float</span>
<span class="sd">        New stopping position.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Clipped spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
        <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
        <span class="n">lims</span><span class="o">=</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">),</span>
        <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.close_to" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close_to</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>True if two objects draws the same curve.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close_to</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;True if two objects draws the same curve.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">t0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">k0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
    <span class="n">t1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_tck</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="ow">and</span> <span class="n">k0</span> <span class="o">==</span> <span class="n">k1</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_u</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.copy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="n">copy_props</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Copy Spline object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>copy_props</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Also copy local/global properties if true.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Copied object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_props</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">copy_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy Spline object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    copy_props : bool, default True</span>
<span class="sd">        Also copy local/global properties if true.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Copied object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
        <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span>
    <span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>

    <span class="k">if</span> <span class="n">copy_props</span><span class="p">:</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">copy_config</span><span class="p">:</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.curvature" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">curvature</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate curvature of spline curve.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code>sequence of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions. Between 0 and 1. If not given, anchors are used instead.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of curvature.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="references" open>
  <summary>References</summary>
  <ul>
<li>https://en.wikipedia.org/wiki/Curvature#Space_curves</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">curvature</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate curvature of spline curve.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : sequence of float, optional</span>
<span class="sd">        Positions. Between 0 and 1. If not given, anchors are used instead.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Array of curvature.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    - https://en.wikipedia.org/wiki/Curvature#Space_curves</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>

    <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ddz</span><span class="p">,</span> <span class="n">ddy</span><span class="p">,</span> <span class="n">ddx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">ddz</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">-</span> <span class="n">ddy</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">ddx</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">-</span> <span class="n">ddz</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">ddy</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">-</span> <span class="n">ddx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.curvature_radii" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">curvature_radii</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Inverse of curvature.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">curvature_radii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inverse of curvature.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvature</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.cylindrical" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cylindrical</span><span class="p">(</span><span class="n">r_range</span><span class="p">,</span> <span class="n">s_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generate a cylindrical coordinate system along spline.</p>
<p>Generated coordinate can be used for <code>ndi.map_coordinate</code>. Note that this
coordinate system is distorted, thus does not reflect real geometry (such as
distance and derivatives).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>r_range</code>
            </td>
            <td>
                  <code>(<span title="cylindra.const.nm">nm</span>, <span title="cylindra.const.nm">nm</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of radius in nm. r=0 will be spline curve itself after coodinate
transformation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>s_range</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of spline. Spline coordinate system will be built between
<code>spl[s_range[0]]</code> and <code>spl[s_range[1]]</code>.</p>
              </div>
            </td>
            <td>
                  <code>(0, 1)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale of coordinates, i.e. spacing of the grid.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(V, S, H, D) shape. Each cooresponds to radius, longitudinal, angle and
dimensional axis.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cylindrical</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">r_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
    <span class="n">s_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a cylindrical coordinate system along spline.</span>

<span class="sd">    Generated coordinate can be used for `ndi.map_coordinate`. Note that this</span>
<span class="sd">    coordinate system is distorted, thus does not reflect real geometry (such as</span>
<span class="sd">    distance and derivatives).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_range : (nm, nm)</span>
<span class="sd">        Range of radius in nm. r=0 will be spline curve itself after coodinate</span>
<span class="sd">        transformation.</span>
<span class="sd">    s_range : tuple[float, float], default (0, 1)</span>
<span class="sd">        Range of spline. Spline coordinate system will be built between</span>
<span class="sd">        `spl[s_range[0]]` and `spl[s_range[1]]`.</span>
<span class="sd">    scale: nm, default 1.0</span>
<span class="sd">        Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        (V, S, H, D) shape. Each cooresponds to radius, longitudinal, angle and</span>
<span class="sd">        dimensional axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords</span><span class="p">(</span><span class="n">polar_coords_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">s_range</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.cylindrical_to_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cylindrical_to_molecules</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Convert coordinates of points near the spline to <code>Molecules</code> instance.</p>
<p>Coordinates of points must be those in spline cylindrical coordinate system.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code>(N, 3) array</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline cylindrical coordinates of points.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules object of points.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cylindrical_to_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert coordinates of points near the spline to `Molecules` instance.</span>

<span class="sd">    Coordinates of points must be those in spline cylindrical coordinate system.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : (N, 3) array</span>
<span class="sd">        Spline cylindrical coordinates of points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Molecules object of points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">world_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylindrical_to_world</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

    <span class="c1"># world coordinates of the projection point of coords onto the spline</span>
    <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ycoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">zvec</span> <span class="o">=</span> <span class="n">world_coords</span> <span class="o">-</span> <span class="n">ycoords</span>
    <span class="n">yvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Molecules</span><span class="o">.</span><span class="n">from_axes</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">world_coords</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">zvec</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yvec</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.cylindrical_to_world" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cylindrical_to_world</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Inverse cylindrical coordinate mapping, (r, y, angle) to world coordinate.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cylindrical coordinates. "r" and "y" must be in scale of "nm", while angle
must be in radian.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>World coordinates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span>
<span class="normal">994</span>
<span class="normal">995</span>
<span class="normal">996</span>
<span class="normal">997</span>
<span class="normal">998</span>
<span class="normal">999</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cylindrical_to_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inverse cylindrical coordinate mapping, (r, y, angle) to world coordinate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : np.ndarray</span>
<span class="sd">        Cylindrical coordinates. &quot;r&quot; and &quot;y&quot; must be in scale of &quot;nm&quot;, while angle</span>
<span class="sd">        must be in radian.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        World coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">cart_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span><span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cartesian_to_world</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.distances" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distances</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get the distances from u=0.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code>sequence of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions. Between 0 and 1. If not given, anchors are used instead.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distances for each <code>u</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">distances</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the distances from u=0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : sequence of float, optional</span>
<span class="sd">        Positions. Between 0 and 1. If not given, anchors are used instead.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Distances for each `u`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Positions must be 1D array.&quot;</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="p">)</span>
    <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">tck</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">_u</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fit spline model to coordinates.</p>
<p>This method uses <code>scipy.interpolate.splprep</code> to fit given coordinates to a
spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinates. Must be (N, 3).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>err_max</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error allowed for fitting. Several upper limit of residual values will be
used and the fit that results in error lower than this value and minimize
the maximum curvature will be chosen.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New spline fit to given coordinates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit spline model to coordinates.</span>

<span class="sd">    This method uses `scipy.interpolate.splprep` to fit given coordinates to a</span>
<span class="sd">    spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : np.ndarray</span>
<span class="sd">        Coordinates. Must be (N, 3).</span>
<span class="sd">    err_max : float, default 1.0</span>
<span class="sd">        Error allowed for fitting. Several upper limit of residual values will be</span>
<span class="sd">        used and the fit that results in error lower than this value and minimize</span>
<span class="sd">        the maximum curvature will be chosen.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        New spline fit to given coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">npoints</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">npoints</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of input coordinates must be &gt; 1.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npoints</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_inverted</span><span class="p">():</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="n">crds</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">err_max</span> <span class="o">&gt;</span> <span class="mf">4.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;std_max must be smaller than 4.0.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err_max</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">std_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">err_max</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ntrial</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">err_max</span> <span class="o">/</span> <span class="mf">0.02</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">std_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">err_max</span><span class="p">,</span> <span class="n">ntrial</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">fit_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">SplineFitResult</span><span class="p">]()</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># fitting may fail for some std</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">std_list</span><span class="p">:</span>
            <span class="n">_tck</span><span class="p">,</span> <span class="n">_u</span> <span class="o">=</span> <span class="n">splprep</span><span class="p">(</span><span class="n">crds</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">std</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">npoints</span><span class="p">)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="n">_tck</span><span class="p">,</span> <span class="n">_u</span><span class="p">)</span>
            <span class="n">_crds_at_u</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_u</span><span class="p">)</span>
            <span class="n">res</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">_crds_at_u</span> <span class="o">-</span> <span class="n">crds</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">_knots</span> <span class="o">=</span> <span class="n">_tck</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">new</span><span class="o">.</span><span class="n">order</span> <span class="p">:</span> <span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">order</span><span class="p">]</span>
            <span class="n">nedge</span> <span class="o">=</span> <span class="n">_knots</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">nedge</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">nanc</span> <span class="o">=</span> <span class="n">nedge</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">anc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nanc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nedge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">_knots</span>
            <span class="p">)</span>
            <span class="n">max_curvature</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">curvature</span><span class="p">(</span><span class="n">anc</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">err_max</span>
            <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SplineFitResult</span><span class="p">((</span><span class="n">_tck</span><span class="p">,</span> <span class="n">_u</span><span class="p">),</span> <span class="n">max_curvature</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">fit_results_filt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">success</span><span class="p">,</span> <span class="n">fit_results</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_results_filt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fit_results_filt</span> <span class="o">=</span> <span class="n">fit_results</span>

    <span class="n">reult_opt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fit_results_filt</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">curvature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="o">*</span><span class="n">reult_opt</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Construct a spline model from a dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>d</code>
            </td>
            <td>
                  <code><span title="cylindra.components.spline._types.SplineInfo">SplineInfo</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with keys "t", "c", "k", "u" and "lims".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline object constructed from the dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span> <span class="n">d</span><span class="p">:</span> <span class="n">SplineInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a spline model from a dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d: dict</span>
<span class="sd">        Dictionary with keys &quot;t&quot;, &quot;c&quot;, &quot;k&quot;, &quot;u&quot; and &quot;lims&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Spline object constructed from the dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">order</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">lims</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lims&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="n">extrapolate</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s2">&quot;zyx&quot;</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_window_size</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;localprops_window_size&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_loc</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;binsize_loc&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">_binsize_glob</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;binsize_glob&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">cfg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.get_rotator" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_rotator</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate list of Affine transformation matrix along spline.</p>
<p>The matrices correspond to the orientation of spline curve.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span>, (<span title="N">N</span>,))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions. Between 0 and 1.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inverse</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, rotation matrix will be inversed.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="scipy.spatial.transform.Rotation">Rotation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rotation object at each anchor.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_rotator</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rotation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate list of Affine transformation matrix along spline.</span>

<span class="sd">    The matrices correspond to the orientation of spline curve.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : array-like, (N,)</span>
<span class="sd">        Positions. Between 0 and 1.</span>
<span class="sd">    inverse : bool, default False</span>
<span class="sd">        If True, rotation matrix will be inversed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Rotation</span>
<span class="sd">        Rotation object at each anchor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">axes_to_rotator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.has_props" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">has_props</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>True if there are any properties.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">has_props</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;True if there are any properties.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.invert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invert</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Invert the direction of spline.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverted object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Invert the direction of spline.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Inverted object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>
    <span class="n">inverted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">anchors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inverted</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">anchors</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">inverted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.is_inverted" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_inverted</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return true if spline is inverted.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_inverted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return true if spline is inverted.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.length" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">length</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return the length of the spline.</p>
<p>This method approximates the length of B-spline between [start, stop] by
partitioning the spline with 'nknots' knots. nknots=256 is large enough for most
cases.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the length of the spline.</span>

<span class="sd">    This method approximates the length of B-spline between [start, stop] by</span>
<span class="sd">    partitioning the spline with &#39;nknots&#39; knots. nknots=256 is large enough for most</span>
<span class="sd">    cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_assert_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">nknots</span><span class="p">)</span>
    <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.line" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">line</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Create a linear spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start</code>
            </td>
            <td>
                  <code><span title="array_like">array_like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start point of the line.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end</code>
            </td>
            <td>
                  <code><span title="array_like">array_like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End point of the line.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line spline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a linear spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : array_like</span>
<span class="sd">        Start point of the line.</span>
<span class="sd">    end : array_like</span>
<span class="sd">        End point of the line.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Line spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.local_cartesian" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_cartesian</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generate local Cartesian coordinate systems.</p>
<p>The generated array can be used for <code>ndi.map_coordinates</code>. The result coordinate
systems are flat, i.e., not distorted by the curvature of spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>shape</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical and horizontal length of Cartesian coordinates. Corresponds to zx
axes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of y axis in nm.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>u</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position on the spline at which local Cartesian coordinates will be built.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale of coordinates, i.e. spacing of the grid.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(D, V, S, H) shape. Each cooresponds to dimensional vertical, longitudinal
and horizontal axis, which is ready to be used in <code>ndi.map_coordinates</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">local_cartesian</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
    <span class="n">u</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate local Cartesian coordinate systems.</span>

<span class="sd">    The generated array can be used for `ndi.map_coordinates`. The result coordinate</span>
<span class="sd">    systems are flat, i.e., not distorted by the curvature of spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : (float, float)</span>
<span class="sd">        Vertical and horizontal length of Cartesian coordinates. Corresponds to zx</span>
<span class="sd">        axes.</span>
<span class="sd">    depth : float</span>
<span class="sd">        Length of y axis in nm.</span>
<span class="sd">    u : float, optional</span>
<span class="sd">        Position on the spline at which local Cartesian coordinates will be built.</span>
<span class="sd">    scale: nm, default 1.0</span>
<span class="sd">        Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        (D, V, S, H) shape. Each cooresponds to dimensional vertical, longitudinal</span>
<span class="sd">        and horizontal axis, which is ready to be used in `ndi.map_coordinates`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors_to_molecules</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">depth</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mole</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.local_cylindrical" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_cylindrical</span><span class="p">(</span><span class="n">r_range</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generate local cylindrical coordinate systems.</p>
<p>The generated array can be used for <code>ndi.map_coordinates</code>. The result coordinate
systems are flat, i.e., not distorted by the curvature of spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>r_range</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lower and upper bound of radius in nm.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of y axis in nm.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>u</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position on the spline at which local cylindrical coordinates will be built.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale of coordinates, i.e. spacing of the grid.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(D, V, S, H) shape. Each cooresponds to dimensional, radius, longitudinal
and angle axis, which is ready to be used in <code>ndi.map_coordinates</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">local_cylindrical</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">r_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">],</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
    <span class="n">u</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate local cylindrical coordinate systems.</span>

<span class="sd">    The generated array can be used for `ndi.map_coordinates`. The result coordinate</span>
<span class="sd">    systems are flat, i.e., not distorted by the curvature of spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_range : (float, float)</span>
<span class="sd">        Lower and upper bound of radius in nm.</span>
<span class="sd">    depth : nm</span>
<span class="sd">        Length of y axis in nm.</span>
<span class="sd">    u : float</span>
<span class="sd">        Position on the spline at which local cylindrical coordinates will be built.</span>
<span class="sd">    scale: nm, default 1.0</span>
<span class="sd">        Scale of coordinates, i.e. spacing of the grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        (D, V, S, H) shape. Each cooresponds to dimensional, radius, longitudinal</span>
<span class="sd">        and angle axis, which is ready to be used in `ndi.map_coordinates`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
    <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">r_range</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ds_norm</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ds</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">depth_px</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">depth</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">depth_px</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">depth_px</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">depth_px</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">ds_norm</span> <span class="o">*</span> <span class="n">grid</span>
    <span class="n">y_ax_coords</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span><span class="o">.</span><span class="n">T</span>
    <span class="n">dslist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ds</span><span class="p">]</span> <span class="o">*</span> <span class="n">depth_px</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">map_</span> <span class="o">=</span> <span class="n">polar_coords_2d</span><span class="p">(</span><span class="n">rmin</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">map_slice</span> <span class="o">=</span> <span class="n">_stack_coords</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">_rot_with_vector</span><span class="p">(</span><span class="n">map_slice</span><span class="p">,</span> <span class="n">y_ax_coords</span><span class="p">,</span> <span class="n">dslist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.make_anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_anchors</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Make anchor points at constant intervals.</p>
<p>Either interval, number of anchor or the maximum interval between anchors can be
specified.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval between anchor points.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of anchor points, including both ends.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline will be split by as little anchors as possible but interval between
anchors will not be larger than this. The number of anchors are also
guaranteed to be larger than spline order.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_anchors</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make anchor points at constant intervals.</span>

<span class="sd">    Either interval, number of anchor or the maximum interval between anchors can be</span>
<span class="sd">    specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interval : nm, optional</span>
<span class="sd">        Interval between anchor points.</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        Number of anchor points, including both ends.</span>
<span class="sd">    max_interval: nm, optional</span>
<span class="sd">        Spline will be split by as little anchors as possible but interval between</span>
<span class="sd">        anchors will not be larger than this. The number of anchors are also</span>
<span class="sd">        guaranteed to be larger than spline order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">max_interval</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.map" class="doc doc-heading">
            <code class="highlight language-python"><span class="nb">map</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate coordinates (or n-th derivative) at points on the spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions. Between 0 and 1. If not given, anchors are used instead.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>der</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>der</code>-th derivative will be calculated.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions or vectors in (3,) or (N, 3) shape.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate coordinates (or n-th derivative) at points on the spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : np.ndarray or float, optional</span>
<span class="sd">        Positions. Between 0 and 1. If not given, anchors are used instead.</span>
<span class="sd">    der : int, default 0</span>
<span class="sd">        `der`-th derivative will be calculated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Positions or vectors in (3,) or (N, 3) shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_assert_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span>
    <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">der</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">u_tr</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="n">u_tr</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u_tr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">der0</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">der1</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">der0</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">der1</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">dr</span> <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">der0</span><span class="p">,</span> <span class="n">der1</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u_tr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">splev</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrapolation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">der</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">u_tr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span> <span class="ow">is</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span>
            <span class="n">sl_small</span> <span class="o">=</span> <span class="n">u_tr</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">sl_large</span> <span class="o">=</span> <span class="n">u_tr</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">n_small</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">sl_small</span><span class="p">)</span>
            <span class="n">n_large</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">sl_large</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_small</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">der0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">der1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">splev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span>
                    <span class="n">coords_new</span> <span class="o">=</span> <span class="n">der0</span> <span class="o">+</span> <span class="n">der1</span> <span class="o">*</span> <span class="n">dr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords_new</span>

                <span class="k">if</span> <span class="n">n_large</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">der0</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">der1</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="n">u_tr</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">coords_new</span> <span class="o">=</span> <span class="n">der0</span> <span class="o">+</span> <span class="n">der1</span> <span class="o">*</span> <span class="n">dr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords_new</span>

            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_small</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_large</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_small</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">sl_small</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">n_large</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">sl_large</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrapolation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">u0</span> <span class="o">&gt;</span> <span class="n">u1</span> <span class="ow">and</span> <span class="n">der</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">out</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.partition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">partition</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return the n-partitioning coordinates of the spline.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the n-partitioning coordinates of the spline.&quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">der</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.resample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resample</span><span class="p">(</span><span class="n">max_interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Resample a new spline along the original spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval between resampling points.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>err_max</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline fitting maximum error.</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resampled spline object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resample a new spline along the original spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    max_interval : nm, default 1.0</span>
<span class="sd">        Maximum interval between resampling points.</span>
<span class="sd">    err_max : float, default 0.1</span>
<span class="sd">        Spline fitting maximum error.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Resampled spline object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ceilint</span><span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">max_interval</span><span class="p">)))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.restore" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">restore</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Restore the original, not-clipped spline.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Copy of the original spline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restore the original, not-clipped spline.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Copy of the original spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
        <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
        <span class="n">lims</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">extrapolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.shift" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shift</span><span class="p">(</span><span class="n">positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fit spline model using a list of shifts in XZ-plane.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code>sequence of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positions. Between 0 and 1. If not given, anchors are used instead.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shifts</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shift from center in nm. Must be (N, 2).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>err_max</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error allowed for fitting. See <code>Spline.fit</code>.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Spline (cylindra.components.spline._spline_base.Spline)" href="#cylindra.components.spline.Spline">Spline</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline shifted by fitting to given coordinates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">shift</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">shifts</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit spline model using a list of shifts in XZ-plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : sequence of float, optional</span>
<span class="sd">        Positions. Between 0 and 1. If not given, anchors are used instead.</span>
<span class="sd">    shifts : np.ndarray</span>
<span class="sd">        Shift from center in nm. Must be (N, 2).</span>
<span class="sd">    err_max : float, default 1.0</span>
<span class="sd">        Error allowed for fitting. See `Spline.fit`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Spline</span>
<span class="sd">        Spline shifted by fitting to given coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shifts must be given.&quot;</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rotator</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="c1"># insert 0 in y coordinates.</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rot</span><span class="p">)),</span> <span class="n">shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">+=</span> <span class="n">rot</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">from_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">allow_discard</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Split the spline at the given position.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">at</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
    <span class="n">from_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">trim</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">allow_discard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split the spline at the given position.&quot;&quot;&quot;</span>
    <span class="n">spl_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">from_start</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">spl_len</span> <span class="o">-</span> <span class="n">at</span>
    <span class="n">at_rel_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">at</span> <span class="o">-</span> <span class="n">trim</span><span class="p">)</span> <span class="o">/</span> <span class="n">spl_len</span>
    <span class="n">at_rel_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">at</span> <span class="o">+</span> <span class="n">trim</span><span class="p">)</span> <span class="o">/</span> <span class="n">spl_len</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Self&quot;</span><span class="p">]()</span>
    <span class="k">if</span> <span class="n">at_rel_0</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">at_rel_0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">allow_discard</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Split position must be over `trim` if allow_discard is False, but &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;tried to split at </span><span class="si">{</span><span class="n">at</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> nm.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">at_rel_1</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">at_rel_1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">allow_discard</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Split position must be under `length - trim` if allow_discard is &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;False, but tried to split at </span><span class="si">{</span><span class="n">at</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> nm (length = </span><span class="si">{</span><span class="n">spl_len</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dict</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Convert spline info into a dict.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert spline info into a dict.&quot;&quot;&quot;</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span>
    <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()},</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;lims&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">,</span>
        <span class="s2">&quot;localprops_window_size&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">window_size</span><span class="p">),</span>
        <span class="s2">&quot;binsize_loc&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">binsize_loc</span><span class="p">),</span>
        <span class="s2">&quot;binsize_glob&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">binsize_glob</span><span class="p">),</span>
        <span class="s2">&quot;extrapolate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extrapolate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.translate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">translate</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Translate the spline by given shift vectors.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate the spline by given shift vectors.&quot;&quot;&quot;</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_tck</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.with_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">with_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">copy_props</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return a copy of the spline with a new config.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_config</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">SplineConfig</span><span class="p">,</span>
    <span class="n">copy_props</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a copy of the spline with a new config.&quot;&quot;&quot;</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">copy_props</span><span class="o">=</span><span class="n">copy_props</span><span class="p">,</span> <span class="n">copy_config</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">SplineConfig</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">return</span> <span class="n">new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.with_extrapolation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">with_extrapolation</span><span class="p">(</span><span class="n">extrapolate</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return a copy of the spline with a new extrapolation mode.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_extrapolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extrapolate</span><span class="p">:</span> <span class="n">ExtrapolationMode</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a copy of the spline with a new extrapolation mode.&quot;&quot;&quot;</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_extrapolate</span> <span class="o">=</span> <span class="n">ExtrapolationMode</span><span class="p">(</span><span class="n">extrapolate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.Spline.y_to_position" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">y_to_position</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Convert y-coordinate to spline position parameter.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y coordinates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nknots</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of knots. Increasing the number of knots will increase the accuracy.</p>
              </div>
            </td>
            <td>
                  <code>512</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_spline_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">y_to_position</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span> <span class="n">nknots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert y-coordinate to spline position parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : array-like</span>
<span class="sd">        Y coordinates.</span>
<span class="sd">    nknots : int, optional</span>
<span class="sd">        Number of knots. Increasing the number of knots will increase the accuracy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># almost equal to y / self.length()</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nknots</span><span class="p">)</span>
    <span class="n">u_tr</span> <span class="o">=</span> <span class="n">_linear_conversion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lims</span><span class="p">)</span>
    <span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">tck</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.spline.SplineConfig" class="doc doc-heading">
            <code>SplineConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Class for spline configuration.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/spline/_config.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SplineConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for spline configuration.&quot;&quot;&quot;</span>

    <span class="n">npf_range</span><span class="p">:</span> <span class="n">Range</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Range</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
    <span class="n">spacing_range</span><span class="p">:</span> <span class="n">Range</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Range</span><span class="p">(</span><span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">)</span>
    <span class="n">twist_range</span><span class="p">:</span> <span class="n">Range</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Range</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">rise_range</span><span class="p">:</span> <span class="n">Range</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">)</span>
    <span class="n">rise_sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">clockwise</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MinusToPlus&quot;</span>
    <span class="n">thickness_inner</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">thickness_outer</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">fit_depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">48.0</span>
    <span class="n">fit_width</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">44.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dataclass_fields__</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SplineConfig(</span><span class="se">\n\t</span><span class="si">{</span><span class="n">cont</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SplineConfig</span><span class="p">(</span>
            <span class="n">npf_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">spacing_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing_range</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">twist_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">twist_range</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">rise_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rise_range</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">rise_sign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rise_sign</span><span class="p">,</span>
            <span class="n">clockwise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clockwise</span><span class="p">,</span>
            <span class="n">thickness_inner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness_inner</span><span class="p">,</span>
            <span class="n">thickness_outer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness_outer</span><span class="p">,</span>
            <span class="n">fit_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_depth</span><span class="p">,</span>
            <span class="n">fit_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_width</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;npf_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">astuple</span><span class="p">(),</span>
            <span class="s2">&quot;spacing_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing_range</span><span class="o">.</span><span class="n">astuple_rounded</span><span class="p">(),</span>
            <span class="s2">&quot;twist_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">twist_range</span><span class="o">.</span><span class="n">astuple_rounded</span><span class="p">(),</span>
            <span class="s2">&quot;rise_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rise_range</span><span class="o">.</span><span class="n">astuple_rounded</span><span class="p">(),</span>
            <span class="s2">&quot;rise_sign&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rise_sign</span><span class="p">,</span>
            <span class="s2">&quot;clockwise&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clockwise</span><span class="p">,</span>
            <span class="s2">&quot;thickness_inner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_inner</span><span class="p">,</span>
            <span class="s2">&quot;thickness_outer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_outer</span><span class="p">,</span>
            <span class="s2">&quot;fit_depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_depth</span><span class="p">,</span>
            <span class="s2">&quot;fit_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_width</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">json_dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">    &quot;</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a SplineConfig with argument check.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SplineConfig</span><span class="p">()</span><span class="o">.</span><span class="n">updated</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">unknown</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
        <span class="c1"># for version compatibility</span>
        <span class="n">_undef</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cfg_input</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">:</span>
                <span class="n">_undef</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cfg_input</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">_undef</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unknown keys, maybe due to version incompatibility: </span><span class="si">{</span><span class="n">_undef</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="k">match</span> <span class="n">unknown</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">case</span> <span class="s2">&quot;warn&quot;</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">case</span> <span class="s2">&quot;ignore&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">case</span> <span class="n">other</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got invalid case </span><span class="si">{</span><span class="n">other</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SplineConfig</span><span class="p">()</span><span class="o">.</span><span class="n">updated</span><span class="p">(</span><span class="o">**</span><span class="n">cfg_input</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unknown</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SplineConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="n">unknown</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updated</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">npf_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spacing_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">twist_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rise_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rise_sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">clockwise</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thickness_inner</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thickness_outer</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_width</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rng</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;npf_range&quot;</span><span class="p">,</span> <span class="s2">&quot;spacing_range&quot;</span><span class="p">,</span> <span class="s2">&quot;twist_range&quot;</span><span class="p">,</span> <span class="s2">&quot;rise_range&quot;</span><span class="p">]:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">rng</span><span class="p">]</span> <span class="o">=</span> <span class="n">_norm_range</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">rng</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;rise_sign&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rise_sign must be -1 or 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;clockwise&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PlusToMinus&quot;</span><span class="p">,</span> <span class="s2">&quot;MinusToPlus&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;clockwise must be PlusToMinus or MinusToPlus&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;thickness_inner&quot;</span><span class="p">,</span> <span class="s2">&quot;thickness_outer&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_depth&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_width&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> must be non-negative&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SplineConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="cylindra.components.spline.SplineConfig.construct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">construct</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Construct a SplineConfig with argument check.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/spline/_config.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">construct</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a SplineConfig with argument check.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">SplineConfig</span><span class="p">()</span><span class="o">.</span><span class="n">updated</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="cylindra.components.tomogram"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="cylindra.components.tomogram.CylTomogram" class="doc doc-heading">
            <code>CylTomogram</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Tomogram (cylindra.components.tomogram._tomo_base.Tomogram)" href="#cylindra.components.tomogram.Tomogram">Tomogram</a></code></p>


        <p>Tomogram with cylindrical splines.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CylTomogram</span><span class="p">(</span><span class="n">Tomogram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tomogram with cylindrical splines.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splines</span> <span class="o">=</span> <span class="n">SplineList</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">splines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineList</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of splines.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splines</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">extrapolate</span><span class="p">:</span> <span class="n">ExtrapolationMode</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">SplineConfig</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add spline path to tomogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : array-like</span>
<span class="sd">            (N, 3) array of coordinates. A spline curve that fit it well is added.</span>
<span class="sd">        order : int, optional</span>
<span class="sd">            Order of spline curve.</span>
<span class="sd">        extrapolate : str, optional</span>
<span class="sd">            Extrapolation mode of the spline.</span>
<span class="sd">        config : SplineConfig or dict, optional</span>
<span class="sd">            Configuration for spline fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">ncoords</span> <span class="o">=</span> <span class="n">_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">CylSpline</span><span class="p">(</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ncoords</span> <span class="o">&lt;=</span> <span class="n">spl</span><span class="o">.</span><span class="n">order</span> <span class="ow">and</span> <span class="n">ncoords</span> <span class="o">&lt;</span> <span class="n">fit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span>
                <span class="n">fit</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
                <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_anchors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make anchors on spline object(s).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interval : nm, optional</span>
<span class="sd">            Anchor intervals.</span>
<span class="sd">        n : int, optional</span>
<span class="sd">            Number of anchors</span>
<span class="sd">        max_interval : nm, optional</span>
<span class="sd">            Maximum interval between anchors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">align_to_polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">MinusToPlus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align all the splines in the direction parallel to the given polarity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orientation : Ori or str, default Ori.MinusToPlus</span>
<span class="sd">            To which direction splines will be aligned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tomogram object</span>
<span class="sd">            Same object with updated splines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must be PlusToMinus or MinusToPlus.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="ow">is</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> has no orientation.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="o">!=</span> <span class="n">orientation</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span><span class="sa">f</span><span class="s2">&quot;Cannot invert spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">degree_precision</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">edge_sigma</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">n_rotations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Roughly fit splines to cylindrical structures.</span>

<span class="sd">        Subtomograms will be sampled at every `max_interval` nm. In dense mode,</span>
<span class="sd">        Subtomograms will be masked relative to XY-plane, using sigmoid function.</span>
<span class="sd">        Sharpness of the sigmoid function is determined by `dense_mode_sigma`</span>
<span class="sd">        (`dense_mode_sigma=0` corresponds to a step function).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to fit.</span>
<span class="sd">        max_interval : nm, default 30.0</span>
<span class="sd">            Maximum interval of sampling points in nm unit.</span>
<span class="sd">        degree_precision : float, default 0.5</span>
<span class="sd">            Precision of xy-tilt degree in angular correlation.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for fitting.</span>
<span class="sd">        edge_sigma : nm, default 2.0</span>
<span class="sd">            Sharpness of mask at the edges. If not None, fitting will be executed after regions</span>
<span class="sd">            outside the cylinder are masked. Soft mask is important for precision because sharp</span>
<span class="sd">            changes in intensity cause strong correlation at the edges.</span>
<span class="sd">        max_shift: nm, default 5.0</span>
<span class="sd">            Maximum shift from the true center of the cylinder. This parameter is used in phase</span>
<span class="sd">            cross correlation.</span>
<span class="sd">        n_rotations : int, default 5</span>
<span class="sd">            Number of rotations to be tested during finding the cylinder center.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FitResult</span>
<span class="sd">            Result of fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.fit, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">anc</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>
        <span class="n">subtomograms</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_fit_spline</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">set_gpu</span><span class="p">():</span>
            <span class="n">subtomograms</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">soft_mask_edges</span><span class="p">(</span>
                <span class="n">subtomograms</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">edge_sigma</span>
            <span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anc</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">yx_tilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">ds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">degree_max</span> <span class="o">=</span> <span class="mf">14.0</span>
            <span class="n">nrots</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">degree_max</span> <span class="o">/</span> <span class="n">degree_precision</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Angular correlation</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">dask_angle_corr</span><span class="p">(</span><span class="n">subtomograms</span><span class="p">,</span> <span class="n">yx_tilt</span><span class="p">,</span> <span class="n">nrots</span><span class="o">=</span><span class="n">nrots</span><span class="p">)</span>
            <span class="n">refined_tilt_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">refined_tilt_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">refined_tilt_deg</span><span class="p">)</span>

            <span class="c1"># If subtomograms are sampled at short intervals, angles should be smoothened to</span>
            <span class="c1"># avoid overfitting.</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">roundint</span><span class="p">(</span><span class="mf">48.0</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Mirror-mode padding is &quot;a b c d | c b a&quot;.</span>
                <span class="n">refined_tilt_rad</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">angle_uniform_filter</span><span class="p">(</span>
                    <span class="n">refined_tilt_rad</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Mode</span><span class="o">.</span><span class="n">mirror</span>
                <span class="p">)</span>
                <span class="n">refined_tilt_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">refined_tilt_rad</span><span class="p">)</span>

            <span class="c1"># Rotate subtomograms in YX plane</span>
            <span class="k">for</span> <span class="n">_j</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subtomograms</span><span class="p">):</span>
                <span class="n">img</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">refined_tilt_deg</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span>
                <span class="n">img</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># zx-shift correction by self-ZNCC</span>
            <span class="n">subtomo_proj</span> <span class="o">=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">edge_sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Regions outside the mask don&#39;t need to be considered.</span>
                <span class="n">xc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subtomo_proj</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">subtomo_proj</span> <span class="o">=</span> <span class="n">subtomo_proj</span><span class="p">[</span><span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">xc</span> <span class="o">-</span> <span class="n">w</span> <span class="p">:</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>

            <span class="n">max_shift_px</span> <span class="o">=</span> <span class="n">max_shift</span> <span class="o">/</span> <span class="n">scale</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">pf_ang</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">center</span>
            <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_rotations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">multi_rotated_auto_zncc</span><span class="p">(</span><span class="n">subtomo_proj</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">max_shift_px</span><span class="p">)</span>

        <span class="c1"># Update spline coordinates.</span>
        <span class="c1"># Because centers of subtomogram are on lattice points of pixel coordinate,</span>
        <span class="c1"># coordinates that will be shifted should be converted to integers.</span>
        <span class="n">coords_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anc</span><span class="p">),</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">coords_px_new</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">shift_coords</span><span class="p">(</span><span class="n">coords_px</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">refined_tilt_rad</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords_px_new</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

        <span class="c1"># Update spline parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">(</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Shift RMSD = </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">rmsd</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_centroid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.fit_centroid, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">anc</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span>

        <span class="c1"># sample subtomograms</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">prep_loader_for_refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">subtomograms</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;pzyx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)[</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">lz</span><span class="p">,</span> <span class="n">lx</span> <span class="o">=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dpx</span> <span class="o">=</span> <span class="n">ceilint</span><span class="p">(</span><span class="n">max_shift</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">sl_z</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="n">lz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dpx</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lz</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dpx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lz</span><span class="p">))</span>
        <span class="n">sl_x</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="n">lx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dpx</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lx</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dpx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lx</span><span class="p">))</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">centroid_2d</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">sl_z</span><span class="p">,</span> <span class="n">sl_x</span><span class="p">)</span> <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">subtomograms</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">centers</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="n">sl_z</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">sl_z</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="n">sl_x</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">sl_x</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">anc</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">(</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Shift RMSD = </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">rmsd</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">refine</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">corr_allowed</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">n_rotations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spline refinement using global lattice structural parameters.</span>

<span class="sd">        Refine spline using the result of previous fit and the global structural parameters.</span>
<span class="sd">        During refinement, Y-projection of XZ cross section of cylinder is rotated with the</span>
<span class="sd">        twist angles, thus is much more precise than the coarse fitting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to fit.</span>
<span class="sd">        max_interval : nm, default 24.0</span>
<span class="sd">            Maximum interval of sampling points in nm unit.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for refining.</span>
<span class="sd">        corr_allowed : float, defaul is 0.9</span>
<span class="sd">            How many images will be used to make template for alignment. If 0.9, then top</span>
<span class="sd">            90% will be used.</span>
<span class="sd">        max_shift: nm, default 2.0</span>
<span class="sd">            Maximum shift from the true center of the cylinder. This parameter is used in</span>
<span class="sd">            phase cross correlation.</span>
<span class="sd">        n_rotations : int, default 3</span>
<span class="sd">            Number of rotations to be tested during finding the cylinder center.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FitResult</span>
<span class="sd">            Result of fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.refine, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">_required</span> <span class="o">=</span> <span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">has_glob</span><span class="p">(</span><span class="n">_required</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">radius</span> <span class="o">:=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_radius</span><span class="p">(</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
                    <span class="n">positions</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">with</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">temp_glob</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">):</span>
                <span class="n">gprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_cft_params</span><span class="p">(</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gprops</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">_required</span><span class="p">)</span>
        <span class="n">gdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">gprops</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_required</span><span class="p">}</span>
        <span class="n">ancs</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>

        <span class="c1"># Calculate Fourier parameters by cylindrical transformation along spline.</span>
        <span class="c1"># Skew angles are divided by the angle of single protofilament and the residual</span>
        <span class="c1"># angles are used, considering missing wedge effect.</span>
        <span class="n">space</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">]</span>
        <span class="n">twist</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">]</span>
        <span class="n">npf</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">gdict</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">])</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Parameters: spacing = </span><span class="si">{</span><span class="n">space</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm, twist = </span><span class="si">{</span><span class="n">twist</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> deg, PF = </span><span class="si">{</span><span class="n">npf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>

        <span class="c1"># complement twisting</span>
        <span class="n">pf_ang</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">npf</span>
        <span class="n">twists</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_twists</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span> <span class="n">ancs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">twist</span><span class="p">,</span> <span class="n">npf</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">prep_loader_for_refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">ancs</span><span class="p">,</span> <span class="n">binsize</span><span class="p">,</span> <span class="n">twists</span><span class="p">)</span>
        <span class="n">subtomograms</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;pzyx&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">subtomograms</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># normalize</span>
        <span class="n">subtomograms</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">zyx</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

        <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_rotations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span>
        <span class="n">max_shift_px</span> <span class="o">=</span> <span class="n">max_shift</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="k">with</span> <span class="n">set_gpu</span><span class="p">():</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)[</span><span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="c1"># Align twist-corrected images</span>
            <span class="n">shifts_loc</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">multi_rotated_auto_zncc</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">max_shift_px</span><span class="p">)</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_misc</span><span class="o">.</span><span class="n">delayed_translate</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span> <span class="n">shifts_loc</span><span class="p">[</span><span class="n">_j</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ancs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">imgs_aligned</span> <span class="o">=</span> <span class="n">_filter_by_corr</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">),</span>
                <span class="n">corr_allowed</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Make 2D template using coarse aligned images.</span>
            <span class="n">imgcory</span> <span class="o">=</span> <span class="n">imgs_aligned</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">rotated_auto_zncc</span><span class="p">(</span>
                <span class="n">imgcory</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="n">degrees</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shift_px</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">imgcory</span><span class="o">.</span><span class="n">affine</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Mode</span><span class="o">.</span><span class="n">constant</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

            <span class="c1"># Align twist-corrected images to the template</span>
            <span class="n">quat</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">quaternion</span><span class="p">()</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_misc</span><span class="o">.</span><span class="n">delayed_zncc_maximum</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span>
                    <span class="n">_misc</span><span class="o">.</span><span class="n">mask_missing_wedge</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt_model</span><span class="p">,</span> <span class="n">quat</span><span class="p">[</span><span class="n">_j</span><span class="p">]),</span>
                    <span class="n">max_shift_px</span><span class="p">,</span>
                    <span class="n">twists</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ancs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Update spline parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">ancs</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">(</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Shift RMSD = </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">rmsd</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">measure_radius</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;anchor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">min_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">max_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure radius using radial profile from the center.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to measure.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for radius calculation.</span>
<span class="sd">        positions : array-like or &quot;auto&quot; or &quot;anchor&quot;, default &quot;auto&quot;</span>
<span class="sd">            Sampling positions (between 0 and 1) to calculate radius. If &quot;anchor&quot;</span>
<span class="sd">            is given, anchors of the spline will be used. If &quot;auto&quot; is given,</span>
<span class="sd">            three positions along the spline will be used.</span>
<span class="sd">        min_radius : nm, default 1.0</span>
<span class="sd">            Minimum radius of the cylinder.</span>
<span class="sd">        max_radius : nm, default 100.0</span>
<span class="sd">            Maximum radius of the cylinder.</span>
<span class="sd">        update : bool, default True</span>
<span class="sd">            If True, global radius property will be updated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float (nm)</span>
<span class="sd">            Cylinder radius.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.measure_radius, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">positions</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">nanchor</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">nanchor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nanchor</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">nanchor</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">positions</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

        <span class="n">depth</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_depth</span>
        <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="n">min_radius_px</span> <span class="o">=</span> <span class="n">min_radius</span> <span class="o">/</span> <span class="n">_scale</span>
        <span class="n">max_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">max_radius_px</span> <span class="o">=</span> <span class="n">max_radius</span> <span class="o">/</span> <span class="n">_scale</span>
        <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_misc</span><span class="o">.</span><span class="n">get_radial_prof</span><span class="p">(</span>
                <span class="n">input_img</span><span class="p">,</span> <span class="n">spl_trans</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">),</span> <span class="n">depth</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">pos</span>
        <span class="p">]</span>
        <span class="n">profs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]]</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">profs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imax_sub</span> <span class="o">=</span> <span class="n">find_centroid_peak</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">*</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_thickness</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">_scale</span><span class="p">))</span>
        <span class="n">offset_px</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_radius_offset</span><span class="p">(</span><span class="n">min_radius_px</span><span class="p">,</span> <span class="n">max_radius_px</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">imax_sub</span> <span class="o">+</span> <span class="n">offset_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">_scale</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="p">[</span><span class="n">radius</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)],</span>
                <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Radius = </span><span class="si">{</span><span class="n">radius</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">radius</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_radii</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">min_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">max_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">update_glob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure the local radii along the splines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        depth : nm, default 50.0</span>
<span class="sd">            Longitudinal length of subtomograms for calculation.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale binsize to be used.</span>
<span class="sd">        min_radius : nm, default 1.0</span>
<span class="sd">            Minimum radius of the cylinder.</span>
<span class="sd">        max_radius : nm, default 100.0</span>
<span class="sd">            Maximum radius of the cylinder.</span>
<span class="sd">        update : bool, default True</span>
<span class="sd">            If True, spline properties will be updated.</span>
<span class="sd">        update_glob : bool, default True</span>
<span class="sd">            If True, global properties will be updated using the mean of the local</span>
<span class="sd">            radii.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pl.Series</span>
<span class="sd">            Radii along the spline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.local_radii, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

        <span class="n">depth</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_depth</span>
        <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_thickness</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">_scale</span><span class="p">)</span>
        <span class="n">min_radius_px</span> <span class="o">=</span> <span class="n">min_radius</span> <span class="o">/</span> <span class="n">_scale</span>
        <span class="n">max_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">max_radius_px</span> <span class="o">=</span> <span class="n">max_radius</span> <span class="o">/</span> <span class="n">_scale</span>
        <span class="n">offset_px</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_radius_offset</span><span class="p">(</span><span class="n">min_radius_px</span><span class="p">,</span> <span class="n">max_radius_px</span><span class="p">)</span>
        <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">spl_trans</span><span class="o">.</span><span class="n">anchors</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_radial_prof</span><span class="p">(</span>
                <span class="n">input_img</span><span class="p">,</span> <span class="n">spl_trans</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">),</span> <span class="n">depth</span>
            <span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">profs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]]</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">prof</span> <span class="ow">in</span> <span class="n">profs</span><span class="p">:</span>
            <span class="n">imax_sub</span> <span class="o">=</span> <span class="n">find_centroid_peak</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">*</span><span class="n">thickness</span><span class="p">)</span>
            <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">imax_sub</span> <span class="o">+</span> <span class="n">offset_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">_scale</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">([</span><span class="n">out</span><span class="p">],</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_glob</span><span class="p">:</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">mean</span><span class="p">()])],</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_cft_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span>
        <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">update_glob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate local lattice parameters from cylindrical Fourier space.</span>

<span class="sd">        To determine the peaks upsampled discrete Fourier transformation is used</span>
<span class="sd">        for every subtomogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        depth : nm, default 50.0</span>
<span class="sd">            Length of subtomogram for calculation of local parameters.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>
<span class="sd">        radius : str, default &quot;global&quot;</span>
<span class="sd">            If &quot;local&quot;, use the local radius for the analysis. If &quot;global&quot;, use the</span>
<span class="sd">            global radius. If a float, use the given radius.</span>
<span class="sd">        nsamples : int, default 8</span>
<span class="sd">            Number of cylindrical coordinate samplings for Fourier transformation. Multiple</span>
<span class="sd">            samplings are needed because up-sampled discrete Fourier transformation does not</span>
<span class="sd">            return exactly the same power spectra with shifted inputs, unlike FFT. Larger</span>
<span class="sd">            ``nsamples`` reduces the error but is slower.</span>
<span class="sd">        update : bool, default True</span>
<span class="sd">            If True, spline properties will be updated.</span>
<span class="sd">        update_glob : bool, default False</span>
<span class="sd">            If True, global properties will be updated using the mean or mode of the local</span>
<span class="sd">            properties.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        polars.DataFrame</span>
<span class="sd">            Local properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.local_cft_params, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">prepare_radii</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="n">tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Delayed</span><span class="p">[</span><span class="n">LatticeParams</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">_analyze_fn</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">estimate_lattice_params_task</span>
        <span class="k">for</span> <span class="n">anc</span><span class="p">,</span> <span class="n">r0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spl_trans</span><span class="o">.</span><span class="n">anchors</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">+</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">spl_trans</span><span class="o">.</span><span class="n">local_cylindrical</span><span class="p">((</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">depth</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">_scale</span><span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_analyze_fn</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">nsamples</span><span class="p">))</span>

        <span class="n">lprops</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">LatticeParams</span><span class="o">.</span><span class="n">polars_schema</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">(</span><span class="n">lprops</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_glob</span><span class="p">:</span>
            <span class="n">gprops</span> <span class="o">=</span> <span class="n">lprops</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">rise_length</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span><span class="n">gprops</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lprops</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_local_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">]:</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius has not been determined yet.&quot;</span><span class="p">)</span>

        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">()</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">+</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">anchors</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">anchors</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">pos</span><span class="p">]]</span>
        <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">spl_trans</span><span class="o">.</span><span class="n">local_cylindrical</span><span class="p">((</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">depth</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">_scale</span><span class="p">)</span>
            <span class="n">polar</span> <span class="o">=</span> <span class="n">get_polar_image</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
            <span class="n">polar</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">polar</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_cft</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate non-upsampled local cylindric Fourier transormation along spline.</span>

<span class="sd">        This function does not up-sample.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        depth : nm, default 50.0</span>
<span class="sd">            Length of subtomogram for calculation of local parameters.</span>
<span class="sd">        pos : int, optional</span>
<span class="sd">            Only calculate at ``pos``-th anchor if given.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ip.ImgArray</span>
<span class="sd">            FT images stacked along &quot;p&quot; axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">]()</span>
        <span class="k">with</span> <span class="n">set_gpu</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">polar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_local_image</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">binsize</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polar</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="s2">&quot;rya&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_cps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate non-upsampled local cylindric power spectra along spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        depth : nm, default 50.0</span>
<span class="sd">            Length of subtomogram for calculation of local parameters.</span>
<span class="sd">        pos : int, optional</span>
<span class="sd">            Only calculate at ``pos``-th anchor if given.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ip.ImgArray</span>
<span class="sd">            FT images stacked along &quot;p&quot; axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cft</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cft</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cft</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_image_with_peaks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">_misc</span><span class="o">.</span><span class="n">ImageWithPeak</span><span class="p">]:</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">window_size</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">binsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binsize</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">binsize_loc</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">]</span>
        <span class="n">df_loc</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">loc</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">_misc</span><span class="o">.</span><span class="n">ImageWithPeak</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">polar_img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_local_image</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)):</span>
            <span class="n">cparams</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">cylinder_params</span><span class="p">(</span>
                <span class="n">spacing</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                <span class="n">pitch</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                <span class="n">twist</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                <span class="n">skew</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                <span class="n">rise_angle</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                <span class="n">start</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                <span class="n">npf</span><span class="o">=</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">df_loc</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">peakv</span><span class="p">,</span> <span class="n">peakh</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">params_to_peaks</span><span class="p">(</span><span class="n">polar_img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cparams</span><span class="p">)</span>
            <span class="n">peakv</span> <span class="o">=</span> <span class="n">peakv</span><span class="o">.</span><span class="n">shift_to_center</span><span class="p">()</span>
            <span class="n">peakh</span> <span class="o">=</span> <span class="n">peakh</span><span class="o">.</span><span class="n">shift_to_center</span><span class="p">()</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_misc</span><span class="o">.</span><span class="n">ImageWithPeak</span><span class="p">(</span><span class="n">polar_img</span><span class="p">,</span> <span class="p">[</span><span class="n">peakv</span><span class="p">,</span> <span class="n">peakh</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">global_cps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate global cylindrical power spectra.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ip.ImgArray</span>
<span class="sd">            Complex image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_cft</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cft</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cft</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">global_image_with_peaks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_misc</span><span class="o">.</span><span class="n">ImageWithPeak</span><span class="p">:</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">binsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binsize</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">binsize_glob</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">]</span>
        <span class="n">img_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">img_st</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_st</span><span class="p">)</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">cylinder_params</span><span class="p">(</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">pitch</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">twist</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">skew</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">rise_angle</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">npf</span><span class="o">=</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">peakv</span><span class="p">,</span> <span class="n">peakh</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">params_to_peaks</span><span class="p">(</span><span class="n">img_st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cparams</span><span class="p">)</span>
        <span class="n">peakv</span> <span class="o">=</span> <span class="n">peakv</span><span class="o">.</span><span class="n">shift_to_center</span><span class="p">()</span>
        <span class="n">peakh</span> <span class="o">=</span> <span class="n">peakh</span><span class="o">.</span><span class="n">shift_to_center</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_misc</span><span class="o">.</span><span class="n">ImageWithPeak</span><span class="p">(</span><span class="n">img_st</span><span class="p">,</span> <span class="p">[</span><span class="n">peakv</span><span class="p">,</span> <span class="n">peakh</span><span class="p">])</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">global_cft_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate global lattice parameters.</span>

<span class="sd">        This function transforms tomogram using cylindrical coordinate system along</span>
<span class="sd">        spline. This function calls ``straighten`` beforehand, so that Fourier space is</span>
<span class="sd">        distorted if the cylindrical structure is curved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>
<span class="sd">        nsamples : int, default 8</span>
<span class="sd">            Number of cylindrical coordinate samplings for Fourier transformation.</span>
<span class="sd">            Multiple samplings are needed because up-sampled discrete Fourier</span>
<span class="sd">            transformation does not return exactly the same power spectra with shifted</span>
<span class="sd">            inputs, unlike FFT. Larger ``nsamples`` reduces the error but is slower.</span>
<span class="sd">        update : bool, default True</span>
<span class="sd">            If True, spline properties will be updated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pl.DataFrame</span>
<span class="sd">            Global properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.global_cft_params, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">()</span>
        <span class="n">img_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">radii</span><span class="o">=</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">+</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">lparams</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">estimate_lattice_params_polar</span><span class="p">(</span><span class="n">img_st</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">nsamples</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">lparams</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">global_cft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate global cylindrical fast Fourier tranformation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ip.ImgArray</span>
<span class="sd">            Complex image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">img_st</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_st</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img_st</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="s2">&quot;rya&quot;</span><span class="p">)</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">infer_polarity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">mask_freq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ori</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer spline polarities using polar 2D image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to analyze.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>
<span class="sd">        depth : nm, default 40.0</span>
<span class="sd">            Depth of images used to infer polarities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ori</span>
<span class="sd">            Orientation of corresponding splines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.infer_polarity, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">current_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span>

        <span class="k">if</span> <span class="n">binsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>

        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span>
        <span class="n">ori_clockwise</span> <span class="o">=</span> <span class="n">Ori</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">clockwise</span><span class="p">)</span>
        <span class="n">ori_counterclockwise</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ori_clockwise</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r_range</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">current_scale</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_range</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">()</span>
        <span class="n">point</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># the sampling point</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">local_cylindrical</span><span class="p">(</span><span class="n">r_range</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">current_scale</span><span class="p">)</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="n">get_polar_image</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_freq</span><span class="p">:</span>
            <span class="n">polar</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span><span class="o">.</span><span class="n">mask_spectra</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
        <span class="n">img_flat</span> <span class="o">=</span> <span class="n">polar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">npf</span> <span class="o">:=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if the global properties are already calculated, use it</span>
            <span class="c1"># otherwise, calculate the number of PFs from the power spectrum</span>
            <span class="n">ft</span> <span class="o">=</span> <span class="n">img_flat</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">shift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;ra&quot;</span><span class="p">)</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ft</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">img_pw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">npf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img_pw</span><span class="p">[</span><span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">asslice</span><span class="p">()])</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">min</span>

        <span class="n">pw_peak</span> <span class="o">=</span> <span class="n">img_flat</span><span class="o">.</span><span class="n">local_power_spectra</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">npf</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">npf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">upsample_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">r_argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pw_peak</span><span class="p">)</span>
        <span class="n">clkwise</span> <span class="o">=</span> <span class="n">r_argmax</span> <span class="o">-</span> <span class="p">(</span><span class="n">pw_peak</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="n">ori</span> <span class="o">=</span> <span class="n">ori_clockwise</span> <span class="k">if</span> <span class="n">clkwise</span> <span class="k">else</span> <span class="n">ori_counterclockwise</span>

        <span class="c1"># logging</span>
        <span class="n">_val</span> <span class="o">=</span> <span class="n">pw_peak</span><span class="p">[</span><span class="n">r_argmax</span><span class="p">]</span>
        <span class="n">pw_non_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pw_peak</span><span class="p">,</span> <span class="n">r_argmax</span><span class="p">)</span>
        <span class="n">_ave</span><span class="p">,</span> <span class="n">_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pw_non_peak</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pw_non_peak</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; polarity = </span><span class="si">{</span><span class="n">ori</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (peak intensity=</span><span class="si">{</span><span class="n">_val</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2"> compared to </span><span class="si">{</span><span class="n">_ave</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">_std</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">ori</span>
        <span class="k">return</span> <span class="n">ori</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">straighten</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">range_</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">chunk_length</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Straightening by building curved coordinate system around splines. Currently</span>
<span class="sd">        Cartesian coordinate system and cylindrical coordinate system are supported.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to straighten.</span>
<span class="sd">        size : float (nm), optional</span>
<span class="sd">            Vertical/horizontal box size.</span>
<span class="sd">        range_ : tuple[float, float], default (0.0, 1.0)</span>
<span class="sd">            Range of spline domain.</span>
<span class="sd">        chunk_length : nm, optional</span>
<span class="sd">            If spline is longer than this, it will be first split into chunks,</span>
<span class="sd">            straightened respectively and all the straightened images are concatenated</span>
<span class="sd">            afterward, to avoid loading entire image into memory.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ip.ImgArray</span>
<span class="sd">            Straightened image. If Cartesian coordinate system is used, it will have &quot;zyx&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">chunk_length</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">normalize_chunk_length</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_straighten</span><span class="o">.</span><span class="n">straighten</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">straighten_cylindric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">radii</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">range_</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">chunk_length</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Straightening by building curved coordinate system around splines. Currently</span>
<span class="sd">        Cartesian coordinate system and cylindrical coordinate system are supported.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that you want to straighten.</span>
<span class="sd">        radii : tuple of float (nm), optional</span>
<span class="sd">            Lower/upper limit of radius.</span>
<span class="sd">        range_ : tuple[float, float], default (0.0, 1.0)</span>
<span class="sd">            Range of spline domain.</span>
<span class="sd">        chunk_length : nm, optional</span>
<span class="sd">            If spline is longer than this, it will be first split into chunks,</span>
<span class="sd">            straightened respectively and all the straightened images are concatenated</span>
<span class="sd">            afterward, to avoid loading entire image into memory.</span>
<span class="sd">        binsize : int, default 1</span>
<span class="sd">            Multiscale bin size used for calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ip.ImgArray</span>
<span class="sd">            Straightened image. If Cartesian coordinate system is used, it will have &quot;zyx&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">chunk_length</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">normalize_chunk_length</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_straighten</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_centers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rotate_molecules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mapping molecules along the center of a cylinder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that mapping will be calculated.</span>
<span class="sd">        interval : float (nm), optional</span>
<span class="sd">            Interval of molecules.</span>
<span class="sd">        rotate_molecules : bool, default True</span>
<span class="sd">            If True, twist the molecule orientations according to the spline twist.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Molecules object with mapped coordinates and angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rotate_molecules</span><span class="p">:</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
            <span class="n">twist</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">distances</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">spacing</span> <span class="o">*</span> <span class="n">twist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors_to_molecules</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mole</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cylinder_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylinderModel</span><span class="p">:</span>  <span class="c1"># fmt: skip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the cylinder model at the given spline ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int</span>
<span class="sd">            Spline ID from which model will be created.</span>
<span class="sd">        offsets : tuple of float, optional</span>
<span class="sd">            Offset of the model. See :meth:`map_monomers` for details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CylinderModel</span>
<span class="sd">            The cylinder model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cylinder_model</span><span class="p">(</span><span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_monomers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extensions</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map monomers in a regular cylinder shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that mapping will be calculated.</span>
<span class="sd">        offsets : tuple of float, optional</span>
<span class="sd">            The offset of origin of oblique coordinate system to map monomers.</span>
<span class="sd">        orientation : Ori or str, optional</span>
<span class="sd">            Orientation of the y-axis of each molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Object that represents monomer positions and angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cylinder_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">na</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ext0</span><span class="p">,</span> <span class="n">ext1</span> <span class="o">=</span> <span class="n">extensions</span>
        <span class="k">if</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">ext0</span> <span class="o">+</span> <span class="n">ext1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of monomers is negative.&quot;</span><span class="p">)</span>
        <span class="n">yy</span><span class="p">,</span> <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">ny</span> <span class="o">+</span> <span class="n">ext0</span> <span class="o">+</span> <span class="n">ext1</span><span class="p">,</span> <span class="n">na</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">-=</span> <span class="n">ext0</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">aa</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">locate_molecules</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mole</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_on_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map monomers in a regular cylinder shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that mapping will be calculated.</span>
<span class="sd">        coords : ndarray</span>
<span class="sd">            Integer coordinates on the cylinder surface.</span>
<span class="sd">        offsets : tuple of float, optional</span>
<span class="sd">            The offset of origin of oblique coordinate system to map monomers.</span>
<span class="sd">        orientation : Ori or str, optional</span>
<span class="sd">            Orientation of the y-axis of each molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Object that represents monomer positions and angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cylinder_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">locate_molecules</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mole</span>

    <span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_pf_line</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mapping molecules along a protofilament line.</span>

<span class="sd">        This method is useful when you want to visualize seam or protofilament, or</span>
<span class="sd">        assign molecules for subtomogram averaging of seam binding protein or doublet</span>
<span class="sd">        microtubule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int or iterable of int, optional</span>
<span class="sd">            Spline ID that mapping will be calculated.</span>
<span class="sd">        offsets : (float, float), default (0.0, 0.0)</span>
<span class="sd">            Axial offset in nm and angular offset in degree.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Object that represents protofilament positions and angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">twist</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">ny</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span>
        <span class="n">skew_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">twist</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span> <span class="o">/</span> <span class="n">spacing</span>

        <span class="n">yoffset</span><span class="p">,</span> <span class="n">aoffset</span> <span class="o">=</span> <span class="n">offsets</span>
        <span class="n">rcoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">ycoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span> <span class="o">+</span> <span class="n">yoffset</span>
        <span class="n">acoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew_rad</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">aoffset</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rcoords</span><span class="p">,</span> <span class="n">ycoords</span><span class="p">,</span> <span class="n">acoords</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">cylindrical_to_molecules</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mole</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prep_fit_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span> <span class="n">anc</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="n">anc</span><span class="o">.</span><span class="n">size</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">depth_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_depth</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">width_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>

        <span class="c1"># If subtomogram region is rotated by 45 degree, its XY-width will be</span>
        <span class="c1"># (length + width) / sqrt(2)</span>
        <span class="k">if</span> <span class="n">binsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anc</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anc</span><span class="p">)</span>
        <span class="n">center_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">size_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">width_px</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="n">roundint</span><span class="p">((</span><span class="n">width_px</span> <span class="o">+</span> <span class="n">depth_px</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.414</span><span class="p">),)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

        <span class="n">subtomograms</span> <span class="o">=</span> <span class="n">crop_tomograms</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">center_px</span><span class="p">,</span> <span class="n">size_px</span><span class="p">)</span>
        <span class="n">subtomograms</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span>
        <span class="k">return</span> <span class="n">subtomograms</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">scale</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.CylTomogram.splines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">splines</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>List of splines.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.add_spline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_spline</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{})</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Add spline path to tomogram.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(N, 3) array of coordinates. A spline curve that fit it well is added.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>order</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Order of spline curve.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extrapolate</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extrapolation mode of the spline.</p>
              </div>
            </td>
            <td>
                  <code><span title="cylindra.const.ExtrapolationMode.linear">linear</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SplineConfig


  
      dataclass
   (cylindra.components.spline.SplineConfig)" href="#cylindra.components.spline.SplineConfig">SplineConfig</a> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for spline fitting.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_spline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">extrapolate</span><span class="p">:</span> <span class="n">ExtrapolationMode</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ExtrapolationMode</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">SplineConfig</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add spline path to tomogram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : array-like</span>
<span class="sd">        (N, 3) array of coordinates. A spline curve that fit it well is added.</span>
<span class="sd">    order : int, optional</span>
<span class="sd">        Order of spline curve.</span>
<span class="sd">    extrapolate : str, optional</span>
<span class="sd">        Extrapolation mode of the spline.</span>
<span class="sd">    config : SplineConfig or dict, optional</span>
<span class="sd">        Configuration for spline fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">ncoords</span> <span class="o">=</span> <span class="n">_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">CylSpline</span><span class="p">(</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ncoords</span> <span class="o">&lt;=</span> <span class="n">spl</span><span class="o">.</span><span class="n">order</span> <span class="ow">and</span> <span class="n">ncoords</span> <span class="o">&lt;</span> <span class="n">fit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_spline</span><span class="p">(</span>
            <span class="n">fit</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
            <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">,</span>
            <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.align_to_polarity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">align_to_polarity</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="n">Ori</span><span class="o">.</span><span class="n">MinusToPlus</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Align all the splines in the direction parallel to the given polarity.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="cylindra.const.Ori">Ori</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>To which direction splines will be aligned.</p>
              </div>
            </td>
            <td>
                  <code>Ori.MinusToPlus</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Tomogram object</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Same object with updated splines.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">align_to_polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">MinusToPlus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align all the splines in the direction parallel to the given polarity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orientation : Ori or str, default Ori.MinusToPlus</span>
<span class="sd">        To which direction splines will be aligned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tomogram object</span>
<span class="sd">        Same object with updated splines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">Ori</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must be PlusToMinus or MinusToPlus.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="ow">is</span> <span class="n">Ori</span><span class="o">.</span><span class="n">none</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> has no orientation.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="o">!=</span> <span class="n">orientation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span><span class="sa">f</span><span class="s2">&quot;Cannot invert spline-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">degree_precision</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">edge_sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">max_shift</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">n_rotations</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Roughly fit splines to cylindrical structures.</p>
<p>Subtomograms will be sampled at every <code>max_interval</code> nm. In dense mode,
Subtomograms will be masked relative to XY-plane, using sigmoid function.
Sharpness of the sigmoid function is determined by <code>dense_mode_sigma</code>
(<code>dense_mode_sigma=0</code> corresponds to a step function).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to fit.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval of sampling points in nm unit.</p>
              </div>
            </td>
            <td>
                  <code>30.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>degree_precision</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Precision of xy-tilt degree in angular correlation.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for fitting.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edge_sigma</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sharpness of mask at the edges. If not None, fitting will be executed after regions
outside the cylinder are masked. Soft mask is important for precision because sharp
changes in intensity cause strong correlation at the edges.</p>
              </div>
            </td>
            <td>
                  <code>2.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_shift</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum shift from the true center of the cylinder. This parameter is used in phase
cross correlation.</p>
              </div>
            </td>
            <td>
                  <code>5.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_rotations</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rotations to be tested during finding the cylinder center.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FitResult">FitResult</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Result of fitting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="n">degree_precision</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">edge_sigma</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">n_rotations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Roughly fit splines to cylindrical structures.</span>

<span class="sd">    Subtomograms will be sampled at every `max_interval` nm. In dense mode,</span>
<span class="sd">    Subtomograms will be masked relative to XY-plane, using sigmoid function.</span>
<span class="sd">    Sharpness of the sigmoid function is determined by `dense_mode_sigma`</span>
<span class="sd">    (`dense_mode_sigma=0` corresponds to a step function).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to fit.</span>
<span class="sd">    max_interval : nm, default 30.0</span>
<span class="sd">        Maximum interval of sampling points in nm unit.</span>
<span class="sd">    degree_precision : float, default 0.5</span>
<span class="sd">        Precision of xy-tilt degree in angular correlation.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for fitting.</span>
<span class="sd">    edge_sigma : nm, default 2.0</span>
<span class="sd">        Sharpness of mask at the edges. If not None, fitting will be executed after regions</span>
<span class="sd">        outside the cylinder are masked. Soft mask is important for precision because sharp</span>
<span class="sd">        changes in intensity cause strong correlation at the edges.</span>
<span class="sd">    max_shift: nm, default 5.0</span>
<span class="sd">        Maximum shift from the true center of the cylinder. This parameter is used in phase</span>
<span class="sd">        cross correlation.</span>
<span class="sd">    n_rotations : int, default 5</span>
<span class="sd">        Number of rotations to be tested during finding the cylinder center.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FitResult</span>
<span class="sd">        Result of fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.fit, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">anc</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>
    <span class="n">subtomograms</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_fit_spline</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">set_gpu</span><span class="p">():</span>
        <span class="n">subtomograms</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">soft_mask_edges</span><span class="p">(</span>
            <span class="n">subtomograms</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">edge_sigma</span>
        <span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anc</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">yx_tilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">ds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">degree_max</span> <span class="o">=</span> <span class="mf">14.0</span>
        <span class="n">nrots</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">degree_max</span> <span class="o">/</span> <span class="n">degree_precision</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Angular correlation</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">dask_angle_corr</span><span class="p">(</span><span class="n">subtomograms</span><span class="p">,</span> <span class="n">yx_tilt</span><span class="p">,</span> <span class="n">nrots</span><span class="o">=</span><span class="n">nrots</span><span class="p">)</span>
        <span class="n">refined_tilt_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">refined_tilt_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">refined_tilt_deg</span><span class="p">)</span>

        <span class="c1"># If subtomograms are sampled at short intervals, angles should be smoothened to</span>
        <span class="c1"># avoid overfitting.</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">roundint</span><span class="p">(</span><span class="mf">48.0</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Mirror-mode padding is &quot;a b c d | c b a&quot;.</span>
            <span class="n">refined_tilt_rad</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">angle_uniform_filter</span><span class="p">(</span>
                <span class="n">refined_tilt_rad</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Mode</span><span class="o">.</span><span class="n">mirror</span>
            <span class="p">)</span>
            <span class="n">refined_tilt_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">refined_tilt_rad</span><span class="p">)</span>

        <span class="c1"># Rotate subtomograms in YX plane</span>
        <span class="k">for</span> <span class="n">_j</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subtomograms</span><span class="p">):</span>
            <span class="n">img</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">refined_tilt_deg</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span>
            <span class="n">img</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># zx-shift correction by self-ZNCC</span>
        <span class="n">subtomo_proj</span> <span class="o">=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">edge_sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Regions outside the mask don&#39;t need to be considered.</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subtomo_proj</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">subtomo_proj</span> <span class="o">=</span> <span class="n">subtomo_proj</span><span class="p">[</span><span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">xc</span> <span class="o">-</span> <span class="n">w</span> <span class="p">:</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="n">max_shift_px</span> <span class="o">=</span> <span class="n">max_shift</span> <span class="o">/</span> <span class="n">scale</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">pf_ang</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">center</span>
        <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_rotations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">multi_rotated_auto_zncc</span><span class="p">(</span><span class="n">subtomo_proj</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">max_shift_px</span><span class="p">)</span>

    <span class="c1"># Update spline coordinates.</span>
    <span class="c1"># Because centers of subtomogram are on lattice points of pixel coordinate,</span>
    <span class="c1"># coordinates that will be shifted should be converted to integers.</span>
    <span class="n">coords_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anc</span><span class="p">),</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">coords_px_new</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">shift_coords</span><span class="p">(</span><span class="n">coords_px</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">refined_tilt_rad</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">coords_px_new</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

    <span class="c1"># Update spline parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">(</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Shift RMSD = </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">rmsd</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.get_cylinder_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_cylinder_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return the cylinder model at the given spline ID.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID from which model will be created.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offsets</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Offset of the model. See :meth:<code>map_monomers</code> for details.</p>
              </div>
            </td>
            <td>
                  <code>(0.0, 0.0)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="cylindra.components.cylindric.CylinderModel">CylinderModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cylinder model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_cylinder_model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylinderModel</span><span class="p">:</span>  <span class="c1"># fmt: skip</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the cylinder model at the given spline ID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Spline ID from which model will be created.</span>
<span class="sd">    offsets : tuple of float, optional</span>
<span class="sd">        Offset of the model. See :meth:`map_monomers` for details.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CylinderModel</span>
<span class="sd">        The cylinder model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cylinder_model</span><span class="p">(</span><span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.global_cft" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">global_cft</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate global cylindrical fast Fourier tranformation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="impy.ImgArray">ImgArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Complex image.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">global_cft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate global cylindrical fast Fourier tranformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ip.ImgArray</span>
<span class="sd">        Complex image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="n">img_st</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_st</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_st</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="s2">&quot;rya&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.global_cft_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">global_cft_params</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate global lattice parameters.</p>
<p>This function transforms tomogram using cylindrical coordinate system along
spline. This function calls <code>straighten</code> beforehand, so that Fourier space is
distorted if the cylindrical structure is curved.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nsamples</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of cylindrical coordinate samplings for Fourier transformation.
Multiple samplings are needed because up-sampled discrete Fourier
transformation does not return exactly the same power spectra with shifted
inputs, unlike FFT. Larger <code>nsamples</code> reduces the error but is slower.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>update</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, spline properties will be updated.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Global properties.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">global_cft_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate global lattice parameters.</span>

<span class="sd">    This function transforms tomogram using cylindrical coordinate system along</span>
<span class="sd">    spline. This function calls ``straighten`` beforehand, so that Fourier space is</span>
<span class="sd">    distorted if the cylindrical structure is curved.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>
<span class="sd">    nsamples : int, default 8</span>
<span class="sd">        Number of cylindrical coordinate samplings for Fourier transformation.</span>
<span class="sd">        Multiple samplings are needed because up-sampled discrete Fourier</span>
<span class="sd">        transformation does not return exactly the same power spectra with shifted</span>
<span class="sd">        inputs, unlike FFT. Larger ``nsamples`` reduces the error but is slower.</span>
<span class="sd">    update : bool, default True</span>
<span class="sd">        If True, spline properties will be updated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pl.DataFrame</span>
<span class="sd">        Global properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.global_cft_params, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">()</span>
    <span class="n">img_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">radii</span><span class="o">=</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">+</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">lparams</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">estimate_lattice_params_polar</span><span class="p">(</span><span class="n">img_st</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">nsamples</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lparams</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.global_cps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">global_cps</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate global cylindrical power spectra.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="impy.ImgArray">ImgArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Complex image.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">global_cps</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate global cylindrical power spectra.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ip.ImgArray</span>
<span class="sd">        Complex image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_cft</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cft</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cft</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.infer_polarity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">infer_polarity</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">mask_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Infer spline polarities using polar 2D image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depth of images used to infer polarities.</p>
              </div>
            </td>
            <td>
                  <code>40.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="cylindra.const.Ori">Ori</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of corresponding splines.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">infer_polarity</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
    <span class="n">mask_freq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ori</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Infer spline polarities using polar 2D image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>
<span class="sd">    depth : nm, default 40.0</span>
<span class="sd">        Depth of images used to infer polarities.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Ori</span>
<span class="sd">        Orientation of corresponding splines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.infer_polarity, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">current_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span>

    <span class="k">if</span> <span class="n">binsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>

    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span>
    <span class="n">ori_clockwise</span> <span class="o">=</span> <span class="n">Ori</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">clockwise</span><span class="p">)</span>
    <span class="n">ori_counterclockwise</span> <span class="o">=</span> <span class="n">Ori</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ori_clockwise</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">current_scale</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">()</span>
    <span class="n">point</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># the sampling point</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">local_cylindrical</span><span class="p">(</span><span class="n">r_range</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">current_scale</span><span class="p">)</span>
    <span class="n">polar</span> <span class="o">=</span> <span class="n">get_polar_image</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_freq</span><span class="p">:</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span><span class="o">.</span><span class="n">mask_spectra</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
    <span class="n">img_flat</span> <span class="o">=</span> <span class="n">polar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">npf</span> <span class="o">:=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if the global properties are already calculated, use it</span>
        <span class="c1"># otherwise, calculate the number of PFs from the power spectrum</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">img_flat</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">shift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;ra&quot;</span><span class="p">)</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ft</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">img_pw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">npf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img_pw</span><span class="p">[</span><span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">asslice</span><span class="p">()])</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">npf_range</span><span class="o">.</span><span class="n">min</span>

    <span class="n">pw_peak</span> <span class="o">=</span> <span class="n">img_flat</span><span class="o">.</span><span class="n">local_power_spectra</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">npf</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">npf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">upsample_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">r_argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pw_peak</span><span class="p">)</span>
    <span class="n">clkwise</span> <span class="o">=</span> <span class="n">r_argmax</span> <span class="o">-</span> <span class="p">(</span><span class="n">pw_peak</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="n">ori</span> <span class="o">=</span> <span class="n">ori_clockwise</span> <span class="k">if</span> <span class="n">clkwise</span> <span class="k">else</span> <span class="n">ori_counterclockwise</span>

    <span class="c1"># logging</span>
    <span class="n">_val</span> <span class="o">=</span> <span class="n">pw_peak</span><span class="p">[</span><span class="n">r_argmax</span><span class="p">]</span>
    <span class="n">pw_non_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pw_peak</span><span class="p">,</span> <span class="n">r_argmax</span><span class="p">)</span>
    <span class="n">_ave</span><span class="p">,</span> <span class="n">_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pw_non_peak</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pw_non_peak</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; polarity = </span><span class="si">{</span><span class="n">ori</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (peak intensity=</span><span class="si">{</span><span class="n">_val</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2"> compared to </span><span class="si">{</span><span class="n">_ave</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">_std</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">ori</span>
    <span class="k">return</span> <span class="n">ori</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.local_cft" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_cft</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate non-upsampled local cylindric Fourier transormation along spline.</p>
<p>This function does not up-sample.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of subtomogram for calculation of local parameters.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pos</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Only calculate at <code>pos</code>-th anchor if given.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="impy.ImgArray">ImgArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>FT images stacked along "p" axis.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">local_cft</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate non-upsampled local cylindric Fourier transormation along spline.</span>

<span class="sd">    This function does not up-sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    depth : nm, default 50.0</span>
<span class="sd">        Length of subtomogram for calculation of local parameters.</span>
<span class="sd">    pos : int, optional</span>
<span class="sd">        Only calculate at ``pos``-th anchor if given.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ip.ImgArray</span>
<span class="sd">        FT images stacked along &quot;p&quot; axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">]()</span>
    <span class="k">with</span> <span class="n">set_gpu</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">polar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_local_image</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">binsize</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polar</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="s2">&quot;rya&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.local_cft_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_cft_params</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_glob</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate local lattice parameters from cylindrical Fourier space.</p>
<p>To determine the peaks upsampled discrete Fourier transformation is used
for every subtomogram.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of subtomogram for calculation of local parameters.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>radius</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If "local", use the local radius for the analysis. If "global", use the
global radius. If a float, use the given radius.</p>
              </div>
            </td>
            <td>
                  <code>&#34;global&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nsamples</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of cylindrical coordinate samplings for Fourier transformation. Multiple
samplings are needed because up-sampled discrete Fourier transformation does not
return exactly the same power spectra with shifted inputs, unlike FFT. Larger
<code>nsamples</code> reduces the error but is slower.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>update</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, spline properties will be updated.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>update_glob</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, global properties will be updated using the mean or mode of the local
properties.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Local properties.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">local_cft_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span>
    <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">update_glob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate local lattice parameters from cylindrical Fourier space.</span>

<span class="sd">    To determine the peaks upsampled discrete Fourier transformation is used</span>
<span class="sd">    for every subtomogram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    depth : nm, default 50.0</span>
<span class="sd">        Length of subtomogram for calculation of local parameters.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>
<span class="sd">    radius : str, default &quot;global&quot;</span>
<span class="sd">        If &quot;local&quot;, use the local radius for the analysis. If &quot;global&quot;, use the</span>
<span class="sd">        global radius. If a float, use the given radius.</span>
<span class="sd">    nsamples : int, default 8</span>
<span class="sd">        Number of cylindrical coordinate samplings for Fourier transformation. Multiple</span>
<span class="sd">        samplings are needed because up-sampled discrete Fourier transformation does not</span>
<span class="sd">        return exactly the same power spectra with shifted inputs, unlike FFT. Larger</span>
<span class="sd">        ``nsamples`` reduces the error but is slower.</span>
<span class="sd">    update : bool, default True</span>
<span class="sd">        If True, spline properties will be updated.</span>
<span class="sd">    update_glob : bool, default False</span>
<span class="sd">        If True, global properties will be updated using the mean or mode of the local</span>
<span class="sd">        properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    polars.DataFrame</span>
<span class="sd">        Local properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.local_cft_params, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">prepare_radii</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
    <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Delayed</span><span class="p">[</span><span class="n">LatticeParams</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">_analyze_fn</span> <span class="o">=</span> <span class="n">LatticeAnalyzer</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">estimate_lattice_params_task</span>
    <span class="k">for</span> <span class="n">anc</span><span class="p">,</span> <span class="n">r0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spl_trans</span><span class="o">.</span><span class="n">anchors</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius_range</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">+</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">spl_trans</span><span class="o">.</span><span class="n">local_cylindrical</span><span class="p">((</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">),</span> <span class="n">depth</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">_scale</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_analyze_fn</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">nsamples</span><span class="p">))</span>

    <span class="n">lprops</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">),</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">LatticeParams</span><span class="o">.</span><span class="n">polars_schema</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">(</span><span class="n">lprops</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_glob</span><span class="p">:</span>
        <span class="n">gprops</span> <span class="o">=</span> <span class="n">lprops</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">skew</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">rise</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">rise_length</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span><span class="n">gprops</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lprops</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.local_cps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_cps</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Calculate non-upsampled local cylindric power spectra along spline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of subtomogram for calculation of local parameters.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pos</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Only calculate at <code>pos</code>-th anchor if given.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="impy.ImgArray">ImgArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>FT images stacked along "p" axis.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">local_cps</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate non-upsampled local cylindric power spectra along spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    depth : nm, default 50.0</span>
<span class="sd">        Length of subtomogram for calculation of local parameters.</span>
<span class="sd">    pos : int, optional</span>
<span class="sd">        Only calculate at ``pos``-th anchor if given.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ip.ImgArray</span>
<span class="sd">        FT images stacked along &quot;p&quot; axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cft</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cft</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cft</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.local_radii" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_radii</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_glob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Measure the local radii along the splines.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>depth</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Longitudinal length of subtomograms for calculation.</p>
              </div>
            </td>
            <td>
                  <code>50.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale binsize to be used.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_radius</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum radius of the cylinder.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_radius</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum radius of the cylinder.</p>
              </div>
            </td>
            <td>
                  <code>100.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>update</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, spline properties will be updated.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>update_glob</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, global properties will be updated using the mean of the local
radii.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Radii along the spline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">local_radii</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">min_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">update_glob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measure the local radii along the splines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to analyze.</span>
<span class="sd">    depth : nm, default 50.0</span>
<span class="sd">        Longitudinal length of subtomograms for calculation.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale binsize to be used.</span>
<span class="sd">    min_radius : nm, default 1.0</span>
<span class="sd">        Minimum radius of the cylinder.</span>
<span class="sd">    max_radius : nm, default 100.0</span>
<span class="sd">        Maximum radius of the cylinder.</span>
<span class="sd">    update : bool, default True</span>
<span class="sd">        If True, spline properties will be updated.</span>
<span class="sd">    update_glob : bool, default True</span>
<span class="sd">        If True, global properties will be updated using the mean of the local</span>
<span class="sd">        radii.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pl.Series</span>
<span class="sd">        Radii along the spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.local_radii, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

    <span class="n">depth</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_depth</span>
    <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_thickness</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">_scale</span><span class="p">)</span>
    <span class="n">min_radius_px</span> <span class="o">=</span> <span class="n">min_radius</span> <span class="o">/</span> <span class="n">_scale</span>
    <span class="n">max_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">max_radius_px</span> <span class="o">=</span> <span class="n">max_radius</span> <span class="o">/</span> <span class="n">_scale</span>
    <span class="n">offset_px</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_radius_offset</span><span class="p">(</span><span class="n">min_radius_px</span><span class="p">,</span> <span class="n">max_radius_px</span><span class="p">)</span>
    <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">spl_trans</span><span class="o">.</span><span class="n">anchors</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_radial_prof</span><span class="p">(</span>
            <span class="n">input_img</span><span class="p">,</span> <span class="n">spl_trans</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">),</span> <span class="n">depth</span>
        <span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">profs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]]</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">prof</span> <span class="ow">in</span> <span class="n">profs</span><span class="p">:</span>
        <span class="n">imax_sub</span> <span class="o">=</span> <span class="n">find_centroid_peak</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">*</span><span class="n">thickness</span><span class="p">)</span>
        <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">imax_sub</span> <span class="o">+</span> <span class="n">offset_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">_scale</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_loc</span><span class="p">([</span><span class="n">out</span><span class="p">],</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_glob</span><span class="p">:</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">mean</span><span class="p">()])],</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.make_anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_anchors</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Make anchors on spline object(s).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Anchor intervals.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of anchors</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval between anchors.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_anchors</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make anchors on spline object(s).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interval : nm, optional</span>
<span class="sd">        Anchor intervals.</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        Number of anchors</span>
<span class="sd">    max_interval : nm, optional</span>
<span class="sd">        Maximum interval between anchors.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">make_anchors</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.map_centers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_centers</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotate_molecules</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Mapping molecules along the center of a cylinder.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that mapping will be calculated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>(<span title="cylindra.const.nm">nm</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval of molecules.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rotate_molecules</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, twist the molecule orientations according to the spline twist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules object with mapped coordinates and angles.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">map_centers</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rotate_molecules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mapping molecules along the center of a cylinder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that mapping will be calculated.</span>
<span class="sd">    interval : float (nm), optional</span>
<span class="sd">        Interval of molecules.</span>
<span class="sd">    rotate_molecules : bool, default True</span>
<span class="sd">        If True, twist the molecule orientations according to the spline twist.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Molecules object with mapped coordinates and angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rotate_molecules</span><span class="p">:</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">twist</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">distances</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">spacing</span> <span class="o">*</span> <span class="n">twist</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors_to_molecules</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mole</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.map_monomers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_monomers</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Map monomers in a regular cylinder shape.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that mapping will be calculated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offsets</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The offset of origin of oblique coordinate system to map monomers.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="cylindra.const.Ori">Ori</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of the y-axis of each molecule.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object that represents monomer positions and angles.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">map_monomers</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extensions</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map monomers in a regular cylinder shape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that mapping will be calculated.</span>
<span class="sd">    offsets : tuple of float, optional</span>
<span class="sd">        The offset of origin of oblique coordinate system to map monomers.</span>
<span class="sd">    orientation : Ori or str, optional</span>
<span class="sd">        Orientation of the y-axis of each molecule.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Object that represents monomer positions and angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cylinder_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">na</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ext0</span><span class="p">,</span> <span class="n">ext1</span> <span class="o">=</span> <span class="n">extensions</span>
    <span class="k">if</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">ext0</span> <span class="o">+</span> <span class="n">ext1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of monomers is negative.&quot;</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">,</span> <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">ny</span> <span class="o">+</span> <span class="n">ext0</span> <span class="o">+</span> <span class="n">ext1</span><span class="p">,</span> <span class="n">na</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">-=</span> <span class="n">ext0</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">aa</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">locate_molecules</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mole</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.map_on_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_on_grid</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(),</span> <span class="o">*</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Map monomers in a regular cylinder shape.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that mapping will be calculated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Integer coordinates on the cylinder surface.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offsets</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The offset of origin of oblique coordinate system to map monomers.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="cylindra.const.Ori">Ori</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Orientation of the y-axis of each molecule.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object that represents monomer positions and angles.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">map_on_grid</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map monomers in a regular cylinder shape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that mapping will be calculated.</span>
<span class="sd">    coords : ndarray</span>
<span class="sd">        Integer coordinates on the cylinder surface.</span>
<span class="sd">    offsets : tuple of float, optional</span>
<span class="sd">        The offset of origin of oblique coordinate system to map monomers.</span>
<span class="sd">    orientation : Ori or str, optional</span>
<span class="sd">        Orientation of the y-axis of each molecule.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Object that represents monomer positions and angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cylinder_model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">locate_molecules</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mole</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.map_pf_line" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_pf_line</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Mapping molecules along a protofilament line.</p>
<p>This method is useful when you want to visualize seam or protofilament, or
assign molecules for subtomogram averaging of seam binding protein or doublet
microtubule.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that mapping will be calculated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offsets</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Axial offset in nm and angular offset in degree.</p>
              </div>
            </td>
            <td>
                  <code>(0.0, 0.0)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object that represents protofilament positions and angles.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">map_pf_line</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">Ori</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mapping molecules along a protofilament line.</span>

<span class="sd">    This method is useful when you want to visualize seam or protofilament, or</span>
<span class="sd">    assign molecules for subtomogram averaging of seam binding protein or doublet</span>
<span class="sd">    microtubule.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that mapping will be calculated.</span>
<span class="sd">    offsets : (float, float), default (0.0, 0.0)</span>
<span class="sd">        Axial offset in nm and angular offset in degree.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Object that represents protofilament positions and angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
    <span class="n">twist</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get_glob</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">ny</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">skew_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">twist</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span> <span class="o">/</span> <span class="n">spacing</span>

    <span class="n">yoffset</span><span class="p">,</span> <span class="n">aoffset</span> <span class="o">=</span> <span class="n">offsets</span>
    <span class="n">rcoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">ycoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span> <span class="o">+</span> <span class="n">yoffset</span>
    <span class="n">acoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew_rad</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">aoffset</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rcoords</span><span class="p">,</span> <span class="n">ycoords</span><span class="p">,</span> <span class="n">acoords</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">cylindrical_to_molecules</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spl</span><span class="o">.</span><span class="n">_need_rotation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotate_by_rotvec_internal</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mole</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.measure_radius" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">measure_radius</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">min_radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Measure radius using radial profile from the center.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to measure.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for radius calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>positions</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span> or &#39;auto&#39; or &#39;anchor&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sampling positions (between 0 and 1) to calculate radius. If "anchor"
is given, anchors of the spline will be used. If "auto" is given,
three positions along the spline will be used.</p>
              </div>
            </td>
            <td>
                  <code>&#34;auto&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_radius</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum radius of the cylinder.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_radius</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum radius of the cylinder.</p>
              </div>
            </td>
            <td>
                  <code>100.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>update</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, global radius property will be updated.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>(<span title="cylindra.const.nm">nm</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cylinder radius.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">measure_radius</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;anchor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">min_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_radius</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measure radius using radial profile from the center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to measure.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for radius calculation.</span>
<span class="sd">    positions : array-like or &quot;auto&quot; or &quot;anchor&quot;, default &quot;auto&quot;</span>
<span class="sd">        Sampling positions (between 0 and 1) to calculate radius. If &quot;anchor&quot;</span>
<span class="sd">        is given, anchors of the spline will be used. If &quot;auto&quot; is given,</span>
<span class="sd">        three positions along the spline will be used.</span>
<span class="sd">    min_radius : nm, default 1.0</span>
<span class="sd">        Minimum radius of the cylinder.</span>
<span class="sd">    max_radius : nm, default 100.0</span>
<span class="sd">        Maximum radius of the cylinder.</span>
<span class="sd">    update : bool, default True</span>
<span class="sd">        If True, global radius property will be updated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float (nm)</span>
<span class="sd">        Cylinder radius.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.measure_radius, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">positions</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">nanchor</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">nanchor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nanchor</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">nanchor</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">positions</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">anchors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

    <span class="n">depth</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_depth</span>
    <span class="n">_scale</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
    <span class="n">min_radius_px</span> <span class="o">=</span> <span class="n">min_radius</span> <span class="o">/</span> <span class="n">_scale</span>
    <span class="n">max_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">spl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">max_radius_px</span> <span class="o">=</span> <span class="n">max_radius</span> <span class="o">/</span> <span class="n">_scale</span>
    <span class="n">spl_trans</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_misc</span><span class="o">.</span><span class="n">get_radial_prof</span><span class="p">(</span>
            <span class="n">input_img</span><span class="p">,</span> <span class="n">spl_trans</span><span class="p">,</span> <span class="n">anc</span><span class="p">,</span> <span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">),</span> <span class="n">depth</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">pos</span>
    <span class="p">]</span>
    <span class="n">profs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]]</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
    <span class="n">prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">profs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">imax_sub</span> <span class="o">=</span> <span class="n">find_centroid_peak</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">*</span><span class="n">_misc</span><span class="o">.</span><span class="n">get_thickness</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">_scale</span><span class="p">))</span>
    <span class="n">offset_px</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_radius_offset</span><span class="p">(</span><span class="n">min_radius_px</span><span class="p">,</span> <span class="n">max_radius_px</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">imax_sub</span> <span class="o">+</span> <span class="n">offset_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">_scale</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update_glob</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="p">[</span><span class="n">radius</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)],</span>
            <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Radius = </span><span class="si">{</span><span class="n">radius</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">radius</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.refine" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">refine</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_interval</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">corr_allowed</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_shift</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">n_rotations</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Spline refinement using global lattice structural parameters.</p>
<p>Refine spline using the result of previous fit and the global structural parameters.
During refinement, Y-projection of XZ cross section of cylinder is rotated with the
twist angles, thus is much more precise than the coarse fitting.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to fit.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_interval</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum interval of sampling points in nm unit.</p>
              </div>
            </td>
            <td>
                  <code>24.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for refining.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>corr_allowed</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <span title="defaul">defaul</span> is 0.9)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many images will be used to make template for alignment. If 0.9, then top
90% will be used.</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_shift</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum shift from the true center of the cylinder. This parameter is used in
phase cross correlation.</p>
              </div>
            </td>
            <td>
                  <code>2.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_rotations</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rotations to be tested during finding the cylinder center.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FitResult">FitResult</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Result of fitting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refine</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_interval</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">err_max</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">corr_allowed</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">max_shift</span><span class="p">:</span> <span class="n">nm</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">n_rotations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spline refinement using global lattice structural parameters.</span>

<span class="sd">    Refine spline using the result of previous fit and the global structural parameters.</span>
<span class="sd">    During refinement, Y-projection of XZ cross section of cylinder is rotated with the</span>
<span class="sd">    twist angles, thus is much more precise than the coarse fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to fit.</span>
<span class="sd">    max_interval : nm, default 24.0</span>
<span class="sd">        Maximum interval of sampling points in nm unit.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for refining.</span>
<span class="sd">    corr_allowed : float, defaul is 0.9</span>
<span class="sd">        How many images will be used to make template for alignment. If 0.9, then top</span>
<span class="sd">        90% will be used.</span>
<span class="sd">    max_shift: nm, default 2.0</span>
<span class="sd">        Maximum shift from the true center of the cylinder. This parameter is used in</span>
<span class="sd">        phase cross correlation.</span>
<span class="sd">    n_rotations : int, default 3</span>
<span class="sd">        Number of rotations to be tested during finding the cylinder center.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FitResult</span>
<span class="sd">        Result of fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.refine, i=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">_required</span> <span class="o">=</span> <span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">has_glob</span><span class="p">(</span><span class="n">_required</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">radius</span> <span class="o">:=</span> <span class="n">spl</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_radius</span><span class="p">(</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
                <span class="n">positions</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">temp_glob</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">):</span>
            <span class="n">gprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_cft_params</span><span class="p">(</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gprops</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">glob</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">_required</span><span class="p">)</span>
    <span class="n">gdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">gprops</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_required</span><span class="p">}</span>
    <span class="n">ancs</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">prep_anchor_positions</span><span class="p">(</span><span class="n">max_interval</span><span class="o">=</span><span class="n">max_interval</span><span class="p">)</span>

    <span class="c1"># Calculate Fourier parameters by cylindrical transformation along spline.</span>
    <span class="c1"># Skew angles are divided by the angle of single protofilament and the residual</span>
    <span class="c1"># angles are used, considering missing wedge effect.</span>
    <span class="n">space</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">spacing</span><span class="p">]</span>
    <span class="n">twist</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">twist</span><span class="p">]</span>
    <span class="n">npf</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">gdict</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">npf</span><span class="p">])</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Parameters: spacing = </span><span class="si">{</span><span class="n">space</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm, twist = </span><span class="si">{</span><span class="n">twist</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> deg, PF = </span><span class="si">{</span><span class="n">npf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># fmt: skip</span>

    <span class="c1"># complement twisting</span>
    <span class="n">pf_ang</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">npf</span>
    <span class="n">twists</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">get_twists</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span> <span class="n">ancs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">twist</span><span class="p">,</span> <span class="n">npf</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">prep_loader_for_refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">ancs</span><span class="p">,</span> <span class="n">binsize</span><span class="p">,</span> <span class="n">twists</span><span class="p">)</span>
    <span class="n">subtomograms</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;pzyx&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">subtomograms</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># normalize</span>
    <span class="n">subtomograms</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">zyx</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

    <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pf_ang</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_rotations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span>
    <span class="n">max_shift_px</span> <span class="o">=</span> <span class="n">max_shift</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="k">with</span> <span class="n">set_gpu</span><span class="p">():</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">subtomograms</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)[</span><span class="n">ip</span><span class="o">.</span><span class="n">slicer</span><span class="o">.</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Align twist-corrected images</span>
        <span class="n">shifts_loc</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">multi_rotated_auto_zncc</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">max_shift_px</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_misc</span><span class="o">.</span><span class="n">delayed_translate</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span> <span class="n">shifts_loc</span><span class="p">[</span><span class="n">_j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ancs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">imgs_aligned</span> <span class="o">=</span> <span class="n">_filter_by_corr</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="n">corr_allowed</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Make 2D template using coarse aligned images.</span>
        <span class="n">imgcory</span> <span class="o">=</span> <span class="n">imgs_aligned</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">rotated_auto_zncc</span><span class="p">(</span>
            <span class="n">imgcory</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="n">degrees</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shift_px</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">imgcory</span><span class="o">.</span><span class="n">affine</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Mode</span><span class="o">.</span><span class="n">constant</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Align twist-corrected images to the template</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">quaternion</span><span class="p">()</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_misc</span><span class="o">.</span><span class="n">delayed_zncc_maximum</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span>
                <span class="n">_misc</span><span class="o">.</span><span class="n">mask_missing_wedge</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt_model</span><span class="p">,</span> <span class="n">quat</span><span class="p">[</span><span class="n">_j</span><span class="p">]),</span>
                <span class="n">max_shift_px</span><span class="p">,</span>
                <span class="n">twists</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ancs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Update spline parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">ancs</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">err_max</span><span class="o">=</span><span class="n">err_max</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">FitResult</span><span class="p">(</span><span class="n">shifts</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt;&gt; Shift RMSD = </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">rmsd</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.straighten" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">straighten</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">chunk_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Straightening by building curved coordinate system around splines. Currently
Cartesian coordinate system and cylindrical coordinate system are supported.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to straighten.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>(<span title="cylindra.const.nm">nm</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical/horizontal box size.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range_</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of spline domain.</p>
              </div>
            </td>
            <td>
                  <code>(0.0, 1.0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_length</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If spline is longer than this, it will be first split into chunks,
straightened respectively and all the straightened images are concatenated
afterward, to avoid loading entire image into memory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="impy.ImgArray">ImgArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Straightened image. If Cartesian coordinate system is used, it will have "zyx".</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">straighten</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">range_</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">chunk_length</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Straightening by building curved coordinate system around splines. Currently</span>
<span class="sd">    Cartesian coordinate system and cylindrical coordinate system are supported.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to straighten.</span>
<span class="sd">    size : float (nm), optional</span>
<span class="sd">        Vertical/horizontal box size.</span>
<span class="sd">    range_ : tuple[float, float], default (0.0, 1.0)</span>
<span class="sd">        Range of spline domain.</span>
<span class="sd">    chunk_length : nm, optional</span>
<span class="sd">        If spline is longer than this, it will be first split into chunks,</span>
<span class="sd">        straightened respectively and all the straightened images are concatenated</span>
<span class="sd">        afterward, to avoid loading entire image into memory.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ip.ImgArray</span>
<span class="sd">        Straightened image. If Cartesian coordinate system is used, it will have &quot;zyx&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
    <span class="n">chunk_length</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">normalize_chunk_length</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_straighten</span><span class="o">.</span><span class="n">straighten</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.CylTomogram.straighten_cylindric" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">radii</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">chunk_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Straightening by building curved coordinate system around splines. Currently
Cartesian coordinate system and cylindrical coordinate system are supported.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spline ID that you want to straighten.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>radii</code>
            </td>
            <td>
                  <code>tuple of float (nm)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lower/upper limit of radius.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range_</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of spline domain.</p>
              </div>
            </td>
            <td>
                  <code>(0.0, 1.0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_length</code>
            </td>
            <td>
                  <code><span title="cylindra.const.nm">nm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If spline is longer than this, it will be first split into chunks,
straightened respectively and all the straightened images are concatenated
afterward, to avoid loading entire image into memory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiscale bin size used for calculation.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="impy.ImgArray">ImgArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Straightened image. If Cartesian coordinate system is used, it will have "zyx".</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_cyl_tomo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@_misc</span><span class="o">.</span><span class="n">batch_process</span>
<span class="k">def</span><span class="w"> </span><span class="nf">straighten_cylindric</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">radii</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">range_</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">chunk_length</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Straightening by building curved coordinate system around splines. Currently</span>
<span class="sd">    Cartesian coordinate system and cylindrical coordinate system are supported.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int or iterable of int, optional</span>
<span class="sd">        Spline ID that you want to straighten.</span>
<span class="sd">    radii : tuple of float (nm), optional</span>
<span class="sd">        Lower/upper limit of radius.</span>
<span class="sd">    range_ : tuple[float, float], default (0.0, 1.0)</span>
<span class="sd">        Range of spline domain.</span>
<span class="sd">    chunk_length : nm, optional</span>
<span class="sd">        If spline is longer than this, it will be first split into chunks,</span>
<span class="sd">        straightened respectively and all the straightened images are concatenated</span>
<span class="sd">        afterward, to avoid loading entire image into memory.</span>
<span class="sd">    binsize : int, default 1</span>
<span class="sd">        Multiscale bin size used for calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ip.ImgArray</span>
<span class="sd">        Straightened image. If Cartesian coordinate system is used, it will have &quot;zyx&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">input_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
    <span class="n">chunk_length</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">normalize_chunk_length</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_straighten</span><span class="o">.</span><span class="n">straighten_cylindric</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.tomogram.Tomogram" class="doc doc-heading">
            <code>Tomogram</code>


</h4>


    <div class="doc doc-contents ">


        <p>Lazy-loading/multi-scale tomogram object.</p>
<p>It is always connected to a 3D image but processed lazily. Thus you can create
a lot of Tomogram objects without MemoryError. Subtomograms are temporarily
loaded into memory via cache map. Once memory usage exceed certain amount, the
subtomogram cache will automatically deleted from the old ones.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tomogram</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lazy-loading/multi-scale tomogram object.</span>

<span class="sd">    It is always connected to a 3D image but processed lazily. Thus you can create</span>
<span class="sd">    a lot of Tomogram objects without MemoryError. Subtomograms are temporarily</span>
<span class="sd">    loaded into memory via cache map. Once memory usage exceed certain amount, the</span>
<span class="sd">    subtomogram cache will automatically deleted from the old ones.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">]]()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="p">:</span> <span class="n">TiltSeriesModel</span> <span class="o">=</span> <span class="n">single_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use unsafe hash.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(shape=</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">, scale=</span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2">, source=</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scale of the tomogram.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_scale</span><span class="p">:</span> <span class="n">nm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="n">new_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">new_scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_img</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">:</span>
            <span class="n">_img</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">new_scale</span> <span class="o">*</span> <span class="n">_b</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata relevant to the tomogram.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="nd">@metadata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot set type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> as a metadata.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the source file.&quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source file is unknown.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tilt_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tilt model of the tomogram.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tilt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tilt model as a dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="p">,</span> <span class="n">SingleAxisX</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="o">.</span><span class="n">tilt_range</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="p">,</span> <span class="n">SingleAxisY</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="o">.</span><span class="n">tilt_range</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="p">,</span> <span class="n">NoWedge</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="p">,</span> <span class="n">UnionAxes</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;dual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xrange&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="o">.</span><span class="n">_wedges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tilt_range</span><span class="p">,</span>
                <span class="s2">&quot;yrange&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span><span class="o">.</span><span class="n">_wedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tilt_range</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tilt model is not correctly set.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_inverted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if this image is inverted&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_inverted&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dummy</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">tilt</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a dummy tomogram.&quot;&quot;&quot;</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">)</span>
        <span class="n">dummy</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">tomo</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_image</span><span class="p">(</span>
            <span class="n">dummy</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">tomo</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_dummy&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">tomo</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if this tomogram object does not have a real image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_dummy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_image</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tilt</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Tomogram object from a image array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        img : array-like</span>
<span class="sd">            Input image.</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            Pixel size in nm. If not given, will try to read from image header.</span>
<span class="sd">        tilt : tuple of float, optional</span>
<span class="sd">            Tilt model.</span>
<span class="sd">        binsize : int or iterable of int, optional</span>
<span class="sd">            Binsize to generate multiscale images. If not given, will not generate.</span>
<span class="sd">        compute : bool, default True</span>
<span class="sd">            Whether to compute the binned images.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tomogram</span>
<span class="sd">            Tomogram object with the image that has just been read and multi-scales.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span>
                <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uneven scale: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">:=</span> <span class="n">img</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="c1"># parse tilt model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tilt</span><span class="p">,</span> <span class="n">TiltSeriesModel</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tilt</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">match</span> <span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]:</span>
                    <span class="k">case</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                        <span class="n">tilt</span> <span class="o">=</span> <span class="n">NoWedge</span><span class="p">()</span>
                    <span class="k">case</span> <span class="s2">&quot;x&quot;</span> <span class="o">|</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                        <span class="n">tilt</span> <span class="o">=</span> <span class="n">single_axis</span><span class="p">(</span><span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">],</span> <span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">])</span>
                    <span class="k">case</span> <span class="s2">&quot;dual&quot;</span><span class="p">:</span>
                        <span class="n">tilt</span> <span class="o">=</span> <span class="n">dual_axis</span><span class="p">(</span><span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;yrange&quot;</span><span class="p">],</span> <span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;xrange&quot;</span><span class="p">])</span>
                    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Tilt model </span><span class="si">{</span><span class="n">tilt</span><span class="si">!r}</span><span class="s2"> not in a correct format.&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tilt</span> <span class="o">=</span> <span class="n">single_axis</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span> <span class="o">=</span> <span class="n">tilt</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">binsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">binsize</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">binsize</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_multiscale</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">imread</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tilt</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">eager</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a image as a dask array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : path-like</span>
<span class="sd">            Path to the image file.</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            Pixel size in nm. If not given, will try to read from image header.</span>
<span class="sd">        tilt : tuple of float, optional</span>
<span class="sd">            Tilt model.</span>
<span class="sd">        binsize : int or iterable of int, optional</span>
<span class="sd">            Binsize to generate multiscale images. If not given, will not generate.</span>
<span class="sd">        eager : bool, default False</span>
<span class="sd">            Whether to read the image lazily. If True, the entire image will be read</span>
<span class="sd">            into the memory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tomogram</span>
<span class="sd">            Tomogram object with the image that has just been read and multi-scales.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">dask_chunk</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">lazy</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eager</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_image</span><span class="p">(</span>
            <span class="n">_norm_dtype</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
            <span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_cache_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set cache path.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;orig_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">orig_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cache_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tomogram image data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image is not set.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiscaled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all multi-scale factor and the corresponding multiscaled images.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">):</span>
            <span class="n">_img</span> <span class="o">=</span> <span class="n">_norm_dtype</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only set 3-D image.&quot;</span><span class="p">)</span>
            <span class="n">_img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">lazy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">dask_chunk</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">):</span>
                <span class="n">_img</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot set type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="si">}</span><span class="s2"> as an image.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-4</span>
            <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-4</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Uneven scale.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="n">_img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">_img</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nm2pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nm2pixel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">],</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">intp</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">nm2pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert nm float value into pixel value. Useful for conversion from</span>
<span class="sd">        coordinate to pixel position.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray or int</span>
<span class="sd">            Pixel position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new multiscaled image of given binsize.&quot;&quot;&quot;</span>
        <span class="c1"># iterate from the larger bin size</span>
        <span class="k">for</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_img</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">binsize</span> <span class="o">==</span> <span class="n">_b</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Binsize </span><span class="si">{</span><span class="n">binsize</span><span class="si">}</span><span class="s2"> already exists in multiscale images. &quot;</span>
                    <span class="s2">&quot;Skip binning process.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">_img</span>
            <span class="k">if</span> <span class="n">binsize</span> <span class="o">%</span> <span class="n">_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">imgb</span> <span class="o">=</span> <span class="n">_img</span><span class="o">.</span><span class="n">binning</span><span class="p">(</span><span class="n">binsize</span> <span class="o">//</span> <span class="n">_b</span><span class="p">,</span> <span class="n">check_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">binning</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">check_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">compute</span><span class="p">:</span>
                <span class="n">imgb</span> <span class="o">=</span> <span class="n">imgb</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">binsize</span><span class="p">,</span> <span class="n">imgb</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">imgb</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">add</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get multiscaled image of given binsize.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_img</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_b</span> <span class="o">==</span> <span class="n">binsize</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_img</span>
        <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiscale = </span><span class="si">{</span><span class="n">binsize</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_multiscale_or_original</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get multiscaled image of given binsize but use original one if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">binsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">multiscale_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get lateral translation of binned image in nm.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">binsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert tomogram intensities **in-place**.&quot;&quot;&quot;</span>
        <span class="n">img_inv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">img_inv</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_image</span><span class="p">(</span><span class="n">img_inv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_inverted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_b</span><span class="p">,</span> <span class="n">_img</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_b</span><span class="p">,</span> <span class="o">-</span><span class="n">_img</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_subtomogram_loader</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mole</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span>
        <span class="n">output_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubtomogramLoader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a subtomogram loader from molecules.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">acryo</span><span class="w"> </span><span class="kn">import</span> <span class="n">SubtomogramLoader</span>

        <span class="k">if</span> <span class="n">binsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">])</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">output_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;output_shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">SubtomogramLoader</span><span class="p">(</span>
            <span class="n">img</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">mole</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">image</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Tomogram image data.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.is_dummy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_dummy</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>True if this tomogram object does not have a real image.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.is_inverted" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_inverted</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>True if this image is inverted</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metadata</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Metadata relevant to the tomogram.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.multiscaled" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">multiscaled</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Get all multi-scale factor and the corresponding multiscaled images.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.scale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Scale of the tomogram.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.source" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">source</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Path to the source file.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.tilt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tilt</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Tilt model as a dictionary.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.tomogram.Tomogram.tilt_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tilt_model</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Tilt model of the tomogram.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.__hash__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__hash__</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Use unsafe hash.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use unsafe hash.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram._get_multiscale_or_original" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_multiscale_or_original</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get multiscaled image of given binsize but use original one if needed.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_multiscale_or_original</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get multiscaled image of given binsize but use original one if needed.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">binsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.add_multiscale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Add new multiscaled image of given binsize.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add new multiscaled image of given binsize.&quot;&quot;&quot;</span>
    <span class="c1"># iterate from the larger bin size</span>
    <span class="k">for</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_img</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">binsize</span> <span class="o">==</span> <span class="n">_b</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Binsize </span><span class="si">{</span><span class="n">binsize</span><span class="si">}</span><span class="s2"> already exists in multiscale images. &quot;</span>
                <span class="s2">&quot;Skip binning process.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">_img</span>
        <span class="k">if</span> <span class="n">binsize</span> <span class="o">%</span> <span class="n">_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">imgb</span> <span class="o">=</span> <span class="n">_img</span><span class="o">.</span><span class="n">binning</span><span class="p">(</span><span class="n">binsize</span> <span class="o">//</span> <span class="n">_b</span><span class="p">,</span> <span class="n">check_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">binning</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">check_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgb</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">compute</span><span class="p">:</span>
            <span class="n">imgb</span> <span class="o">=</span> <span class="n">imgb</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">binsize</span><span class="p">,</span> <span class="n">imgb</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">imgb</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.dummy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dummy</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="p">(),</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Create a dummy tomogram.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dummy</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">tilt</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a dummy tomogram.&quot;&quot;&quot;</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">)</span>
    <span class="n">dummy</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
    <span class="n">tomo</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_image</span><span class="p">(</span>
        <span class="n">dummy</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
        <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tomo</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_dummy&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">tomo</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.from_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="p">(),</span> <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Construct a Tomogram object from a image array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>img</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size in nm. If not given, will try to read from image header.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tilt</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tilt model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Binsize to generate multiscale images. If not given, will not generate.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compute</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to compute the binned images.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Tomogram (cylindra.components.tomogram._tomo_base.Tomogram)" href="#cylindra.components.tomogram.Tomogram">Tomogram</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tomogram object with the image that has just been read and multi-scales.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_image</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="n">ip</span><span class="o">.</span><span class="n">LazyImgArray</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tilt</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a Tomogram object from a image array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array-like</span>
<span class="sd">        Input image.</span>
<span class="sd">    scale : float, optional</span>
<span class="sd">        Pixel size in nm. If not given, will try to read from image header.</span>
<span class="sd">    tilt : tuple of float, optional</span>
<span class="sd">        Tilt model.</span>
<span class="sd">    binsize : int or iterable of int, optional</span>
<span class="sd">        Binsize to generate multiscale images. If not given, will not generate.</span>
<span class="sd">    compute : bool, default True</span>
<span class="sd">        Whether to compute the binned images.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tomogram</span>
<span class="sd">        Tomogram object with the image that has just been read and multi-scales.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span>
            <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uneven scale: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_set_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span> <span class="o">:=</span> <span class="n">img</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="c1"># parse tilt model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tilt</span><span class="p">,</span> <span class="n">TiltSeriesModel</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tilt</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">match</span> <span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]:</span>
                <span class="k">case</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                    <span class="n">tilt</span> <span class="o">=</span> <span class="n">NoWedge</span><span class="p">()</span>
                <span class="k">case</span> <span class="s2">&quot;x&quot;</span> <span class="o">|</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">tilt</span> <span class="o">=</span> <span class="n">single_axis</span><span class="p">(</span><span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">],</span> <span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">])</span>
                <span class="k">case</span> <span class="s2">&quot;dual&quot;</span><span class="p">:</span>
                    <span class="n">tilt</span> <span class="o">=</span> <span class="n">dual_axis</span><span class="p">(</span><span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;yrange&quot;</span><span class="p">],</span> <span class="n">tilt</span><span class="p">[</span><span class="s2">&quot;xrange&quot;</span><span class="p">])</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Tilt model </span><span class="si">{</span><span class="n">tilt</span><span class="si">!r}</span><span class="s2"> not in a correct format.&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tilt</span> <span class="o">=</span> <span class="n">single_axis</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_model</span> <span class="o">=</span> <span class="n">tilt</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">binsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">binsize</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">binsize</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_multiscale</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.get_multiscale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get multiscaled image of given binsize.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_multiscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">add</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get multiscaled image of given binsize.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_img</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_b</span> <span class="o">==</span> <span class="n">binsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_img</span>
    <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiscale = </span><span class="si">{</span><span class="n">binsize</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.get_subtomogram_loader" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_subtomogram_loader</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Create a subtomogram loader from molecules.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_subtomogram_loader</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mole</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span>
    <span class="n">output_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubtomogramLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a subtomogram loader from molecules.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">acryo</span><span class="w"> </span><span class="kn">import</span> <span class="n">SubtomogramLoader</span>

    <span class="k">if</span> <span class="n">binsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">tr</span><span class="p">])</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multiscale</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
        <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">binsize</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">output_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;output_shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm2pixel</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">SubtomogramLoader</span><span class="p">(</span>
        <span class="n">img</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">mole</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.imread" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="p">(),</span> <span class="n">eager</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Read a image as a dask array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="path">path</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the image file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size in nm. If not given, will try to read from image header.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tilt</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tilt model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>binsize</code>
            </td>
            <td>
                  <code>int or iterable of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Binsize to generate multiscale images. If not given, will not generate.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eager</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to read the image lazily. If True, the entire image will be read
into the memory.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Tomogram (cylindra.components.tomogram._tomo_base.Tomogram)" href="#cylindra.components.tomogram.Tomogram">Tomogram</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tomogram object with the image that has just been read and multi-scales.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">imread</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tilt</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">eager</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a image as a dask array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : path-like</span>
<span class="sd">        Path to the image file.</span>
<span class="sd">    scale : float, optional</span>
<span class="sd">        Pixel size in nm. If not given, will try to read from image header.</span>
<span class="sd">    tilt : tuple of float, optional</span>
<span class="sd">        Tilt model.</span>
<span class="sd">    binsize : int or iterable of int, optional</span>
<span class="sd">        Binsize to generate multiscale images. If not given, will not generate.</span>
<span class="sd">    eager : bool, default False</span>
<span class="sd">        Whether to read the image lazily. If True, the entire image will be read</span>
<span class="sd">        into the memory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tomogram</span>
<span class="sd">        Tomogram object with the image that has just been read and multi-scales.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">dask_chunk</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">lazy</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eager</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_image</span><span class="p">(</span>
        <span class="n">_norm_dtype</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span>
        <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.invert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invert</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Invert tomogram intensities <strong>in-place</strong>.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Invert tomogram intensities **in-place**.&quot;&quot;&quot;</span>
    <span class="n">img_inv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span>
    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">img_inv</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_image</span><span class="p">(</span><span class="n">img_inv</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_inverted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_b</span><span class="p">,</span> <span class="n">_img</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiscaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_b</span><span class="p">,</span> <span class="o">-</span><span class="n">_img</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.multiscale_translation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">multiscale_translation</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get lateral translation of binned image in nm.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">multiscale_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nm</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get lateral translation of binned image in nm.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">binsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.nm2pixel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">nm2pixel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h5>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">nm2pixel</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">nm2pixel</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">],</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">intp</span><span class="p">]</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Convert nm float value into pixel value. Useful for conversion from
coordinate to pixel position.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel position.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">nm2pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert nm float value into pixel value. Useful for conversion from</span>
<span class="sd">    coordinate to pixel position.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray or int</span>
<span class="sd">        Pixel position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.tomogram.Tomogram.with_cache_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">with_cache_info</span><span class="p">(</span><span class="n">orig_path</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Set cache path.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/tomogram/_tomo_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_cache_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set cache path.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;orig_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">orig_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cache_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="cylindra.components._base"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="cylindra.components._base.BaseComponent" class="doc doc-heading">
            <code>BaseComponent</code>


</h4>


    <div class="doc doc-contents ">


        <p>Base class for all tomographic components.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/_base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseComponent</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all tomographic components.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">js</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a component from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a component to a dictionary.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rescale the component by the factor.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the model in a json format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : str</span>
<span class="sd">            Path to the file.</span>
<span class="sd">        cls : JSONEncoder, optional</span>
<span class="sd">            Custom JSON encoder, by default None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dump</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump the project to a file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a spline model from a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : str</span>
<span class="sd">            Path to json file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BaseComponent</span>
<span class="sd">            Object constructed from the json file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="cylindra.components._base.BaseComponent._dump" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_dump</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Dump the project to a file.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dump the project to a file.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components._base.BaseComponent.from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dict</span><span class="p">(</span><span class="n">js</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Construct a component from a dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">js</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a component from a dictionary.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components._base.BaseComponent.from_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_json</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Construct a spline model from a json file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to json file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="BaseComponent (cylindra.components._base.BaseComponent)" href="#cylindra.components._base.BaseComponent">BaseComponent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object constructed from the json file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a spline model from a json file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Path to json file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    BaseComponent</span>
<span class="sd">        Object constructed from the json file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components._base.BaseComponent.rescale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rescale</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Rescale the component by the factor.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rescale the component by the factor.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components._base.BaseComponent.to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dict</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Convert a component to a dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a component to a dictionary.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components._base.BaseComponent.to_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_json</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Save the model in a json format.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cls</code>
            </td>
            <td>
                  <code><span title="JSONEncoder">JSONEncoder</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom JSON encoder, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/_base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the model in a json format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Path to the file.</span>
<span class="sd">    cls : JSONEncoder, optional</span>
<span class="sd">        Custom JSON encoder, by default None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dump</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="cylindra.components.landscape"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="cylindra.components.landscape.AnnealingResult" class="doc doc-heading">
            <code>AnnealingResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Dataclass for storing the annealing results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>energies</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>History of energies of the annealing process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size used in the annealing process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_const</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time constant used for cooling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indices</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The optimized indices of the molecules.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>niter</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of iterations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optimization state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AnnealingResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataclass for storing the annealing results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energies : np.ndarray</span>
<span class="sd">        History of energies of the annealing process.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size used in the annealing process.</span>
<span class="sd">    time_const : float</span>
<span class="sd">        Time constant used for cooling.</span>
<span class="sd">    indices : np.ndarray</span>
<span class="sd">        The optimized indices of the molecules.</span>
<span class="sd">    niter : int</span>
<span class="sd">        Number of iterations.</span>
<span class="sd">    state : str</span>
<span class="sd">        Optimization state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">energies</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">time_const</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>
    <span class="n">niter</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.landscape.Landscape" class="doc doc-heading">
            <code>Landscape</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Energy landscape array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>energies</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float32">float32</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>4D array of energy values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>molecules</code>
            </td>
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>argmax</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.int32">int32</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Argmax indices to track which rotation resulted in the best alignment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quaternions</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float32">float32</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Quaternions used for template rotation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale_factor</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale factor to convert from pixels to nanometers (upsampling considered).
<code>scale / upsample_factor</code> will be passed to this parameter from the GUI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Landscape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Energy landscape array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energies : NDArray[np.float32]</span>
<span class="sd">        4D array of energy values.</span>
<span class="sd">    molecules : Molecules</span>
<span class="sd">        Molecules object.</span>
<span class="sd">    argmax : NDArray[np.int32], optional</span>
<span class="sd">        Argmax indices to track which rotation resulted in the best alignment.</span>
<span class="sd">    quaternions : NDArray[np.float32]</span>
<span class="sd">        Quaternions used for template rotation.</span>
<span class="sd">    scale_factor : float</span>
<span class="sd">        Scale factor to convert from pixels to nanometers (upsampling considered).</span>
<span class="sd">        ``scale / upsample_factor`` will be passed to this parameter from the GUI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">energies</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="n">molecules</span><span class="p">:</span> <span class="n">Molecules</span>
    <span class="n">argmax</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">quaternions</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="n">scale_factor</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">slice</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">SupportsIndex</span><span class="p">]</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subset of the landscape.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type of key: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">argmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Landscape</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">argmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">eng_repr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s2"> array&gt;&quot;</span>
        <span class="n">mole_repr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> molecules&gt;&quot;</span>
        <span class="n">argmax_repr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s2"> array&gt;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Landscape(energies=</span><span class="si">{</span><span class="n">eng_repr</span><span class="si">}</span><span class="s2">, molecules=</span><span class="si">{</span><span class="n">mole_repr</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;argmax=</span><span class="si">{</span><span class="n">argmax_repr</span><span class="si">}</span><span class="s2">, quaternion=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="si">!r}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;scale_factor=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shift from the corner (0, 0, 0) to the center.&quot;&quot;&quot;</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">shift</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offset_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Offset in nm.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_loader</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">loader</span><span class="p">:</span> <span class="n">LoaderBase</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="n">TemplateInputType</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">MaskInputType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
        <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">alignment_model</span><span class="p">:</span> <span class="n">alignment</span><span class="o">.</span><span class="n">TomographyInput</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">ZNCCAlignment</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a landscape from a loader object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loader : LoaderBase</span>
<span class="sd">            Any loader object from ``acryo``.</span>
<span class="sd">        template : template input type</span>
<span class="sd">            Template image or a list of template images to be used.</span>
<span class="sd">        mask : mask input type, optional</span>
<span class="sd">            Mask image to be used, by default None</span>
<span class="sd">        max_shifts : (float, float, float), optional</span>
<span class="sd">            Maximum shifts in nm, in (Z, Y, X) order.</span>
<span class="sd">        upsample_factor : int</span>
<span class="sd">            Upsampling factor for landscape construction.</span>
<span class="sd">        alignment_model : alignment model object</span>
<span class="sd">            Alignment model to be used to evaluate correlation score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="n">multi</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">template</span><span class="p">):</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="n">multi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">multi</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type of template: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">score_dsk</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">construct_landscape</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span>
            <span class="n">upsample</span><span class="o">=</span><span class="n">upsample_factor</span><span class="p">,</span>
            <span class="n">alignment_model</span><span class="o">=</span><span class="n">alignment_model</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">score</span><span class="p">,</span> <span class="n">argmax</span> <span class="o">=</span> <span class="n">_calc_landscape</span><span class="p">(</span>
            <span class="n">alignment_model</span><span class="p">,</span> <span class="n">score_dsk</span><span class="p">,</span> <span class="n">multi_templates</span><span class="o">=</span><span class="n">multi</span>
        <span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">to_drop</span><span class="p">:</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">drop_features</span><span class="p">(</span><span class="o">*</span><span class="n">to_drop</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">energies</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
            <span class="n">molecules</span><span class="o">=</span><span class="n">mole</span><span class="p">,</span>
            <span class="n">argmax</span><span class="o">=</span><span class="n">argmax</span><span class="p">,</span>
            <span class="n">quaternions</span><span class="o">=</span><span class="n">alignment_model</span><span class="o">.</span><span class="n">quaternions</span><span class="p">,</span>
            <span class="n">scale_factor</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">upsample_factor</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transform_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">molecules</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">],</span>
        <span class="n">detect_peak</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the input molecules based on the landscape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecules : Molecules</span>
<span class="sd">            Molecules object to be transformed.</span>
<span class="sd">        indices : integer array</span>
<span class="sd">            Indices in the landscape to be used for transformation.</span>
<span class="sd">        detect_peak : bool, default False</span>
<span class="sd">            If True, landscape will be sub-sampled to detect the peak in higher</span>
<span class="sd">            precision. This should be false for constrained alignment, as the detected</span>
<span class="sd">            peak usually does not represent the optimal result.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecules</span>
<span class="sd">            Transformed molecules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="n">indices_sub</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">nmole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">opt_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmole</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">nrepeat</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">detect_peak</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmole</span><span class="p">):</span>
            <span class="n">eng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">indices_sub</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">opt_energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_peak</span><span class="p">(</span><span class="n">eng</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nrepeat</span><span class="o">=</span><span class="n">nrepeat</span><span class="p">)</span>
        <span class="n">opt_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">opt_energy</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">((</span><span class="n">indices_sub</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">molecules</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
        <span class="n">shift_feat</span> <span class="o">=</span> <span class="n">_as_n_series</span><span class="p">(</span><span class="s2">&quot;align-d</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nrots</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">quats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">ind</span><span class="p">)]</span> <span class="o">%</span> <span class="n">nrots</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rotator</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_quat</span><span class="p">(</span><span class="n">quats</span><span class="p">)</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
            <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">molecules_opt</span><span class="o">.</span><span class="n">rotate_by</span><span class="p">(</span><span class="n">rotator</span><span class="p">)</span>
            <span class="n">rotvec</span> <span class="o">=</span> <span class="n">rotator</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">rotvec_feat</span> <span class="o">=</span> <span class="n">_as_n_series</span><span class="p">(</span><span class="s2">&quot;align-d</span><span class="si">{}</span><span class="s2">rot&quot;</span><span class="p">,</span> <span class="n">rotvec</span><span class="p">)</span>
            <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">molecules_opt</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="o">*</span><span class="n">rotvec_feat</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">molecules_opt</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span>
            <span class="o">*</span><span class="n">shift_feat</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">opt_score</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_min_energy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Molecules</span><span class="p">,</span> <span class="n">MinEnergyResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimize energy for each local landscape independently.&quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]]()</span>
        <span class="n">engs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">eng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">eng</span><span class="p">),</span> <span class="n">shape</span><span class="p">)</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
            <span class="n">engs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eng</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">engs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">engs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">MinEnergyResult</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">engs</span><span class="p">)</span>

        <span class="n">mole_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">detect_peak</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mole_opt</span> <span class="o">=</span> <span class="n">_update_mole_pos</span><span class="p">(</span><span class="n">mole_opt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mole_opt</span><span class="p">,</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_viterbi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dist_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span> <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run Viterbi alignment.&quot;&quot;&quot;</span>
        <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_dist</span><span class="p">(</span><span class="n">dist_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">angle_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_max</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_viterbi_grid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ViterbiResult</span><span class="p">(</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">viterbi</span><span class="p">(</span><span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">,</span> <span class="n">angle_max</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_viterbi_along_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.28</span><span class="p">),</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">if</span> <span class="n">Mole</span><span class="o">.</span><span class="n">pf</span> <span class="ow">in</span> <span class="n">mole</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">npfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mole</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">npfs</span><span class="p">]</span>
            <span class="n">viterbi_tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span><span class="o">.</span><span class="n">run_viterbi</span><span class="p">)(</span><span class="n">range_long</span><span class="p">,</span> <span class="n">angle_max</span><span class="p">)</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">slices</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
            <span class="n">viterbi_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_viterbi</span><span class="p">)(</span><span class="n">range_long</span><span class="p">,</span> <span class="n">angle_max</span><span class="p">)]</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Viterbi alignment&quot;</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  tasks: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">viterbi_tasks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vit_out</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">viterbi_tasks</span><span class="p">)</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">max_shifts_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vit_out</span><span class="p">):</span>
            <span class="n">inds</span><span class="p">[</span><span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_check_viterbi_shift</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">max_shifts_px</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">molecules_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">_update_mole_pos</span><span class="p">(</span><span class="n">molecules_opt</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">molecules_opt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_viterbi_fixed_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">first</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
        <span class="n">range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.28</span><span class="p">),</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run Viterbi alignment with a fixed start edge.&quot;&quot;&quot;</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_dist</span><span class="p">(</span><span class="n">range_long</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">angle_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_max</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_viterbi_grid</span><span class="p">()</span>
        <span class="n">mole0</span> <span class="o">=</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotator</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_nm</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">mole0</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ViterbiResult</span><span class="p">(</span>
            <span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">viterbi_fixed_start</span><span class="p">(</span>
                <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">,</span> <span class="n">first</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">angle_max</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">max_shifts_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">_check_viterbi_shift</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">max_shifts_px</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">molecules_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">molecules_opt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prep_annealing_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">_ANN</span><span class="p">],</span>
        <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span>
        <span class="n">distance_range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">distance_range_lat</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cooling_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reject_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ANN</span><span class="p">:</span>
        <span class="n">cyl</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">cylinder_model</span><span class="p">()</span>
        <span class="n">_nrise</span><span class="p">,</span> <span class="n">_npf</span> <span class="o">=</span> <span class="n">cyl</span><span class="o">.</span><span class="n">nrise</span><span class="p">,</span> <span class="n">cyl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">molecules</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_nm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">angle_max</span> <span class="o">=</span> <span class="mf">90.0</span>

        <span class="n">time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_args</span><span class="p">(</span>
            <span class="n">temperature_time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span>
        <span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">molecules</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">ind</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ind</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">construct_graph</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">npf</span><span class="o">=</span><span class="n">_npf</span><span class="p">,</span> <span class="n">nrise</span><span class="o">=</span><span class="n">_nrise</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_graph_coordinates</span><span class="p">(</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">mole</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">zvec</span><span class="o">=</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">yvec</span><span class="o">=</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">xvec</span><span class="o">=</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_energy_landscape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_reservoir</span><span class="p">(</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">time_constant</span><span class="o">=</span><span class="n">time_const</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_box_potential</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_distance_range_long</span><span class="p">(</span><span class="n">distance_range_long</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_distance_range_lat</span><span class="p">(</span><span class="n">distance_range_lat</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_max</span><span class="p">)),</span>
                <span class="n">cooling_rate</span><span class="o">=</span><span class="n">cooling_rate</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_reject_limit</span><span class="p">(</span><span class="n">reject_limit</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filamentous_annealing_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">distance_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cooling_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reject_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FilamentousAnnealingModel</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cylindra._cylindra_ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">FilamentousAnnealingModel</span>

        <span class="n">molecules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">if</span> <span class="n">molecules</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least 3 molecules are required for RFA.&quot;</span><span class="p">)</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">molecules</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_nm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">angle_max</span> <span class="o">=</span> <span class="mf">90.0</span>

        <span class="n">time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_args</span><span class="p">(</span>
            <span class="n">temperature_time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">FilamentousAnnealingModel</span><span class="p">()</span><span class="o">.</span><span class="n">construct_graph</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_graph_coordinates</span><span class="p">(</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">mole</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">zvec</span><span class="o">=</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">yvec</span><span class="o">=</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">xvec</span><span class="o">=</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_energy_landscape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_reservoir</span><span class="p">(</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">time_constant</span><span class="o">=</span><span class="n">time_const</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_box_potential</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_distance_range_long</span><span class="p">(</span><span class="n">distance_range</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_max</span><span class="p">)),</span>
                <span class="n">cooling_rate</span><span class="o">=</span><span class="n">cooling_rate</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_reject_limit</span><span class="p">(</span><span class="n">reject_limit</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cylindric_annealing_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span>
        <span class="n">distance_range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">distance_range_lat</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cooling_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reject_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylindricAnnealingModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an annealing model using the landscape.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cylindra._cylindra_ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">CylindricAnnealingModel</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_annealing_model</span><span class="p">(</span>
            <span class="n">CylindricAnnealingModel</span><span class="p">,</span>
            <span class="n">spl</span><span class="p">,</span> <span class="n">distance_range_long</span><span class="p">,</span> <span class="n">distance_range_lat</span><span class="p">,</span> <span class="n">angle_max</span><span class="p">,</span>
            <span class="n">temperature_time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># fmt: skip</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_annealing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span>
        <span class="n">distance_range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">distance_range_lat</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cooling_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reject_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">random_seeds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AnnealingResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run simulated mesh annealing.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">angle_max</span> <span class="o">=</span> <span class="mf">90.0</span>
        <span class="n">random_seeds</span> <span class="o">=</span> <span class="n">_normalize_random_seeds</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span>
        <span class="n">annealing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylindric_annealing_model</span><span class="p">(</span>
            <span class="n">spl</span><span class="p">,</span>
            <span class="n">distance_range_long</span><span class="o">=</span><span class="n">distance_range_long</span><span class="p">,</span>
            <span class="n">distance_range_lat</span><span class="o">=</span><span class="n">distance_range_lat</span><span class="p">,</span>
            <span class="n">angle_max</span><span class="o">=</span><span class="n">angle_max</span><span class="p">,</span>
            <span class="n">temperature_time_const</span><span class="o">=</span><span class="n">temperature_time_const</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">cooling_rate</span><span class="o">=</span><span class="n">cooling_rate</span><span class="p">,</span>
            <span class="n">reject_limit</span><span class="o">=</span><span class="n">reject_limit</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">_to_batch_size</span><span class="p">(</span><span class="n">annealing</span><span class="o">.</span><span class="n">time_constant</span><span class="p">())</span>
        <span class="n">temp0</span> <span class="o">=</span> <span class="n">annealing</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running annealing&quot;</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_run_annealing</span><span class="p">(</span><span class="n">annealing</span><span class="o">.</span><span class="n">with_seed</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">temp0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">random_seeds</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_annealing_along_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span>
        <span class="n">range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">range_lat</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">random_seeds</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_annealing</span><span class="p">(</span>
            <span class="n">spl</span><span class="p">,</span>
            <span class="n">range_long</span><span class="p">,</span>
            <span class="n">range_lat</span><span class="p">,</span>
            <span class="n">angle_max</span><span class="p">,</span>
            <span class="n">temperature_time_const</span><span class="o">=</span><span class="n">temperature_time_const</span><span class="p">,</span>
            <span class="n">random_seeds</span><span class="o">=</span><span class="n">random_seeds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to optimize for all trials. You may check the distance range.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;converged&quot;</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Optimization did not converge for any trial.&quot;</span><span class="p">)</span>

        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Iteration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">niter</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
                <span class="s2">&quot;Score&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.5g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
                <span class="s2">&quot;State&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">state</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mole_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">mole_opt</span> <span class="o">=</span> <span class="n">_update_mole_pos</span><span class="p">(</span><span class="n">mole_opt</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mole_opt</span><span class="p">,</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_filamentous_annealing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">random_seeds</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Molecules</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">AnnealingResult</span><span class="p">]]:</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
        <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">angle_max</span> <span class="o">=</span> <span class="mf">90.0</span>
        <span class="n">random_seeds</span> <span class="o">=</span> <span class="n">_normalize_random_seeds</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span>
        <span class="n">annealing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filamentous_annealing_model</span><span class="p">(</span>
            <span class="n">distance_range</span><span class="o">=</span><span class="nb">range</span><span class="p">,</span>
            <span class="n">angle_max</span><span class="o">=</span><span class="n">angle_max</span><span class="p">,</span>
            <span class="n">temperature_time_const</span><span class="o">=</span><span class="n">temperature_time_const</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">_to_batch_size</span><span class="p">(</span><span class="n">annealing</span><span class="o">.</span><span class="n">time_constant</span><span class="p">())</span>
        <span class="n">temp0</span> <span class="o">=</span> <span class="n">annealing</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running annealing&quot;</span><span class="p">)</span>
        <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_run_annealing</span><span class="p">(</span><span class="n">annealing</span><span class="o">.</span><span class="n">with_seed</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">temp0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">random_seeds</span>
        <span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to optimize for all trials. You may check the distance range.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;converged&quot;</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="n">_Logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Optimization did not converge for any trial.&quot;</span><span class="p">)</span>

        <span class="n">_Logger</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Iteration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">niter</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
                <span class="s2">&quot;Score&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.5g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
                <span class="s2">&quot;State&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">state</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mole_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mole_opt</span><span class="p">,</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a landscape with normalized mean energy.&quot;&quot;&quot;</span>
        <span class="n">each_mean</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">all_mean</span> <span class="o">=</span> <span class="n">each_mean</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sd</span><span class="p">:</span>
            <span class="n">each_sd</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">all_sd</span> <span class="o">=</span> <span class="n">each_sd</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">-</span> <span class="n">each_mean</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
            <span class="n">new_array</span> <span class="o">=</span> <span class="n">dif</span> <span class="o">*</span> <span class="n">all_sd</span> <span class="o">/</span> <span class="n">each_sd</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">+</span> <span class="n">all_mean</span> <span class="o">-</span> <span class="n">each_mean</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_energies</span><span class="p">(</span><span class="n">new_array</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clip_energies</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">low</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">low</span><span class="p">)</span> <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="k">if</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">high</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_energies</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">replace_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">energies</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The dtype of energies must be float32, got </span><span class="si">{</span><span class="n">energies</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">energies</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The shape of energies must be </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, got &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Landscape</span><span class="p">(</span>
            <span class="n">energies</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_surface</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_min</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurfaceData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a isosurface data from the landscape&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">show_min</span><span class="p">:</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span>
            <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="n">level</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="n">step_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">resolution</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">center</span> <span class="o">*</span> <span class="n">spacing</span>
        <span class="n">n_verts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">Delayed</span><span class="p">[</span><span class="n">SurfaceData</span><span class="p">]]()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">arr</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delayed_isosurface</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">))</span>
        <span class="n">surfs</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="n">surfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="n">SurfaceData</span><span class="p">(</span>
                <span class="n">mole</span><span class="o">.</span><span class="n">rotator</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">surf</span><span class="o">.</span><span class="n">vertices</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">mole</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">surf</span><span class="o">.</span><span class="n">faces</span> <span class="o">+</span> <span class="n">n_verts</span><span class="p">,</span>
                <span class="n">surf</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">surfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>  <span class="c1"># update</span>
            <span class="n">n_verts</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">surf</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">vertices</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">faces</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SurfaceData</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="c1">### IO ###</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a landscape from a directory.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must be a directory, got </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;landscape.tif&quot;</span><span class="p">)</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="n">Molecules</span><span class="o">.</span><span class="n">from_parquet</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;molecules.parquet&quot;</span><span class="p">)</span>
        <span class="n">argmax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">:=</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;argmax.parquet&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">argmax</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">quaternions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;quaternions.txt&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">energies</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">molecules</span><span class="p">,</span> <span class="n">argmax</span><span class="p">,</span> <span class="n">quaternions</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the landscape to a directory.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must be a directory, got </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;tzyx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span>
            <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span>
        <span class="p">)</span>
        <span class="n">arr</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;landscape.tif&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;molecules.parquet&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;argmax&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">})</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span>
                <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;argmax.parquet&quot;</span><span class="p">,</span> <span class="n">compression_level</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;quaternions.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_distance_range_long</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nm</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">CylindricAnnealingModel</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]:</span>
        <span class="n">rng0</span><span class="p">,</span> <span class="n">rng1</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">long_dist_arr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">longitudinal_distances</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rng0</span> <span class="o">=</span> <span class="n">_norm_distance</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span> <span class="n">long_dist_arr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rng1</span> <span class="o">=</span> <span class="n">_norm_distance</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="n">long_dist_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rng0</span> <span class="o">&lt;</span> <span class="n">rng1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lower is larger than the upper: </span><span class="si">{</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span><span class="w"> </span><span class="n">rng1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rng0</span><span class="p">,</span> <span class="n">rng1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_distance_range_lat</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nm</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">CylindricAnnealingModel</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]:</span>
        <span class="n">rng0</span><span class="p">,</span> <span class="n">rng1</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lat_dist_arr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">lateral_distances</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rng0</span> <span class="o">=</span> <span class="n">_norm_distance</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span> <span class="n">lat_dist_arr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rng1</span> <span class="o">=</span> <span class="n">_norm_distance</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="n">lat_dist_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rng0</span> <span class="o">&lt;</span> <span class="n">rng1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lower is larger than the upper: </span><span class="si">{</span><span class="p">(</span><span class="n">rng0</span><span class="p">,</span><span class="w"> </span><span class="n">rng1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rng0</span><span class="p">,</span> <span class="n">rng1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_args</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temperature_time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span>
    <span class="p">):</span>
        <span class="n">nmole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">time_const</span> <span class="o">=</span> <span class="n">nmole</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">temperature_time_const</span>
        <span class="n">_energy_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">_energy_std</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">cooling_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cooling_rate</span> <span class="o">=</span> <span class="n">_energy_std</span> <span class="o">/</span> <span class="n">time_const</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">if</span> <span class="n">reject_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reject_limit</span> <span class="o">=</span> <span class="n">nmole</span> <span class="o">*</span> <span class="mi">50</span>
        <span class="k">return</span> <span class="n">time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]:</span>
        <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span> <span class="o">=</span> <span class="n">dist_range</span>
        <span class="c1"># normalize distance limits</span>
        <span class="n">dist_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dist_min</span> <span class="o">=</span> <span class="n">_norm_distance</span><span class="p">(</span><span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_arr</span><span class="p">)</span>
        <span class="n">dist_max</span> <span class="o">=</span> <span class="n">_norm_distance</span><span class="p">(</span><span class="n">dist_max</span><span class="p">,</span> <span class="n">dist_arr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist_min</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">dist_max</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prep_viterbi_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cylindra._cylindra_ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">ViterbiGrid</span>

        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_nm</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">pos</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">zvec</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">yvec</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">xvec</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ViterbiGrid</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">zvec</span><span class="p">,</span> <span class="n">yvec</span><span class="p">,</span> <span class="n">xvec</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.landscape.Landscape.offset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">offset</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Shift from the corner (0, 0, 0) to the center.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="cylindra.components.landscape.Landscape.offset_nm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">offset_nm</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Offset in nm.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Subset of the landscape.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">slice</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">SupportsIndex</span><span class="p">]</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subset of the landscape.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type of key: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">argmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Landscape</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">argmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.create_surface" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_surface</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_min</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Create a isosurface data from the landscape</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_surface</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">nm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show_min</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurfaceData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a isosurface data from the landscape&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">show_min</span><span class="p">:</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span>
        <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="n">level</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">/</span> <span class="mi">4</span>

    <span class="n">step_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">resolution</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">center</span> <span class="o">*</span> <span class="n">spacing</span>
    <span class="n">n_verts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">Delayed</span><span class="p">[</span><span class="n">SurfaceData</span><span class="p">]]()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">arr</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delayed_isosurface</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">))</span>
    <span class="n">surfs</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">surfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">SurfaceData</span><span class="p">(</span>
            <span class="n">mole</span><span class="o">.</span><span class="n">rotator</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">surf</span><span class="o">.</span><span class="n">vertices</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">mole</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">surf</span><span class="o">.</span><span class="n">faces</span> <span class="o">+</span> <span class="n">n_verts</span><span class="p">,</span>
            <span class="n">surf</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">surfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>  <span class="c1"># update</span>
        <span class="n">n_verts</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">surf</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">vertices</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">faces</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SurfaceData</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.cylindric_annealing_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cylindric_annealing_model</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">distance_range_long</span><span class="p">,</span> <span class="n">distance_range_lat</span><span class="p">,</span> <span class="n">angle_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature_time_const</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reject_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get an annealing model using the landscape.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cylindric_annealing_model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span>
    <span class="n">distance_range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
    <span class="n">distance_range_lat</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
    <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cooling_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reject_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CylindricAnnealingModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an annealing model using the landscape.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cylindra._cylindra_ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">CylindricAnnealingModel</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_annealing_model</span><span class="p">(</span>
        <span class="n">CylindricAnnealingModel</span><span class="p">,</span>
        <span class="n">spl</span><span class="p">,</span> <span class="n">distance_range_long</span><span class="p">,</span> <span class="n">distance_range_lat</span><span class="p">,</span> <span class="n">angle_max</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">,</span> <span class="n">reject_limit</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># fmt: skip</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.from_dir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Load a landscape from a directory.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a landscape from a directory.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must be a directory, got </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;landscape.tif&quot;</span><span class="p">)</span>
    <span class="n">molecules</span> <span class="o">=</span> <span class="n">Molecules</span><span class="o">.</span><span class="n">from_parquet</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;molecules.parquet&quot;</span><span class="p">)</span>
    <span class="n">argmax</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">:=</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;argmax.parquet&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">argmax</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">quaternions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;quaternions.txt&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">energies</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">molecules</span><span class="p">,</span> <span class="n">argmax</span><span class="p">,</span> <span class="n">quaternions</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.from_loader" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_loader</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">upsample_factor</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alignment_model</span><span class="o">=</span><span class="n">alignment</span><span class="o">.</span><span class="n">ZNCCAlignment</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Construct a landscape from a loader object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>loader</code>
            </td>
            <td>
                  <code><span title="acryo.loader._base.LoaderBase">LoaderBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any loader object from <code>acryo</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>template</code>
            </td>
            <td>
                  <code>template input type</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template image or a list of template images to be used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code>mask input type</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mask image to be used, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_shifts</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum shifts in nm, in (Z, Y, X) order.</p>
              </div>
            </td>
            <td>
                  <code>(0.8, 0.8, 0.8)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>upsample_factor</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor for landscape construction.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alignment_model</code>
            </td>
            <td>
                  <code>alignment model object</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Alignment model to be used to evaluate correlation score.</p>
              </div>
            </td>
            <td>
                  <code><span title="acryo.alignment.ZNCCAlignment">ZNCCAlignment</span></code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_loader</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">loader</span><span class="p">:</span> <span class="n">LoaderBase</span><span class="p">,</span>
    <span class="n">template</span><span class="p">:</span> <span class="n">TemplateInputType</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">MaskInputType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">alignment_model</span><span class="p">:</span> <span class="n">alignment</span><span class="o">.</span><span class="n">TomographyInput</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">ZNCCAlignment</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a landscape from a loader object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loader : LoaderBase</span>
<span class="sd">        Any loader object from ``acryo``.</span>
<span class="sd">    template : template input type</span>
<span class="sd">        Template image or a list of template images to be used.</span>
<span class="sd">    mask : mask input type, optional</span>
<span class="sd">        Mask image to be used, by default None</span>
<span class="sd">    max_shifts : (float, float, float), optional</span>
<span class="sd">        Maximum shifts in nm, in (Z, Y, X) order.</span>
<span class="sd">    upsample_factor : int</span>
<span class="sd">        Upsampling factor for landscape construction.</span>
<span class="sd">    alignment_model : alignment model object</span>
<span class="sd">        Alignment model to be used to evaluate correlation score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">template</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type of template: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">score_dsk</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">construct_landscape</span><span class="p">(</span>
        <span class="n">template</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span>
        <span class="n">upsample</span><span class="o">=</span><span class="n">upsample_factor</span><span class="p">,</span>
        <span class="n">alignment_model</span><span class="o">=</span><span class="n">alignment_model</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">score</span><span class="p">,</span> <span class="n">argmax</span> <span class="o">=</span> <span class="n">_calc_landscape</span><span class="p">(</span>
        <span class="n">alignment_model</span><span class="p">,</span> <span class="n">score_dsk</span><span class="p">,</span> <span class="n">multi_templates</span><span class="o">=</span><span class="n">multi</span>
    <span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">Mole</span><span class="o">.</span><span class="n">nth</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">pf</span><span class="p">,</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">to_drop</span><span class="p">:</span>
        <span class="n">mole</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">drop_features</span><span class="p">(</span><span class="o">*</span><span class="n">to_drop</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">energies</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
        <span class="n">molecules</span><span class="o">=</span><span class="n">mole</span><span class="p">,</span>
        <span class="n">argmax</span><span class="o">=</span><span class="n">argmax</span><span class="p">,</span>
        <span class="n">quaternions</span><span class="o">=</span><span class="n">alignment_model</span><span class="o">.</span><span class="n">quaternions</span><span class="p">,</span>
        <span class="n">scale_factor</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">upsample_factor</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.normed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normed</span><span class="p">(</span><span class="n">sd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return a landscape with normalized mean energy.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">normed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Landscape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a landscape with normalized mean energy.&quot;&quot;&quot;</span>
    <span class="n">each_mean</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">all_mean</span> <span class="o">=</span> <span class="n">each_mean</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sd</span><span class="p">:</span>
        <span class="n">each_sd</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">all_sd</span> <span class="o">=</span> <span class="n">each_sd</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">-</span> <span class="n">each_mean</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
        <span class="n">new_array</span> <span class="o">=</span> <span class="n">dif</span> <span class="o">*</span> <span class="n">all_sd</span> <span class="o">/</span> <span class="n">each_sd</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_mean</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">+</span> <span class="n">all_mean</span> <span class="o">-</span> <span class="n">each_mean</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_energies</span><span class="p">(</span><span class="n">new_array</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.run_annealing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_annealing</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">distance_range_long</span><span class="p">,</span> <span class="n">distance_range_lat</span><span class="p">,</span> <span class="n">angle_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature_time_const</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reject_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_seeds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Run simulated mesh annealing.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_annealing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">,</span>
    <span class="n">distance_range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
    <span class="n">distance_range_lat</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span>
    <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature_time_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cooling_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reject_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">random_seeds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AnnealingResult</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run simulated mesh annealing.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angle_max</span> <span class="o">=</span> <span class="mf">90.0</span>
    <span class="n">random_seeds</span> <span class="o">=</span> <span class="n">_normalize_random_seeds</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span>
    <span class="n">annealing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cylindric_annealing_model</span><span class="p">(</span>
        <span class="n">spl</span><span class="p">,</span>
        <span class="n">distance_range_long</span><span class="o">=</span><span class="n">distance_range_long</span><span class="p">,</span>
        <span class="n">distance_range_lat</span><span class="o">=</span><span class="n">distance_range_lat</span><span class="p">,</span>
        <span class="n">angle_max</span><span class="o">=</span><span class="n">angle_max</span><span class="p">,</span>
        <span class="n">temperature_time_const</span><span class="o">=</span><span class="n">temperature_time_const</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">cooling_rate</span><span class="o">=</span><span class="n">cooling_rate</span><span class="p">,</span>
        <span class="n">reject_limit</span><span class="o">=</span><span class="n">reject_limit</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">_to_batch_size</span><span class="p">(</span><span class="n">annealing</span><span class="o">.</span><span class="n">time_constant</span><span class="p">())</span>
    <span class="n">temp0</span> <span class="o">=</span> <span class="n">annealing</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running annealing&quot;</span><span class="p">)</span>
    <span class="n">_Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_run_annealing</span><span class="p">(</span><span class="n">annealing</span><span class="o">.</span><span class="n">with_seed</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">temp0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">random_seeds</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.run_min_energy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_min_energy</span><span class="p">(</span><span class="n">spl</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Minimize energy for each local landscape independently.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_min_energy</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Molecules</span><span class="p">,</span> <span class="n">MinEnergyResult</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimize energy for each local landscape independently.&quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]]()</span>
    <span class="n">engs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">eng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">eng</span><span class="p">),</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">engs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eng</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">engs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">engs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">MinEnergyResult</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">engs</span><span class="p">)</span>

    <span class="n">mole_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">detect_peak</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">spl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mole_opt</span> <span class="o">=</span> <span class="n">_update_mole_pos</span><span class="p">(</span><span class="n">mole_opt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mole_opt</span><span class="p">,</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.run_viterbi" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_viterbi</span><span class="p">(</span><span class="n">dist_range</span><span class="p">,</span> <span class="n">angle_max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Run Viterbi alignment.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_viterbi</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">dist_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">],</span> <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run Viterbi alignment.&quot;&quot;&quot;</span>
    <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_dist</span><span class="p">(</span><span class="n">dist_range</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angle_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_max</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_viterbi_grid</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ViterbiResult</span><span class="p">(</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">viterbi</span><span class="p">(</span><span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">,</span> <span class="n">angle_max</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.run_viterbi_fixed_start" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_viterbi_fixed_start</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">range_long</span><span class="o">=</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.28</span><span class="p">),</span> <span class="n">angle_max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Run Viterbi alignment with a fixed start edge.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_viterbi_fixed_start</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">first</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
    <span class="n">range_long</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_DistLike</span><span class="p">,</span> <span class="n">_DistLike</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.28</span><span class="p">),</span>
    <span class="n">angle_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run Viterbi alignment with a fixed start edge.&quot;&quot;&quot;</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span>
    <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_dist</span><span class="p">(</span><span class="n">range_long</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angle_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angle_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_max</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_viterbi_grid</span><span class="p">()</span>
    <span class="n">mole0</span> <span class="o">=</span> <span class="n">Molecules</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">mole</span><span class="o">.</span><span class="n">rotator</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_nm</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">mole0</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ViterbiResult</span><span class="p">(</span>
        <span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">viterbi_fixed_start</span><span class="p">(</span>
            <span class="n">dist_min</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">,</span> <span class="n">first</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">angle_max</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">max_shifts_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">_check_viterbi_shift</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">max_shifts_px</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">molecules_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_molecules</span><span class="p">(</span><span class="n">mole</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">molecules_opt</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Save the landscape to a directory.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the landscape to a directory.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must be a directory, got </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;tzyx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span>
        <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span>
    <span class="p">)</span>
    <span class="n">arr</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;landscape.tif&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;molecules.parquet&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;argmax&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">})</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span>
            <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;argmax.parquet&quot;</span><span class="p">,</span> <span class="n">compression_level</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;quaternions.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="cylindra.components.landscape.Landscape.transform_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">transform_molecules</span><span class="p">(</span><span class="n">molecules</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">detect_peak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Transform the input molecules based on the landscape.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>molecules</code>
            </td>
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Molecules object to be transformed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indices</code>
            </td>
            <td>
                  <code>integer array</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices in the landscape to be used for transformation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detect_peak</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, landscape will be sub-sampled to detect the peak in higher
precision. This should be false for constrained alignment, as the detected
peak usually does not represent the optimal result.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="acryo.Molecules">Molecules</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transformed molecules.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">transform_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">molecules</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">],</span>
    <span class="n">detect_peak</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform the input molecules based on the landscape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    molecules : Molecules</span>
<span class="sd">        Molecules object to be transformed.</span>
<span class="sd">    indices : integer array</span>
<span class="sd">        Indices in the landscape to be used for transformation.</span>
<span class="sd">    detect_peak : bool, default False</span>
<span class="sd">        If True, landscape will be sub-sampled to detect the peak in higher</span>
<span class="sd">        precision. This should be false for constrained alignment, as the detected</span>
<span class="sd">        peak usually does not represent the optimal result.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Molecules</span>
<span class="sd">        Transformed molecules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
    <span class="n">indices_sub</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">nmole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">opt_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmole</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">nrepeat</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">detect_peak</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmole</span><span class="p">):</span>
        <span class="n">eng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">indices_sub</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">opt_energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_peak</span><span class="p">(</span><span class="n">eng</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nrepeat</span><span class="o">=</span><span class="n">nrepeat</span><span class="p">)</span>
    <span class="n">opt_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">opt_energy</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="p">((</span><span class="n">indices_sub</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">molecules</span><span class="o">.</span><span class="n">translate_internal</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="n">shift_feat</span> <span class="o">=</span> <span class="n">_as_n_series</span><span class="p">(</span><span class="s2">&quot;align-d</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nrots</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">quats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">ind</span><span class="p">)]</span> <span class="o">%</span> <span class="n">nrots</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rotator</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_quat</span><span class="p">(</span><span class="n">quats</span><span class="p">)</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
        <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">molecules_opt</span><span class="o">.</span><span class="n">rotate_by</span><span class="p">(</span><span class="n">rotator</span><span class="p">)</span>
        <span class="n">rotvec</span> <span class="o">=</span> <span class="n">rotator</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">rotvec_feat</span> <span class="o">=</span> <span class="n">_as_n_series</span><span class="p">(</span><span class="s2">&quot;align-d</span><span class="si">{}</span><span class="s2">rot&quot;</span><span class="p">,</span> <span class="n">rotvec</span><span class="p">)</span>
        <span class="n">molecules_opt</span> <span class="o">=</span> <span class="n">molecules_opt</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="o">*</span><span class="n">rotvec_feat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">molecules_opt</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span>
        <span class="o">*</span><span class="n">shift_feat</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">opt_score</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.landscape.SurfaceData" class="doc doc-heading">
            <code>SurfaceData</code>


</h4>


    <div class="doc doc-contents ">


        <p>Tuple for storing isosurface data for landscapes.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SurfaceData</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tuple for storing isosurface data for landscapes.&quot;&quot;&quot;</span>

    <span class="n">vertices</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="n">faces</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.landscape.ViterbiResult" class="doc doc-heading">
            <code>ViterbiResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Dataclass for storing the Viterbi alignment results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>indices</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The optimized indices of the molecules.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>score</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The score of the optimal alignment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ViterbiResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataclass for storing the Viterbi alignment results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    indices : np.ndarray</span>
<span class="sd">        The optimized indices of the molecules.</span>
<span class="sd">    score : float</span>
<span class="sd">        The score of the optimal alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">indices</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>
    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="cylindra.components.landscape._update_mole_pos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_update_mole_pos</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Update the "position-nm" feature of molecules.</p>
<p>Feature "position-nm" is the coordinate of molecules along the source spline.
After alignment, this feature should be updated accordingly. This fucntion
will do this.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_update_mole_pos</span><span class="p">(</span><span class="n">new</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="n">Molecules</span><span class="p">,</span> <span class="n">spl</span><span class="p">:</span> <span class="n">CylSpline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Molecules</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the &quot;position-nm&quot; feature of molecules.</span>

<span class="sd">    Feature &quot;position-nm&quot; is the coordinate of molecules along the source spline.</span>
<span class="sd">    After alignment, this feature should be updated accordingly. This fucntion</span>
<span class="sd">    will do this.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Mole</span><span class="o">.</span><span class="n">position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new</span>
    <span class="n">_u</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">y_to_position</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">])</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_u</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># the tangent vector of the spline</span>
    <span class="n">vec_norm</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">new</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">old</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">*</span> <span class="n">vec_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">Mole</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="cylindra.components.landscape.delayed_isosurface" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delayed_isosurface</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create an isosurface from a 3D array using marching cubes algorithm.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/landscape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@delayed</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delayed_isosurface</span><span class="p">(</span>
    <span class="n">arr</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">spacing</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">step_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurfaceData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an isosurface from a 3D array using marching cubes algorithm.&quot;&quot;&quot;</span>
    <span class="n">arr_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span>
            <span class="n">arr_pad</span><span class="p">,</span>
            <span class="n">level</span><span class="p">,</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
            <span class="n">gradient_direction</span><span class="o">=</span><span class="s2">&quot;descent&quot;</span><span class="p">,</span>
            <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">verts</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spacing</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">step_size</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SurfaceData</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="cylindra.components.seam_search"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="cylindra.components.seam_search.CorrelationSeamSearcher" class="doc doc-heading">
            <code>CorrelationSeamSearcher</code>


</h4>


    <div class="doc doc-contents ">


        <p>Seam searcher based on correlation with the template.</p>







              <details class="quote">
                <summary>Source code in <code>cylindra/components/seam_search.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CorrelationSeamSearcher</span><span class="p">(</span><span class="n">SeamSearcher</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Seam searcher based on correlation with the template.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loader</span><span class="p">:</span> <span class="n">SubtomogramLoader</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">,</span>
        <span class="n">anti_template</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CorrelationSeamSearchResult</span><span class="p">:</span>
        <span class="n">corrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]()</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">masked_template</span> <span class="o">=</span> <span class="p">(</span><span class="n">template</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">lowpass_filter</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">)</span>
        <span class="n">has_anti_template</span> <span class="o">=</span> <span class="n">anti_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">output_shape</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">averaged_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_averages</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_anti_template</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">anti_template</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The shape of anti-template (</span><span class="si">{</span><span class="n">anti_template</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">) must be the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;same as the shape of template (</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="n">masked_anti_template</span> <span class="o">=</span> <span class="p">(</span><span class="n">anti_template</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">lowpass_filter</span><span class="p">(</span>
                <span class="n">cutoff</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span>
            <span class="p">)</span>
            <span class="n">anti_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">averaged_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masked_anti_template</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">anti_corrs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">averaged_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">avg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">averaged_images</span><span class="p">):</span>
            <span class="n">avg</span><span class="p">:</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span>
            <span class="n">masked_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">lowpass_filter</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span><span class="p">)</span>
            <span class="n">corrs</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">zncc</span><span class="p">(</span><span class="n">masked_avg</span><span class="p">,</span> <span class="n">masked_template</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_anti_template</span><span class="p">:</span>
                <span class="n">anti_corrs</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">zncc</span><span class="p">(</span><span class="n">masked_avg</span><span class="p">,</span> <span class="n">masked_anti_template</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_anti_template</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">corrs</span> <span class="o">-</span> <span class="n">anti_corrs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">corr1</span><span class="p">,</span> <span class="n">corr2</span> <span class="o">=</span> <span class="n">corrs</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">npf</span><span class="p">],</span> <span class="n">corrs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">npf</span> <span class="p">:]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">corrs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">score</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">npf</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr1</span> <span class="o">-</span> <span class="n">corr2</span>
            <span class="n">score</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">npf</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">corr2</span> <span class="o">-</span> <span class="n">corr1</span>

        <span class="k">return</span> <span class="n">CorrelationSeamSearchResult</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">averaged_images</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">anti_corrs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="cylindra.components.seam_search.SeamSearcher" class="doc doc-heading">
            <code>SeamSearcher</code>


</h4>


    <div class="doc doc-contents ">








              <details class="quote">
                <summary>Source code in <code>cylindra/components/seam_search.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SeamSearcher</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npf</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_npf</span> <span class="o">=</span> <span class="n">npf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">npf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_npf</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeamSearchResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for the seam position.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">label_with_seam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]]()</span>  <span class="c1"># list of boolean arrays</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">_id</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">npf</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npf</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">_id</span> <span class="o">-</span> <span class="n">pf</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">npf</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">res</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_averages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">:</span> <span class="n">SubtomogramLoader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ip</span><span class="o">.</span><span class="n">ImgArray</span><span class="p">:</span>
        <span class="c1"># prepare all the labels in advance</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_with_seam</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="c1"># here, dask_array is (N, Z, Y, X) array where dask_array[i] is i-th subtomogram.</span>
        <span class="n">dask_array</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">construct_dask</span><span class="p">()</span>
        <span class="n">averaged_images</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span>
            <span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dask_array</span><span class="p">[</span><span class="n">sl</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ip</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">averaged_images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;pzyx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span>
            <span class="n">zyx</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">scale</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="cylindra.components.seam_search.SeamSearcher.search" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">search</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Search for the seam position.</p>


            <details class="quote">
              <summary>Source code in <code>cylindra/components/seam_search.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeamSearchResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for the seam position.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: API Reference">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                API Reference
              </div>
            </div>
          </a>
        
        
          
          <a href="../core/" class="md-footer__link md-footer__link--next" aria-label="Next: cylindra.core">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                cylindra.core
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2023 - 2025 Hanjin Liu
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "navigation.sections", "navigation.indexes", "navigation.footer", "toc.follow", "search.suggest", "search.share"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>